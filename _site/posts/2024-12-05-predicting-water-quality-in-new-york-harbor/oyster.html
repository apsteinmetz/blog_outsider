<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.55">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Art Steinmetz">
<meta name="dcterms.date" content="2024-12-05">
<meta name="description" content="Using Tidymodels and data from the Billion Oyster Project">

<title>Predicting Water Quality in New York Harbor – Outsider Data Science</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark.min.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="../../site_libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-BVDKXJLKEL"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-BVDKXJLKEL', { 'anonymize_ip': true});
</script>
<link href="../../site_libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet">

<script src="../../site_libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>

<script src="../../site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>

<link href="../../site_libs/leaflet-1.3.1/leaflet.css" rel="stylesheet">

<script src="../../site_libs/leaflet-1.3.1/leaflet.js"></script>

<link href="../../site_libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet">

<script src="../../site_libs/proj4-2.6.2/proj4.min.js"></script>

<script src="../../site_libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>

<link href="../../site_libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet">

<script src="../../site_libs/leaflet-binding-2.2.2/leaflet.js"></script>



<link rel="stylesheet" href="../../styles.css">
<meta name="twitter:title" content="Predicting Water Quality in New York Harbor – Outsider Data Science">
<meta name="twitter:description" content="Using Tidymodels and data from the Billion Oyster Project">
<meta name="twitter:image" content="https://outsiderdata.netlify.app/posts/2024-12-05-predicting-water-quality-in-new-york-harbor/img/Oyster.jpg">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Outsider Data Science</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/asteinmetz/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/adababbage"> <i class="bi bi-twitter" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://fosstodon.org/@adababbage"> <i class="bi bi-mastodon" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/apsteinmetz"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../index.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../blogroll.html"> 
<span class="menu-text"><i class="fa-solid fa-blog" aria-label="blog"></i></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../demos.html"> 
<span class="menu-text">App Demos</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#motivation" id="toc-motivation" class="nav-link active" data-scroll-target="#motivation">Motivation</a></li>
  <li><a href="#oyster-farm-to-the-world" id="toc-oyster-farm-to-the-world" class="nav-link" data-scroll-target="#oyster-farm-to-the-world">Oyster Farm to the World</a></li>
  <li><a href="#data-cleaning" id="toc-data-cleaning" class="nav-link" data-scroll-target="#data-cleaning">Data Cleaning</a></li>
  <li><a href="#exploratory-data-analysis" id="toc-exploratory-data-analysis" class="nav-link" data-scroll-target="#exploratory-data-analysis">Exploratory Data Analysis</a></li>
  <li><a href="#lets-build-a-model" id="toc-lets-build-a-model" class="nav-link" data-scroll-target="#lets-build-a-model">Let’s Build a Model!</a></li>
  <li><a href="#is-the-model-any-good" id="toc-is-the-model-any-good" class="nav-link" data-scroll-target="#is-the-model-any-good">Is the Model Any Good?</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Predicting Water Quality in New York Harbor</h1>
</div>

<div>
  <div class="description">
    Using Tidymodels and data from the Billion Oyster Project
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Art Steinmetz </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">December 5, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="motivation" class="level2">
<h2 class="anchored" data-anchor-id="motivation">Motivation</h2>
<p>This is an exercise in using machine learning to predict the level of harmful bacteria in New York Harbor based on environmental factors like tidal conditions, rainfall and location. Among the reasons this is useful is understanding how to rebuild a marine life ecosystem in the harbor, where oysters were a keystone species. We use the R data science language, <a href="https://www.tidymodels.org/">Tidymodel</a> tools from Posit.co to build the model and public data provided by <a href="https://www.billionoysterproject.org/">The Billion Oyster Project</a> using volunteer water sampling.</p>
<p>The model shows some ability to predict “safe” and “unacceptable” bacterial concentrations but false predictions are quite high.</p>
</section>
<section id="oyster-farm-to-the-world" class="level2">
<h2 class="anchored" data-anchor-id="oyster-farm-to-the-world">Oyster Farm to the World</h2>
<p>New York Harbor is one of the world’s greatest natural harbors. Those of us who live in New York City today see it mainly as an obstacle that we travel over or under. In our more reflective moods we see the history of what was in the piers. We can easily imagine the enormous ship traffic the piers once supported. What we can’t see are the echoes of the vibrant ecosystem of marine life that once thrived beneath the surface. The harbor sustained a rich diversity of marine life that provided abundant sustenance for the indigenous people before the arrival of Europeans and later for the colonists and migrants who arrived in their millions.</p>
<p><img src="img/George_Schlegel_-_George_Degen_-_New_York_1873.jpg" class="img-fluid"></p>
<p>Oysters were the keystone species for this ecosystem. They were so abundant that they, as filter feeders, filtered the entire volume of the harbor every few days. They provided habitat for other marine life and helped to stabilize the shoreline. At one point fully a third of all the World’s oyster harvest came from New York Harbor. Pearl Street in Manhattan was the site of a giant oyster shell midden left by the Lenape people. The oyster was the food of rich and poor alike. Stories of the colorful characters in Gilded Age New York are replete with oyster orgies at Delmonico’s restaurant. Oysters were so important to the economy of the city that before it became “The Big Apple” it was called “The Big Oyster.”</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/delmonicos_1899.png" class="img-fluid figure-img"></p>
<figcaption>Delmonico’s 1899. Oysters Have Pride of Place.(25 cents, not dollars!)</figcaption>
</figure>
</div>
<p>Alas, by the late 19th century, the oyster beds were so depleted that the oyster industry collapsed. The risk of over-harvesting was recognized as early as 1715 when “An Act for Preserving of Oysters” was passed but the law was suspended in 1807 and harvesting became relentless. This was also the harbinger of the harbor’s decline as species up the food chain suffered in parallel. Pollution was the final blow. Industry along the Hudson River flushed toxins downstream and, in 1856, the <a href="https://www.nyc.gov/site/dep/water/combined-sewer-overflows.page">“Combined Sewer Outflow”</a> system was established. This combines storm water drainage with raw sewage sent to treatment plants. During heavy rain, the system overflows and raw sewage is pumped into the harbor. After the passage of the Clean Water Act in 1972 industrial pollution declined but, incredibly, the CSO remains and is the major source of pollutants around the city.</p>
<p>Today we understand the need to support keystone species as vital to an ecosystem. <a href="https://www.billionoysterproject.org/">The Billion Oyster Project (BOP)</a> is a non-profit organization whose mission is to restore oyster reefs to New York. They are doing this work in collaboration collaboration with schools, universities, and government agencies. I have been a supporter of their mission for several years now. Getting the public to understand the importance of clean water is an important part of this effort. The project has been using volunteers to collect water quality data from the harbor since 2014 and the data are available to the public in a <a href="https://docs.google.com/spreadsheets/d/1813b2nagaxZ80xRfyMZNNKySZOitro5Nt7W4E9WNQDA/edit?usp=sharing">water quality spreadsheet</a>.</p>
<p>Downloading the full spreadsheet is a bit slow and there is some cleaning involved so we’ll use data files we previously created. If you want to replicate this the code for downloading and processing the spreadsheet is below.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Click on the “► Code” buttons throughout this document to see the source code for the project.
</div>
</div>
<div class="callout-body-container callout-body">

</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(googlesheets4)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rvest)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(duckplyr)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(arrow)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(leaflet)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(htmltools)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gt)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co"># enterococci thresholds</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>SAFE <span class="ot">=</span> <span class="dv">34</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>CAUTION <span class="ot">=</span> <span class="dv">104</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get Water Quality Data from BOP ----------------------------------</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># no need for a google account to access this sheet</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>googlesheets4<span class="sc">::</span><span class="fu">gs4_deauth</span>()</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>wq_url <span class="ot">&lt;-</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"https://docs.google.com/spreadsheets/d/1813b2nagaxZ80xRfyMZNNKySZOitro5Nt7W4E9WNQDA/edit?usp=sharing"</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="co"># DOWNLOAD meta data worksheet</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>wq_meta <span class="ot">&lt;-</span> <span class="fu">gs4_get</span>(wq_url)</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="co"># take 400 rows of metadata to accomodate future growth in testing stations (up to 400 &lt;grin&gt;)</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="co"># assumes row 10 is column names, column A is site ID which is duplicated in column D</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>wq_meta_raw <span class="ot">&lt;-</span> <span class="fu">read_sheet</span>(wq_url,<span class="st">"Information"</span>,<span class="at">range =</span> <span class="st">"B10:BA400"</span>)</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Clean Meta Station Data ----------------------------------</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>wq_meta <span class="ot">&lt;-</span> wq_meta_raw <span class="sc">|&gt;</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># remove empty columns by selecting only columns where names starts with a letter</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">!</span><span class="fu">matches</span>(<span class="st">"^</span><span class="sc">\\</span><span class="st">."</span>)) <span class="sc">|&gt;</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>() <span class="sc">|&gt;</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="st">"site"</span> <span class="ot">=</span> <span class="dv">2</span>) <span class="sc">|&gt;</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># remove empty rows</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(site)) <span class="sc">|&gt;</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">site_id =</span> <span class="fu">as.factor</span>(site_id)) <span class="sc">|&gt;</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># why these come in as a list of 1 is beyond me and one value is NULL</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># this is some complicated dplyr-fu.</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">district_council_number =</span>  <span class="fu">as.factor</span>(<span class="fu">unlist</span>(<span class="fu">map</span>(</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>    district_council_number,  <span class="sc">~</span> <span class="fu">ifelse</span>(<span class="fu">is.null</span>(.x), <span class="cn">NA</span>, .x)</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>  )))) <span class="sc">|&gt;</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">harmonic_noaa_tide_stations =</span>  <span class="fu">as.factor</span>(<span class="fu">unlist</span>(</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">map</span>(harmonic_noaa_tide_stations,  <span class="sc">~</span> <span class="fu">ifelse</span>(<span class="fu">is.null</span>(.x), <span class="cn">NA</span>, .x))</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>  ))) <span class="sc">|&gt;</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># FIXED as of Aug 2024.  some longitudes are erroneously positive</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">longitude =</span> <span class="fu">if_else</span>(longitude <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="sc">-</span>longitude, longitude)) <span class="sc">|&gt;</span></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">currently_testing =</span> <span class="fu">as.logical</span>(<span class="fu">if_else</span>(<span class="fu">is.na</span>(currently_testing), <span class="dv">0</span>, <span class="dv">1</span>))) <span class="sc">|&gt;</span></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename_with</span>( <span class="sc">~</span> <span class="st">"nyc_dep_wrrf_or_sewershed"</span>, <span class="fu">starts_with</span>(<span class="st">"associated"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># make NA entries in character columns actual NA so there is only one kind of NA</span></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.character), \(x) <span class="fu">if_else</span>(x <span class="sc">==</span> <span class="st">"N/A"</span>, <span class="cn">NA</span>, x))) <span class="sc">|&gt;</span></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># some columns are NA because they are in NJ. Make "NJ" the value</span></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">district_council_number =</span> <span class="fu">if_else</span>(</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>      district_council_number <span class="sc">==</span> <span class="st">"N/A"</span>,</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>      <span class="st">"NJ"</span>,</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>      district_council_number</span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">nyc_dep_wrrf_or_sewershed =</span> <span class="fu">if_else</span>(</span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">is.na</span>(nyc_dep_wrrf_or_sewershed),</span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>    <span class="st">"NJ"</span>,</span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>    nyc_dep_wrrf_or_sewershed</span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">|&gt;</span></span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">nys_dec_water_body_classification =</span> <span class="fu">if_else</span>(</span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>      <span class="fu">is.na</span>(nys_dec_water_body_classification),</span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>      <span class="st">"NJ"</span>,</span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>      nys_dec_water_body_classification</span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a><span class="co"># save meta data as parquet file</span></span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a><span class="co"># arrow::write_parquet(wq_meta,here("data/wq_meta.parquet"))</span></span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a><span class="co"># DOWNLOAD water quality data worksheet ---------------------------------------------</span></span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a>wq_data_raw <span class="ot">&lt;-</span> <span class="fu">read_sheet</span>(wq_url,<span class="st">"Data"</span>)</span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a>data_names <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"site"</span>,<span class="st">"site_id"</span>,<span class="st">"date"</span>,<span class="st">"year"</span>,<span class="st">"month"</span>,<span class="st">"high_tide"</span>,<span class="st">"sample_time"</span>,<span class="st">"bacteria"</span>,</span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a>                <span class="st">"precip_t0"</span>,<span class="st">"precip_t1"</span>,<span class="st">"precip_t2"</span>,<span class="st">"precip_t3"</span>,<span class="st">"precip_t4"</span>,</span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a>                <span class="st">"precip_t5"</span>,<span class="st">"precip_t6"</span>,<span class="st">"notes"</span>)</span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a><span class="co"># get average sample time and use that for NA sample times</span></span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a>sample_time_avg <span class="ot">&lt;-</span> wq_data_raw<span class="sc">$</span><span class="st">`</span><span class="at">Sample Time</span><span class="st">`</span> <span class="sc">|&gt;</span></span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean</span>(<span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.POSIXct</span>()</span>
<span id="cb2-75"><a href="#cb2-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-76"><a href="#cb2-76" aria-hidden="true" tabindex="-1"></a><span class="co"># function to extract day of week from date</span></span>
<span id="cb2-77"><a href="#cb2-77" aria-hidden="true" tabindex="-1"></a>day_of_week <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb2-78"><a href="#cb2-78" aria-hidden="true" tabindex="-1"></a>  x <span class="sc">|&gt;</span></span>
<span id="cb2-79"><a href="#cb2-79" aria-hidden="true" tabindex="-1"></a>    lubridate<span class="sc">::</span><span class="fu">wday</span>(<span class="at">week_start =</span> <span class="dv">7</span>) <span class="sc">|&gt;</span></span>
<span id="cb2-80"><a href="#cb2-80" aria-hidden="true" tabindex="-1"></a>    <span class="fu">factor</span>(<span class="at">levels =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>,<span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Sun"</span>,<span class="st">"Mon"</span>,<span class="st">"Tue"</span>,<span class="st">"Wed"</span>,<span class="st">"Thu"</span>,<span class="st">"Fri"</span>,<span class="st">"Sat"</span>))</span>
<span id="cb2-81"><a href="#cb2-81" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-82"><a href="#cb2-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-83"><a href="#cb2-83" aria-hidden="true" tabindex="-1"></a><span class="co"># clean up data</span></span>
<span id="cb2-84"><a href="#cb2-84" aria-hidden="true" tabindex="-1"></a>wq_data <span class="ot">&lt;-</span> wq_data_raw <span class="sc">|&gt;</span></span>
<span id="cb2-85"><a href="#cb2-85" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_names</span>(data_names) <span class="sc">|&gt;</span></span>
<span id="cb2-86"><a href="#cb2-86" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">as_date</span>(date)) <span class="sc">|&gt;</span></span>
<span id="cb2-87"><a href="#cb2-87" aria-hidden="true" tabindex="-1"></a>  <span class="co"># change NA sample times to average of all sample times. Good idea?</span></span>
<span id="cb2-88"><a href="#cb2-88" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sample_time =</span> <span class="fu">if_else</span>(<span class="fu">is.na</span>(sample_time),sample_time_avg,sample_time)) <span class="sc">|&gt;</span></span>
<span id="cb2-89"><a href="#cb2-89" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sample_time =</span> hms<span class="sc">::</span><span class="fu">as_hms</span>(sample_time)) <span class="sc">|&gt;</span></span>
<span id="cb2-90"><a href="#cb2-90" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sample_day =</span> <span class="fu">day_of_week</span>(date),<span class="at">.before =</span> bacteria) <span class="sc">|&gt;</span></span>
<span id="cb2-91"><a href="#cb2-91" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">high_tide =</span> hms<span class="sc">::</span><span class="fu">as_hms</span>(high_tide)) <span class="sc">|&gt;</span></span>
<span id="cb2-92"><a href="#cb2-92" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add date to sample time</span></span>
<span id="cb2-93"><a href="#cb2-93" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sample_time =</span> <span class="fu">ymd_hms</span>(<span class="fu">paste</span>(date,sample_time),<span class="at">tz=</span> <span class="st">"America/New_York"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb2-94"><a href="#cb2-94" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">high_tide =</span> <span class="fu">ymd_hms</span>(<span class="fu">paste</span>(date,high_tide),<span class="at">tz=</span> <span class="st">"America/New_York"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb2-95"><a href="#cb2-95" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.list), as.character)) <span class="sc">|&gt;</span></span>
<span id="cb2-96"><a href="#cb2-96" aria-hidden="true" tabindex="-1"></a>  <span class="co"># We chose to make "Trace" and "&lt;10" into zero.</span></span>
<span id="cb2-97"><a href="#cb2-97" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.character), <span class="at">.fns =</span> <span class="sc">~</span> <span class="fu">str_replace</span>(.x, <span class="st">"&lt;10"</span>, <span class="st">"0"</span>))) <span class="sc">|&gt;</span></span>
<span id="cb2-98"><a href="#cb2-98" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.character), <span class="at">.fns =</span> <span class="sc">~</span> <span class="fu">str_replace</span>(.x, <span class="st">"Trace"</span>, <span class="st">"0"</span>))) <span class="sc">|&gt;</span></span>
<span id="cb2-99"><a href="#cb2-99" aria-hidden="true" tabindex="-1"></a>  <span class="co"># &gt; 24196 test limit?  This value is so far out of the range of the other values</span></span>
<span id="cb2-100"><a href="#cb2-100" aria-hidden="true" tabindex="-1"></a>  <span class="co"># that it might as well be infinity.</span></span>
<span id="cb2-101"><a href="#cb2-101" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.character), <span class="at">.fns =</span> <span class="sc">~</span> <span class="fu">str_replace</span>(.x, <span class="st">"&gt;"</span>, <span class="st">""</span>))) <span class="sc">|&gt;</span></span>
<span id="cb2-102"><a href="#cb2-102" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get rid of snow inches next to precip as water</span></span>
<span id="cb2-103"><a href="#cb2-103" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.character), <span class="at">.fns =</span> <span class="sc">~</span> <span class="fu">str_replace</span>(.x, <span class="st">"</span><span class="sc">\\</span><span class="st">(.+</span><span class="sc">\\</span><span class="st">)"</span>, <span class="st">""</span>))) <span class="sc">|&gt;</span></span>
<span id="cb2-104"><a href="#cb2-104" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.character), <span class="at">.fns =</span> <span class="sc">~</span> <span class="fu">na_if</span>(.x, <span class="st">"N/A"</span>))) <span class="sc">|&gt;</span></span>
<span id="cb2-105"><a href="#cb2-105" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">contains</span>(<span class="st">"precip"</span>), as.numeric)) <span class="sc">|&gt;</span></span>
<span id="cb2-106"><a href="#cb2-106" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">bacteria =</span> <span class="fu">as.numeric</span>(bacteria)) <span class="sc">|&gt;</span></span>
<span id="cb2-107"><a href="#cb2-107" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">notes =</span> <span class="fu">replace_na</span>(notes, <span class="st">""</span>)) <span class="sc">|&gt;</span></span>
<span id="cb2-108"><a href="#cb2-108" aria-hidden="true" tabindex="-1"></a>  <span class="co"># fix some typos</span></span>
<span id="cb2-109"><a href="#cb2-109" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">site =</span> <span class="fu">str_replace</span>(site, <span class="st">"Daylighted Section"</span>, <span class="st">"daylighted section"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb2-110"><a href="#cb2-110" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">site =</span> <span class="fu">str_replace</span>(site, <span class="st">"Govenors"</span>, <span class="st">"Governors"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb2-111"><a href="#cb2-111" aria-hidden="true" tabindex="-1"></a>  <span class="co"># classify bacteria levels according to NY DEP standards</span></span>
<span id="cb2-112"><a href="#cb2-112" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">site =</span> <span class="fu">as.factor</span>(site)) <span class="sc">|&gt;</span></span>
<span id="cb2-113"><a href="#cb2-113" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">site_id =</span> <span class="fu">as.factor</span>(site_id))</span>
<span id="cb2-114"><a href="#cb2-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-115"><a href="#cb2-115" aria-hidden="true" tabindex="-1"></a>  <span class="co"># write to parquet</span></span>
<span id="cb2-116"><a href="#cb2-116" aria-hidden="true" tabindex="-1"></a>  <span class="co"># arrow::write_parquet(wq_data,here("data/wq_data.parquet"))</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load data files</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>water_body_classifications <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/NYDEC_water_classifications.csv"</span>,<span class="at">col_types =</span> <span class="st">"fcc"</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>wq_meta <span class="ot">&lt;-</span> arrow<span class="sc">::</span><span class="fu">read_parquet</span>(<span class="st">"data/wq_meta.parquet"</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>wq_data_raw <span class="ot">&lt;-</span> arrow<span class="sc">::</span><span class="fu">read_parquet</span>(<span class="st">"data/wq_data.parquet"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="data-cleaning" class="level2">
<h2 class="anchored" data-anchor-id="data-cleaning">Data Cleaning</h2>
<p>While we cleaned up the data in the previous section, we still might want to do some feature engineering to get the data ready for modeling. In particular, the bacterial levels are classified according to NY DEP standards as “SAFE” or “UNSAFE” with a another category in between that indicates heightened vigilance which we’ll call “CAUTION,” so let’s make a column for that.</p>
<p>The data contains rainfall amounts for each day in the week preceding the sample date. The NY DEP standard is to use the 48-hour rainfall amount as a predictor of bacterial levels. We’ll aggregate up the rainfall columns into three non-overlapping intervals, same day, previous 48 hours and earlier days in the week. It’s worth noting that rainfall for the sample day is for the entire 24-hour period and not just preceding the time of the sample.</p>
<p>While we have the precise location of each sampling site it might be useful to have general location information. This will include the water body classification, the sewershed, the name of the body of water and the lab processing the samples.</p>
<p>The month is a cyclical feature. December, month number 12, is closer in climate to month number 1 than it is to month number 6, so we’ll recode the month numbers to reflect that, setting August as the hottest month.</p>
<p>Finally, we’ll convert all NAs in the factor columns to a “missing” level. This will let us keep rows with NA in the models but all missing will have the same value. This is a choice that could be revisited later.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get all levels of lab_analysis columns matched with year</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>all_labs <span class="ot">&lt;-</span> wq_meta <span class="sc">|&gt;</span> </span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">contains</span>(<span class="st">"lab_analysis"</span>),site_id) <span class="sc">|&gt;</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">contains</span>(<span class="st">"x"</span>),</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"year"</span>,</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"lab"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">as.numeric</span>(<span class="fu">str_extract</span>(year,<span class="st">"[0-9]+"</span>))) <span class="sc">|&gt;</span> </span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">lab =</span> <span class="fu">as.character</span>(lab)) <span class="sc">|&gt;</span> </span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(lab <span class="sc">!=</span> <span class="st">"NA"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">lab =</span> <span class="fu">as.factor</span>(lab))</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="co"># convert all N/As in factor columns to a "missing" level</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="co"># This will let us keep rows with NA in the models but all missing will have the same value</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="co"># good or bad?</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>wq_meta <span class="ot">&lt;-</span> wq_meta <span class="sc">|&gt;</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.factor), <span class="sc">~</span> <span class="fu">fct_na_value_to_level</span>(.x,<span class="at">level =</span> <span class="st">"missing"</span>)))</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="co"># feature engineering</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>wq_data <span class="ot">&lt;-</span> wq_data_raw <span class="sc">%&gt;%</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># use of dplyr pipe needed for duckplyr, not native "|&gt;" pipe</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># make 2-day precip column since 48-hour precip is a DEP standard</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># since observation time is typically in the morning don't include the current day's precip</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># since we don't know if it came before, during or after collection</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">precip_week =</span> <span class="fu">rowSums</span>(<span class="fu">select</span>(., <span class="fu">starts_with</span>(<span class="st">"precip"</span>)), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),<span class="at">.after=</span><span class="st">"bacteria"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">precip_48 =</span> <span class="fu">rowSums</span>(<span class="fu">select</span>(., precip_t1,precip_t2), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),<span class="at">.after=</span><span class="st">"bacteria"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">precip_earlier =</span> <span class="fu">rowSums</span>(<span class="fu">select</span>(., precip_t3,precip_t4,precip_t5,,precip_t6), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),<span class="at">.after=</span><span class="st">"precip_48"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>precip_t1,<span class="sc">-</span>precip_t2,<span class="sc">-</span>precip_t3,<span class="sc">-</span>precip_t4,<span class="sc">-</span>precip_t5,<span class="sc">-</span>precip_t6) <span class="sc">%&gt;%</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># categorize bacteria levels as quality levels</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">quality =</span> <span class="fu">as_factor</span>(<span class="fu">cut</span>(</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>    bacteria,</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,SAFE, CAUTION, <span class="cn">Inf</span>),</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Safe"</span>, <span class="st">"Caution"</span>, <span class="st">"Unsafe"</span>)</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>  ))) <span class="sc">%&gt;%</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># compute time between sample time and high tide</span></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">time_since_high_tide =</span> <span class="fu">as.numeric</span>(<span class="fu">difftime</span>(sample_time,high_tide,<span class="at">units =</span> <span class="st">"hours"</span>)),</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>         <span class="at">.after =</span> <span class="st">"sample_time"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>()</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a><span class="co"># add some meta data that might be interesting in prediction</span></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a><span class="co"># add water body type,  water body and sewershed from metadata</span></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>wq_data <span class="ot">&lt;-</span> wq_data <span class="sc">|&gt;</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(<span class="at">by =</span> <span class="st">"site_id"</span>,<span class="fu">select</span>(wq_meta,</span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>                   site_id,</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>                   water_body,</span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>                   nys_dec_water_body_classification,</span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>                   nyc_dep_wrrf_or_sewershed)</span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>            ) <span class="sc">|&gt;</span></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>  <span class="co"># change all character columns to factors</span></span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.character), as.factor)) <span class="sc">|&gt;</span></span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>  <span class="co"># rename columns</span></span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">water_class =</span> nys_dec_water_body_classification,</span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>         <span class="at">sewershed =</span> nyc_dep_wrrf_or_sewershed)</span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a><span class="co"># create a column that corresponds the relative temperature of the month</span></span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a><span class="co"># July is the hottest month in NYC</span></span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>wq_data <span class="ot">&lt;-</span> wq_data <span class="sc">|&gt;</span></span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">season =</span> <span class="fu">as.numeric</span>(<span class="fu">factor</span>(<span class="fu">month</span>(date), <span class="at">levels =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">12</span>, <span class="at">labels =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span>,<span class="dv">6</span>,<span class="dv">5</span>,<span class="dv">4</span>,<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">1</span>))))</span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>wq_data <span class="ot">&lt;-</span> wq_data <span class="sc">|&gt;</span></span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(all_labs,<span class="at">by =</span> <span class="fu">c</span>(<span class="st">"site_id"</span>,<span class="st">"year"</span>)) </span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a><span class="co"># convert all N/As in factor columns to a "missing" level</span></span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a><span class="co"># This will let us keep rows with NA in the models but all missing will have the same value</span></span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a><span class="co"># good or bad?</span></span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a><span class="co">#wq_data &lt;- wq_data |&gt;</span></span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a><span class="co">#   mutate(across(where(is.factor), ~ fct_na_value_to_level(.x,level = "missing")))</span></span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a>wq_data <span class="ot">&lt;-</span> wq_data <span class="sc">|&gt;</span></span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="at">lab =</span> <span class="fu">fct_na_value_to_level</span>(lab,<span class="at">level =</span> <span class="st">"missing"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="exploratory-data-analysis" class="level2">
<h2 class="anchored" data-anchor-id="exploratory-data-analysis">Exploratory Data Analysis</h2>
<p>Let’s start by looking at a map of all the sampling sites. Many sites (in red, below) are no longer being tested. The upper half of Manhattan, both on the Hudson side and the East River side are not included in the most recent data. We have to be careful about drawing conclusions about changes over time for the whole sampling set because the sites are not constant.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># convert wq_meta into a simple features object</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>wq_meta_sf <span class="ot">&lt;-</span> wq_meta <span class="sc">|&gt;</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(water_body_classifications,</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"nys_dec_water_body_classification"</span> <span class="ot">=</span> <span class="st">"water_body_class"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"longitude"</span>,<span class="st">"latitude"</span>),<span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co"># display a leaflet map --------------------------------------------------------</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>map_labels <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"&lt;strong&gt;{wq_meta_sf$site}&lt;/strong&gt;&lt;br/&gt;</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="st">                          Currently Testing? &lt;/strong&gt;{wq_meta_sf$currently_testing}&lt;br/&gt;</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="st">                          Sewershed: {wq_meta_sf$nyc_dep_wrrf_or_sewershed}&lt;br/&gt;</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="st">                         Use: {wq_meta_sf$best_uses}"</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(htmltools<span class="sc">::</span>HTML)</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>wq_meta_sf <span class="sc">|&gt;</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">leaflet</span>() <span class="sc">|&gt;</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addTiles</span>() <span class="sc">|&gt;</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addCircleMarkers</span>(<span class="at">radius =</span> <span class="dv">5</span>,</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>                            <span class="at">label =</span> <span class="sc">~</span>map_labels,</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>                            <span class="at">color =</span> <span class="sc">~</span><span class="fu">ifelse</span>(currently_testing,<span class="st">"green"</span>,<span class="st">"red"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="leaflet html-widget html-fill-item" id="htmlwidget-311c2242efcfd54e880b" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-311c2242efcfd54e880b">{"x":{"options":{"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}}},"calls":[{"method":"addTiles","args":["https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",null,null,{"minZoom":0,"maxZoom":18,"tileSize":256,"subdomains":"abc","errorTileUrl":"","tms":false,"noWrap":false,"zoomOffset":0,"zoomReverse":false,"opacity":1,"zIndex":1,"detectRetina":false,"attribution":"&copy; <a href=\"https://openstreetmap.org/copyright/\">OpenStreetMap<\/a>,  <a href=\"https://opendatacommons.org/licenses/odbl/\">ODbL<\/a>"}]},{"method":"addCircleMarkers","args":[[40.50138,40.797291,40.801921,40.862411,40.82449,40.8178447,40.8097,40.8144,40.832385,40.8321416,40.691375,40.678574,40.5835405,40.5844306,40.5810247,40.5825464,40.5791505,40.748051,40.706887,40.7252056,40.723181,40.7044059,40.77719,40.709882,40.743849,40.7168567,40.769516,40.81012,40.793278,40.73157,40.72191,40.718943,40.700789,40.699967,40.709208,40.709865,40.6968031,40.7103,40.7142915,40.7130241,40.710069,40.7333646,40.8091363,40.8048868,40.7055253,40.730086,40.771964,40.7634239,40.760445,40.7598868,40.760543,40.675486,40.6761467,40.6783319,40.676586,40.674423,40.6768139,40.5853425,40.60138,40.662968,40.763925,40.859316,40.807001,40.688829,40.842404,40.806018,40.806394,40.7910125,40.874568,40.864361,40.864388,40.856102,40.78917,40.9566318,40.9566318,40.7413476,40.739174,40.739183,40.740726,40.7391216,40.748265,40.8674926,40.9566318,40.751744,40.7215745,40.728249,40.752502,40.764275,40.771322,40.7735219,40.7799272,40.7553196,40.799369,40.818007,40.8206007,40.8283762,40.832214,40.8461433,40.781422,40.7859195,40.9379388,40.8634849,40.6278942,40.602409,40.6264122,40.5824832,40.64512,40.74727,40.7801708,40.7375594,40.7292914,40.7429327,40.7378927,40.7167533,40.7120691,40.739025,40.7355189,40.739534,40.7385105,40.7248845,40.736974,40.655305,40.571734,40.601792,40.599456,40.5422,40.572109,40.5665366,40.549642,40.579248,40.48334,40.48769,40.47483,40.54067,40.48826,40.50007,40.9356552,40.583419,40.6546621,40.6548329,40.645481,40.639326,40.8898985,40.728539],[-74.25416,-73.916026,-73.92408399999999,-73.874364,-73.88505000000001,-73.881072,-73.8682,-73.8708,-73.88282100000001,-73.88292800000001,-74.01253199999999,-74.018372,-73.9927194,-73.990388,-73.997941,-73.97483699999999,-73.98747,-73.954628,-74.001142,-73.959234,-73.962509,-73.990526,-73.94211,-73.989594,-73.960111,-73.96717700000001,-73.935593,-73.80231999999999,-73.848917,-73.96176,-73.96301,-73.96574099999999,-73.996922,-73.99807,-73.988505,-73.988629,-73.99888,-73.980614,-73.968192,-73.96871400000001,-73.96965,-73.973866,-73.80270299999999,-73.79435599999999,-73.970263,-73.961404,-73.85035000000001,-73.843532,-73.849571,-73.85146,-73.83645799999999,-73.990887,-73.992577,-73.98931399999999,-73.98961,-73.996425,-73.98991599999999,-73.99837890000001,-74.0125,-74.133458,-74.08723000000001,-74.032318,-74.05710000000001,-74.11227599999999,-73.929444,-73.930089,-73.9303903,-73.927415,-73.917539,-73.91591200000001,-73.915755,-73.922073,-73.93277,-73.89769,-73.89769,-74.025702,-74.010909,-74.011194,-74.009682,-74.010559,-74.023647,-73.93291499999999,-73.89769,-74.022864,-74.01355700000001,-74.013786,-74.00897999999999,-74.002129,-73.995991,-73.99377800000001,-73.989316,-74.026094,-73.97579500000001,-73.96212800000001,-73.959577,-73.954165,-73.95148500000001,-73.9464,-73.98835,-73.98522699999999,-73.903492,-73.82018600000001,-73.8837,-73.93171599999999,-73.904386,-73.920157,-74.12563,-73.80655,-73.768804,-73.83879,-73.93728,-73.939319,-73.945885,-73.92292500000001,-73.93129399999999,-73.952972,-73.94509100000001,-73.95224399999999,-73.95996100000001,-73.9258,-73.94683999999999,-73.96420999999999,-74.21247700000001,-74.256497,-74.26831799999999,-74.1254,-74.08794,-74.0914556,-74.11161800000001,-74.07495299999999,-74.2698,-74.38409,-74.35586000000001,-74.51219,-74.43384,-74.27719,-73.90179500000001,-73.945179,-74.01834700000001,-74.01824499999999,-74.074752,-74.038539,-73.891811,-73.83408],5,null,null,{"interactive":true,"className":"","stroke":true,"color":["green","green","green","red","green","green","green","green","green","red","green","green","green","red","green","red","red","red","green","green","green","green","green","green","green","green","green","green","red","green","green","green","red","green","green","green","green","red","red","green","green","green","green","green","green","green","green","green","green","red","green","red","red","red","red","red","green","green","green","green","green","green","green","green","red","red","green","green","red","red","red","red","green","red","red","green","green","green","green","green","green","red","green","green","green","green","green","green","green","green","red","green","red","red","red","red","red","green","red","red","green","red","red","red","green","red","green","green","green","green","green","green","red","green","green","red","red","green","green","red","red","green","green","green","green","green","green","green","green","red","green","green","green","green","green","green","green","red","green","green","red","green","red","red"],"weight":5,"opacity":0.5,"fill":true,"fillColor":["green","green","green","red","green","green","green","green","green","red","green","green","green","red","green","red","red","red","green","green","green","green","green","green","green","green","green","green","red","green","green","green","red","green","green","green","green","red","red","green","green","green","green","green","green","green","green","green","green","red","green","red","red","red","red","red","green","green","green","green","green","green","green","green","red","red","green","green","red","red","red","red","green","red","red","green","green","green","green","green","green","red","green","green","green","green","green","green","green","green","red","green","red","red","red","red","red","green","red","red","green","red","red","red","green","red","green","green","green","green","green","green","red","green","green","red","red","green","green","red","red","green","green","green","green","green","green","green","green","red","green","green","green","green","green","green","green","red","green","green","red","green","red","red"],"fillOpacity":0.2},null,null,null,null,["<strong>Arthur Kill, Conference House Park<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Oakwood Beach<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>Bronx Kill, east end<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Wards Island<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>Bronx Kill, west end<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Wards Island<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>Bronx River, Bronx Botanical Gardens<\/strong><br/>\n Currently Testing? <\/strong>FALSE<br/>\n Sewershed: Hunts Point<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>Bronx River, Concrete Plant Park Canoe Launch<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Hunts Point<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>Bronx River, Hunts Point Riverside Park<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Hunts Point<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>Bronx River, Soundview Park (mouth)<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Hunts Point<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>Bronx River, Soundview Park, HP009 CSO<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Hunts Point<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>Bronx River, Starlight Park, North Dock<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Hunts Point<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>Bronx River, Starlight Park, south of dam<\/strong><br/>\n Currently Testing? <\/strong>FALSE<br/>\n Sewershed: Hunts Point<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>Buttermilk Channel, Pier 101, Governors Island<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Red Hook<br/>\nUse: (marine waters) Swimming and other recreation and fishing","<strong>Buttermilk Channel, Valentino Pier<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Red Hook<br/>\nUse: (marine waters) Swimming and other recreation and fishing","<strong>Coney Island Creek, Calvert Vaux Beach<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Coney Island<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>Coney Island Creek, Calvert Vaux Park<\/strong><br/>\n Currently Testing? <\/strong>FALSE<br/>\n Sewershed: Coney Island<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>Coney Island Creek, Kaiser Park<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Coney Island<br/>\nUse: (marine waters) Swimming and other recreation and fishing","<strong>Coney Island Creek, Shell Road (head of creek)<\/strong><br/>\n Currently Testing? <\/strong>FALSE<br/>\n Sewershed: Coney Island<br/>\nUse: (marine waters) Swimming and other recreation and fishing","<strong>Coney Island Creek, West 21st Street<\/strong><br/>\n Currently Testing? <\/strong>FALSE<br/>\n Sewershed: Coney Island<br/>\nUse: (marine waters) Swimming and other recreation and fishing","<strong>East River, Anable Basin<\/strong><br/>\n Currently Testing? <\/strong>FALSE<br/>\n Sewershed: Bowery Bay<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>East River, Brooklyn Bridge Beach, Manhattan<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Newtown Creek<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>East River, Bushwick Inlet<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Newtown Creek<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>East River, Bushwick Inlet Park Beach<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Newtown Creek<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>East River, Dumbo Cove<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Red Hook<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>East River, E 90th St Ferry<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Wards Island<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>East River, Esplanade (+Pool)<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Newtown Creek<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>East River, Gantry State Park<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Bowery Bay<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>East River, Grand Ferry Park<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Newtown Creek<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>East River, Hallets Cove<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Bowery Bay<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>East River, Hammond Creek (HC)<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Hunts Point<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>East River, Hermon A. MacNeil Park<\/strong><br/>\n Currently Testing? <\/strong>FALSE<br/>\n Sewershed: Tallmans Island<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>East River, India Street<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Newtown Creek<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>East River, Marsha P Johnson State Park<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Newtown Creek<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>East River, North 3rd Street<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Newtown Creek<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>East River, Pier 1, Brooklyn Bridge Park<\/strong><br/>\n Currently Testing? <\/strong>FALSE<br/>\n Sewershed: Red Hook<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>East River, Pier 2 Kayak Dock, Brooklyn Bridge Park<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Red Hook<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>East River, Pier 35 (+POOL), End-Pier<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Newtown Creek<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>East River, Pier 35 (+POOL), Mid-Pier<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Newtown Creek<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>East River, Pier 4 Beach, Brooklyn Bridge Park<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Red Hook<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>East River, Pier 42/Jackson Street<\/strong><br/>\n Currently Testing? <\/strong>FALSE<br/>\n Sewershed: Newtown Creek<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>East River, South 3rd Street/Domino Park<\/strong><br/>\n Currently Testing? <\/strong>FALSE<br/>\n Sewershed: Newtown Creek<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>East River, South 5th Street/Domino Park<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Newtown Creek<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>East River, South 8th St<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Newtown Creek<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>East River, Stuy Cove Park<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Newtown Creek<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>East River, SUNY Maritime Campus Entrance (IT)<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Hunts Point<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>East River, SUNY Maritime Waterfront Center (MAR)<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Hunts Point<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>East River, Wallabout Channel, Brooklyn Navy Yard<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Red Hook<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>East River, WNYC Transmitter Park<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Newtown Creek<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>Flushing Bay, 28th Avenue, Big Rock Beach<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Tallmans Island<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>Flushing Bay, World's Fair Marina Boat Ramp<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Bowery Bay<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>Flushing Bay, World's Fair Marina Pier 1 East<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Bowery Bay<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>Flushing Bay, World's Fair Marina Pier 1 West<\/strong><br/>\n Currently Testing? <\/strong>FALSE<br/>\n Sewershed: Bowery Bay<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>Flushing Creek<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Tallmans Island<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>Gowanus Canal, 2nd Avenue Salt Lot<\/strong><br/>\n Currently Testing? <\/strong>FALSE<br/>\n Sewershed: Owls Head<br/>\nUse: (marine waters) Fishing but these waters may not support fish propagation","<strong>Gowanus Canal, Bond Street<\/strong><br/>\n Currently Testing? <\/strong>FALSE<br/>\n Sewershed: Red Hook<br/>\nUse: (marine waters) Fishing but these waters may not support fish propagation","<strong>Gowanus Canal, Carroll Street<\/strong><br/>\n Currently Testing? <\/strong>FALSE<br/>\n Sewershed: Red Hook<br/>\nUse: (marine waters) Fishing but these waters may not support fish propagation","<strong>Gowanus Canal, Denton's Pond Outfall<\/strong><br/>\n Currently Testing? <\/strong>FALSE<br/>\n Sewershed: Owls Head<br/>\nUse: (marine waters) Fishing but these waters may not support fish propagation","<strong>Gowanus Canal, Lowlands Nursery<\/strong><br/>\n Currently Testing? <\/strong>FALSE<br/>\n Sewershed: Red Hook<br/>\nUse: (marine waters) Fishing but these waters may not support fish propagation","<strong>Gowanus Canal, Second Street Sponge Park<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Red Hook<br/>\nUse: (marine waters) Fishing but these waters may not support fish propagation","<strong>Gravesend Bay, Calvert Vaux Cove<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Owls Head<br/>\nUse: (marine waters) Swimming and other recreation and fishing","<strong>Gravesend Bay, OH-015<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Owls Head<br/>\nUse: (marine waters) Swimming and other recreation and fishing","<strong>Hackensack River, Bayonne City Park, Bayonne NJ<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: NJ<br/>\nUse: NA","<strong>Hackensack River, Laurel Hill Park, Secaucus NJ<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: NJ<br/>\nUse: NA","<strong>Hackensack River, Ridgefield Park, NJ<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: NJ<br/>\nUse: NA","<strong>Hackensack River, River Barge Park, Carlstadt NJ<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: NJ<br/>\nUse: NA","<strong>Hackensack River, Rutkowski Park, Bayonne NJ<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: NJ<br/>\nUse: NA","<strong>Harlem River, High Bridge<\/strong><br/>\n Currently Testing? <\/strong>FALSE<br/>\n Sewershed: Wards Island<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>Harlem River, Lincoln Avenue 1<\/strong><br/>\n Currently Testing? <\/strong>FALSE<br/>\n Sewershed: Wards Island<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>Harlem River, Lincoln Avenue 2<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Wards Island<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>Harlem River, Little Hell Gate<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Wards Island<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>Harlem River, Muscota Marsh<\/strong><br/>\n Currently Testing? <\/strong>FALSE<br/>\n Sewershed: North River<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>Harlem River, North Cove<\/strong><br/>\n Currently Testing? <\/strong>FALSE<br/>\n Sewershed: North River<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>Harlem River, North Cove Spring<\/strong><br/>\n Currently Testing? <\/strong>FALSE<br/>\n Sewershed: North River<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>Harlem River, Swindlers Cove/Peter J. Sharpe Boathouse<\/strong><br/>\n Currently Testing? <\/strong>FALSE<br/>\n Sewershed: North River<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>Harlem River, Water's Edge Garden Beach<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Wards Island<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>Hudson River, Beczak Beach #1<\/strong><br/>\n Currently Testing? <\/strong>FALSE<br/>\n Sewershed: NJ<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>Hudson River, Beczak Beach #2<\/strong><br/>\n Currently Testing? <\/strong>FALSE<br/>\n Sewershed: NJ<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>Hudson River, Frank Sinatra Park, Hoboken NJ<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: NJ<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>Hudson River, Gansevoort Peninsula South – Middle<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: North River<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>Hudson River, Gansevoort Peninsula South – Ramp<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: North River<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>Hudson River, Gansevoort Peninsula, North<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: North River<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>Hudson River, Gansevoort Peninsula, South<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: North River<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>Hudson River, Hoboken Cove Beach, Hoboken NJ<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: NJ<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>Hudson River, Inwood Canoe Club<\/strong><br/>\n Currently Testing? <\/strong>FALSE<br/>\n Sewershed: North River<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>Hudson River, JFK Marina<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: NJ<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>Hudson River, Pier 13, Hoboken, NJ<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: NJ<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>Hudson River, Pier 26<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Newtown Creek<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>Hudson River, Pier 40<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Newtown Creek<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>Hudson River, Pier 66<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: North River<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>Hudson River, Pier 84<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: North River<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>Hudson River, Pier 96<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: North River<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>Hudson River, Pier 99 Boat Launch<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: North River<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>Hudson River, Pier I/70th Street<\/strong><br/>\n Currently Testing? <\/strong>FALSE<br/>\n Sewershed: North River<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>Hudson River, Weehawken Cove, Hoboken NJ<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: NJ<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>Hudson River, West 100th Street<\/strong><br/>\n Currently Testing? <\/strong>FALSE<br/>\n Sewershed: North River<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>Hudson River, West 129th Street, St. Clair Place<\/strong><br/>\n Currently Testing? <\/strong>FALSE<br/>\n Sewershed: North River<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>Hudson River, West 133rd Street/Piers Park Kayak Dock<\/strong><br/>\n Currently Testing? <\/strong>FALSE<br/>\n Sewershed: North River<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>Hudson River, West 145th Street<\/strong><br/>\n Currently Testing? <\/strong>FALSE<br/>\n Sewershed: North River<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>Hudson River, West 154th Street<\/strong><br/>\n Currently Testing? <\/strong>FALSE<br/>\n Sewershed: North River<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>Hudson River, West 172nd Street, Riverside Park<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: North River<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>Hudson River, West 72nd Street Kayak Launch<\/strong><br/>\n Currently Testing? <\/strong>FALSE<br/>\n Sewershed: North River<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>Hudson River, West 79th Street Boat Basin<\/strong><br/>\n Currently Testing? <\/strong>FALSE<br/>\n Sewershed: North River<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>Hudson River, Yonkers Paddling and Rowing Club<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: NJ<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>Hutchinson River, Amtrak Bridge<\/strong><br/>\n Currently Testing? <\/strong>FALSE<br/>\n Sewershed: Hunts Point<br/>\nUse: (marine waters) Swimming and other recreation and fishing","<strong>Jamaica Bay, Canarsie Pier<\/strong><br/>\n Currently Testing? <\/strong>FALSE<br/>\n Sewershed: Coney Island<br/>\nUse: (marine waters) Swimming and other recreation and fishing","<strong>Jamaica Bay, Gerritsen Creek Kayak Launch (Marine Park Salt Marsh)<\/strong><br/>\n Currently Testing? <\/strong>FALSE<br/>\n Sewershed: Coney Island<br/>\nUse: (marine waters) Swimming and other recreation and fishing","<strong>Jamaica Bay, Paerdegat Basin, Sebago Canoe Club<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Coney Island<br/>\nUse: (marine waters) Swimming and other recreation and fishing","<strong>Jamaica Bay, Plumb Beach<\/strong><br/>\n Currently Testing? <\/strong>FALSE<br/>\n Sewershed: Coney Island<br/>\nUse: (marine waters) Swimming and other recreation and fishing","<strong>Kill Van Kull, Brady’s Dock, Bayonne NJ<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: NJ<br/>\nUse: NA","<strong>Kissena Lake<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Tallmans Island<br/>\nUse: Swimming and other recreation and fishing","<strong>Little Neck Bay<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Tallmans Island<br/>\nUse: (marine waters) Swimming and other recreation and fishing","<strong>Meadow Lake, Flushing Meadows-Corona Park<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Bowery Bay<br/>\nUse: Swimming and other recreation and fishing","<strong>Newtown Creek, Apollo Street<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Newtown Creek<br/>\nUse: (marine waters) Fishing but these waters may not support fish propagation","<strong>Newtown Creek, Dutch Kills (head)<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Bowery Bay<br/>\nUse: (marine waters) Fishing but these waters may not support fish propagation","<strong>Newtown Creek, Dutch Kills (mouth)<\/strong><br/>\n Currently Testing? <\/strong>FALSE<br/>\n Sewershed: Bowery Bay<br/>\nUse: (marine waters) Fishing but these waters may not support fish propagation","<strong>Newtown Creek, East Branch<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Newtown Creek<br/>\nUse: (marine waters) Fishing but these waters may not support fish propagation","<strong>Newtown Creek, English Kills<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Newtown Creek<br/>\nUse: (marine waters) Fishing but these waters may not support fish propagation","<strong>Newtown Creek, North Brooklyn Community Boathouse/Pulaski Bridge<\/strong><br/>\n Currently Testing? <\/strong>FALSE<br/>\n Sewershed: Newtown Creek<br/>\nUse: (marine waters) Fishing but these waters may not support fish propagation","<strong>Newtown Creek, North Henry Street<\/strong><br/>\n Currently Testing? <\/strong>FALSE<br/>\n Sewershed: Newtown Creek<br/>\nUse: (marine waters) Fishing but these waters may not support fish propagation","<strong>Newtown Creek, Pulaski Bridge, Queens<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Bowery Bay<br/>\nUse: (marine waters) Fishing but these waters may not support fish propagation","<strong>Newtown Creek, Second Street Kayak Launch<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Bowery Bay<br/>\nUse: (marine waters) Fishing but these waters may not support fish propagation","<strong>Newtown Creek, Turning Basin<\/strong><br/>\n Currently Testing? <\/strong>FALSE<br/>\n Sewershed: Newtown Creek<br/>\nUse: (marine waters) Fishing but these waters may not support fish propagation","<strong>Newtown Creek, Whale Creek<\/strong><br/>\n Currently Testing? <\/strong>FALSE<br/>\n Sewershed: Newtown Creek<br/>\nUse: (marine waters) Fishing but these waters may not support fish propagation","<strong>Prospect Park Lake<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Owls Head<br/>\nUse: Swimming and other recreation and fishing","<strong>Rahway River, Carteret Waterfront Park<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: NJ<br/>\nUse: NA","<strong>Rahway River, Rahway Valley Sewerage Authority<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: NJ<br/>\nUse: NA","<strong>Rahway River, Riverfront Park<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: NJ<br/>\nUse: NA","<strong>Raritan Bay, Great Kills Beach<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Oakwood Beach<br/>\nUse: (marine waters) Swimming and other recreation and fishing","<strong>Raritan Bay, Midlland Beach<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Oakwood Beach<br/>\nUse: (marine waters) Swimming and other recreation and fishing","<strong>Raritan Bay, New Dorp Beach<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Oakwood Beach<br/>\nUse: (marine waters) Swimming and other recreation and fishing","<strong>Raritan Bay, Oakwood Beach<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Oakwood Beach<br/>\nUse: (marine waters) Swimming and other recreation and fishing","<strong>Raritan Bay, South Beach<\/strong><br/>\n Currently Testing? <\/strong>FALSE<br/>\n Sewershed: Oakwood Beach<br/>\nUse: (marine waters) Swimming and other recreation and fishing","<strong>Raritan Bay, Waterfront Park, South Amboy, NJ<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: NJ<br/>\nUse: NA","<strong>Raritan River, Edison Boat Basin, Edison NJ<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: NJ<br/>\nUse: NA","<strong>Raritan River, Ken Buchanan Park, Sayreville NJ<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: NJ<br/>\nUse: NA","<strong>Raritan River, Riverside Park, Piscataway NJ<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: NJ<br/>\nUse: NA","<strong>Raritan River, Rutgers Boathouse, New Brunswick NJ<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: NJ<br/>\nUse: NA","<strong>Raritan River, Second Street Park, Perth Amboy NJ<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: NJ<br/>\nUse: NA","<strong>Saw Mill River, daylighted section<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: NJ<br/>\nUse: (marine waters) Swimming and other recreation and fishing","<strong>Sheepshead Bay<\/strong><br/>\n Currently Testing? <\/strong>FALSE<br/>\n Sewershed: Coney Island<br/>\nUse: (marine waters) Secondary contact recreation and fishing","<strong>Upper Harbor, Bush Terminal Park (Inner Lagoon)<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Owls Head<br/>\nUse: (marine waters) Swimming and other recreation and fishing","<strong>Upper Harbor, Bush Terminal Park (North Embayment)<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Owls Head<br/>\nUse: (marine waters) Swimming and other recreation and fishing","<strong>Upper Harbor, North Shore Esplanade<\/strong><br/>\n Currently Testing? <\/strong>FALSE<br/>\n Sewershed: Port Richmond<br/>\nUse: (marine waters) Swimming and other recreation and fishing","<strong>Upper Harbor, Pier 69<\/strong><br/>\n Currently Testing? <\/strong>TRUE<br/>\n Sewershed: Owls Head<br/>\nUse: (marine waters) Swimming and other recreation and fishing","<strong>Van Cortlandt Park Lake<\/strong><br/>\n Currently Testing? <\/strong>FALSE<br/>\n Sewershed: Wards Island<br/>\nUse: Swimming and other recreation and fishing","<strong>Willow Lake, Flushing Meadows-Corona Park<\/strong><br/>\n Currently Testing? <\/strong>FALSE<br/>\n Sewershed: Bowery Bay<br/>\nUse: Swimming and other recreation and fishing"],{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]}],"limits":{"lat":[40.47483,40.9566318],"lng":[-74.51219,-73.768804]}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>The data contains the “sewershed” for each site. Sewersheds are areas of the city that drain into the rivers from a particular section of the sewer system and treatment plant. It may be that particular sewersheds are more likely to overflow during heavy rain and thus more prone to high bacteria levels. We shall see.</p>
<iframe width="100%" height="520" frameborder="0" src="https://openseweratlas.tumblr.com/dryweathermap">
</iframe>
<p>A problem we often face with prediction models is the data is not nicely distributed. Bacteria levels in our dataset are very skewed. We get a more balanced distribution if we bin the levels into DEP quality categories. We will use this as our target variable for prediction.</p>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ggplot histogram of bacteria levels</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>wq_data <span class="sc">|&gt;</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> bacteria)) <span class="sc">+</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">30</span>,<span class="at">fill =</span> <span class="st">"lightblue"</span>) <span class="sc">+</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Histogram of Bacteria Levels"</span>,</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Bacteria Levels"</span>,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Count"</span>) <span class="sc">+</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="co"># ggplot histogram of quality levels</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>wq_data <span class="sc">|&gt;</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> quality)) <span class="sc">+</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">fill =</span> <span class="st">"lightblue"</span>) <span class="sc">+</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Histogram of Bacteria Quality Levels"</span>,</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Quality Levels"</span>,</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Count"</span>) <span class="sc">+</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="cell quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="oyster_files/figure-html/bacteria_hist-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="oyster_files/figure-html/quality_hist-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
<p>Similarly, we can look at the distributions for the other numeric features in our dataset. We have already converted month numbers into a seasonality feature so we won’t use “month” as a predictor. We see that most of the observations happen in the warm months.</p>
<p>Precipitation shows a skewed distribution. This is an example of how EDA can help us think about the model features. Most days it does not rain but the wider time windows are slightly more evenly distributed, so let’s just use the precipitation for the entire prior week in the model.</p>
<p>Tide times are evenly distributed, as we would expect.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># distribution of numeric features</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>wq_data <span class="sc">|&gt;</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>year,<span class="sc">-</span>bacteria) <span class="sc">|&gt;</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(is.numeric) <span class="sc">|&gt;</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gather</span>() <span class="sc">|&gt;</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value)) <span class="sc">+</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins=</span><span class="dv">20</span>,<span class="at">fill =</span> <span class="st">"lightblue"</span>) <span class="sc">+</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>key, <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Distribution of All Numeric Variables"</span>,</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Count"</span>,<span class="at">x=</span><span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="oyster_files/figure-html/feature_dist-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We might be interested in examining quality trends over time. This has to be done with caution because the number of reporting stations has increased over time, excepting during the COVID crisis. Let’s look at trends using only those stations that have been reporting for the last ten years. We add annual rainfall to see if there is any obvious correlation. Alas, water quality (defined as bacteria levels) has not been improving in the last decade.</p>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># show that reporting stations have increased over time</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>wq_data <span class="sc">|&gt;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">year</span>(date)) <span class="sc">|&gt;</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(year) <span class="sc">|&gt;</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n_distinct</span>(site_id)) <span class="sc">|&gt;</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> n)) <span class="sc">+</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">fill =</span> <span class="st">"lightblue"</span>) <span class="sc">+</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Reporting Stations Have Steadily Increased"</span>,</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Year"</span>,</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Number of Stations"</span>) <span class="sc">+</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="co"># get average daily rainfall by year</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>annl_rain <span class="ot">&lt;-</span> wq_data <span class="sc">|&gt;</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(year) <span class="sc">|&gt;</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">annual_rainfall =</span> <span class="fu">mean</span>(precip_week,<span class="at">na.rm =</span> <span class="cn">TRUE</span>)<span class="sc">*</span><span class="dv">52</span>)</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a><span class="co"># plot median bacteria levels over time only for sites that have been reporting for the all time periods</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>wq_10 <span class="ot">&lt;-</span> wq_data <span class="sc">|&gt;</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># filter out stations that have been reporting for less than 10 years</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(site) <span class="sc">|&gt;</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">n_years =</span> <span class="fu">n_distinct</span>(year)) <span class="sc">|&gt;</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(n_years <span class="sc">&gt;</span> <span class="dv">9</span>) <span class="sc">|&gt;</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(site) <span class="sc">|&gt;</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(wq_data, <span class="at">by =</span> <span class="st">"site"</span>) <span class="sc">|&gt;</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">year</span>(date) <span class="sc">&gt;</span> <span class="fu">year</span>(<span class="fu">Sys.Date</span>())<span class="sc">-</span><span class="dv">11</span>)</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>last_obs <span class="ot">&lt;-</span> wq_data<span class="sc">$</span>date <span class="sc">|&gt;</span> <span class="fu">max</span>()</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>first_obs <span class="ot">&lt;-</span> <span class="fu">year</span>(last_obs)<span class="sc">-</span><span class="dv">10</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>rain_axis <span class="ot">&lt;-</span><span class="dv">1</span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>wq_10 <span class="sc">|&gt;</span></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">&gt;</span> <span class="dv">2011</span>) <span class="sc">|&gt;</span></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">.by =</span> year, <span class="at">median_bacteria =</span> <span class="fu">median</span>(bacteria)) <span class="sc">|&gt;</span></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(annl_rain) <span class="sc">|&gt;</span></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(year) <span class="sc">|&gt;</span></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> median_bacteria)) <span class="sc">+</span> <span class="fu">geom_col</span>(<span class="at">fill =</span> <span class="st">"lightblue"</span>) <span class="sc">+</span></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> annual_rainfall), <span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">34</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="dv">2016</span>, <span class="at">y =</span> <span class="dv">34</span>, <span class="at">label =</span> <span class="st">'"Safe" Level = 34 Colonies'</span>, <span class="at">vjust =</span> <span class="sc">-</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>  <span class="co"># label the y-axes</span></span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">2000</span>,<span class="dv">2024</span>,<span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>  <span class="co"># put totat_rainfall on secondary y-axis</span></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">sec.axis =</span> <span class="fu">sec_axis</span>(<span class="sc">~</span>.<span class="sc">/</span>rain_axis, <span class="at">name =</span> <span class="st">"Annual Rainfall (Blue Line"</span>)) <span class="sc">+</span></span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Median Bacteria Concentration (Blue Bar)"</span>,</span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>       <span class="at">title=</span> <span class="fu">str_to_title</span>(<span class="st">"water is not getting cleaner over time"</span>),</span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"Sites in NY Harbor Reporting Continuously from {first_obs} to {last_obs}"</span>)</span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="cell quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="oyster_files/figure-html/stations-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="oyster_files/figure-html/rain vs quality-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
<p>In addition to numeric variables we have several categorical (aka “factor”) variables in the dataset. Each sampling site has a unique identifier, an associated sewershed, the body of water it is in (e.g.&nbsp;Hudson River) and a classification of suitable usage of the water body (e.g.&nbsp;fishing, swimming, etc).</p>
<p>More recently, the dataset has included the lab that did the water analysis. It might be interesting to see if a lab bias exists but fewer than half the observations have this information, so we don’t expect much.</p>
<p>Are some sites cleaner or dirtier than others? Yes. As we would expect, sites in water bodies with more flow are cleaner.</p>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># show boxplot of cleanest and dirtiest ----------------------------------------</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>site_boxplots <span class="ot">&lt;-</span> <span class="cf">function</span>(wq_data, <span class="at">label =</span> <span class="st">"Cleanest"</span>) {</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  median_all <span class="ot">&lt;-</span> <span class="fu">median</span>(wq_data<span class="sc">$</span>bacteria)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># show a boxplot of bacteria concentration by site</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  selected_sites <span class="ot">&lt;-</span> wq_data <span class="sc">|&gt;</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># avoid Inf log values</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># mutate(bacteria = bacteria + .001) |&gt;</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># mutate(bacteria = ifelse(bacteria == 0, 1, bacteria)) |&gt; </span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(site) <span class="sc">|&gt;</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">nest</span>() <span class="sc">|&gt;</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rowwise</span>() <span class="sc">|&gt;</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">n_obs =</span> <span class="fu">nrow</span>(data)) <span class="sc">|&gt;</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(n_obs <span class="sc">&gt;</span> <span class="dv">100</span>) <span class="sc">|&gt;</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">median_bacteria =</span> <span class="fu">median</span>(data<span class="sc">$</span>bacteria)) <span class="sc">|&gt;</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>()</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (label <span class="sc">==</span> <span class="st">"Cleanest"</span>) {</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>    selected_sites <span class="ot">&lt;-</span> <span class="fu">slice_min</span>(selected_sites, <span class="at">order_by =</span> median_bacteria, <span class="at">n =</span> <span class="dv">10</span>)</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    selected_sites <span class="ot">&lt;-</span> <span class="fu">slice_max</span>(selected_sites, <span class="at">order_by =</span> median_bacteria, <span class="at">n =</span> <span class="dv">10</span>)</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>  selected_sites <span class="sc">|&gt;</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unnest</span>(data) <span class="sc">|&gt;</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(<span class="fu">factor</span>(site), median_bacteria), <span class="at">y =</span> bacteria)) <span class="sc">+</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_log10</span>(<span class="at">oob =</span> scales<span class="sc">::</span>squish_infinite) <span class="sc">+</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_boxplot</span>(<span class="at">fill =</span> <span class="st">"lightblue"</span>) <span class="sc">+</span></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># geom_violin(draw_quantiles = .5) +</span></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># geom_jitter(width = .1) +</span></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># annotate("text", x = log(SAFE)-2, y = 1500, label = "Safe Levels", color = "darkgreen") +</span></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{label} Sites"</span>),</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>      <span class="at">subtitle =</span> <span class="st">"Based on Median Bacteria Count"</span>,</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Site"</span>,</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"Boxplot of Enterococci Concentration</span><span class="sc">\n</span><span class="st">(Log Scale)"</span></span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> SAFE,</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>               <span class="at">color =</span> <span class="st">"red"</span>,</span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>               <span class="at">linewidth =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(</span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>      <span class="st">"label"</span>,</span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="dv">9</span>,</span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> SAFE,</span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>      <span class="at">label =</span> <span class="st">"Safe</span><span class="sc">\n</span><span class="st">Level"</span>,</span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>      <span class="at">color =</span> <span class="st">"red"</span></span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>()</span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a><span class="fu">site_boxplots</span>(wq_data, <span class="st">"Cleanest"</span>)</span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a><span class="fu">site_boxplots</span>(wq_data, <span class="st">"Dirtiest"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="cell quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="oyster_files/figure-html/cleanest sites-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="oyster_files/figure-html/dirtest_sites-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="lets-build-a-model" class="level2">
<h2 class="anchored" data-anchor-id="lets-build-a-model">Let’s Build a Model!</h2>
<p>Next to linear regression, random forests are one of the most popular machine learning algorithms. Random forests are a type of learning method, where multiple decision trees are trained on different subsets of the data and then combined to make a prediction. Since random forests can handle a mix of categorical and numeric variables they are ideal for our dataset. You can learn more about this class of models <a href="https://www.ibm.com/topics/random-forest">here</a>. The <code>tidymodels</code> suite of packages from <a href="https://posit.co/">posit.co</a> makes it easy to build and test a random forest model in R.</p>
<p>Models can easily <u>describe</u> any data set but we are interested in <u>predicting</u> out of sample data. To do this we need to split our data into a training set and a testing set. We will use the training set to build the model and the testing set to evaluate the model’s ability to predict. We have over 13,000 individual samples across all dates and sites. Our training set is a sort-of random sample of 75% of the data. I say “sort of” because we need stratify the split so that the same proportion of “SAFE”, “CAUTION” and “UNSAFE” samples are in both the training and testing sets.</p>
<p>At this point we are ready to set up the model. The tidymodels framework involves creating a workflow that starts with a model, then a “recipe” for preproccessing the data and finally a “fit” stage where the model is trained on the data. This framework makes it easy to try out different models and different recipes. We’ll use the random forest model in the <code>ranger</code> package. The recipe will normalize all the numeric variables. This will help with the skewness of the precipitation data.</p>
<p>Select data, add model, add recipe and fit. That’s it? Well, the coding is the easy part. In truth, there is a lot to think about in deciding what machine learning algorithm is best suited to the task, how to transform the inputs for imbalanced data and how to tune the model. The good news is the tidymodels framework makes it easy to experiment with different approaches. Check out the <a href="https://www.tidymodels.org/start/">tidymodels site</a> for a doorway to the rabbit hole of machine learning in R.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Model ------------------------------------------------------------------------</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co"># select only variables for model</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>wq_subset <span class="ot">&lt;-</span> wq_data <span class="sc">|&gt;</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># make year a category, rather than numeric</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">as.factor</span>(year)) <span class="sc">|&gt;</span> </span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    quality,</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    site_id,</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    year,</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    time_since_high_tide,</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># precip_t0,</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># precip_48,</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># precip_earlier,</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    precip_week,</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    water_body,</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    water_class,</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>    sewershed,</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>    lab</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># remove rows with missing values</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>()</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a><span class="co"># or...we could aggregate the precipitation data</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a><span class="co"># wq_subset &lt;- wq_subset |&gt;</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a><span class="co">#   #sum across all precip columns</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a><span class="co">#   mutate(precip_total = precip_t0 + precip_48 + precip_earlier) |&gt;</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a><span class="co">#   select(-c(precip_t0, precip_48, precip_earlier))</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a><span class="co"># seeding the random number generator ensures reproducibility</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a><span class="co"># split data into training and testing sets</span></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>wq_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(wq_subset, <span class="at">prop =</span> <span class="fl">0.75</span>, <span class="at">strata =</span> quality)</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>wq_train <span class="ot">&lt;-</span> <span class="fu">training</span>(wq_split)</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>wq_test <span class="ot">&lt;-</span> <span class="fu">testing</span>(wq_split)</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a><span class="co"># choose the model</span></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>wq_rf <span class="ot">&lt;-</span> <span class="fu">rand_forest</span>() <span class="sc">|&gt;</span></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"ranger"</span>,<span class="at">importance =</span> <span class="st">"impurity"</span>) <span class="sc">|&gt;</span></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"classification"</span>)</span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a><span class="co"># create a recipe</span></span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>wq_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(quality <span class="sc">~</span> ., <span class="at">data =</span> wq_train) <span class="sc">|&gt;</span></span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>())</span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a><span class="co"># combine into a workflow</span></span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>wq_wf <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">|&gt;</span></span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(wq_rf) <span class="sc">|&gt;</span></span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(wq_recipe)</span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a><span class="co"># fit with training data</span></span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>wq_fit<span class="ot">&lt;-</span> wq_wf <span class="sc">|&gt;</span></span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(<span class="at">data =</span> wq_train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Unlike linear regression, random forests are not easily interpretable. We can’t just look at the coefficients to see how each variable contributes to the prediction. After fitting to our training set, we can look at the variable importance plot. This plot shows the relative contribution of each variable to the prediction. Still, we don’t know the direction of the relationship or the strength of the relationship. We can only say that the variable is important in predicting the outcome.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># show variable importance</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>wq_fit <span class="sc">|&gt;</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_fit_parsnip</span>() <span class="sc">|&gt;</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  vip<span class="sc">::</span><span class="fu">vip</span>(<span class="at">aesthetics =</span> <span class="fu">list</span>(<span class="at">fill =</span> <span class="st">"lightblue"</span>)) <span class="sc">+</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Water Quality Variable Importance"</span>,</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">'Random Forest Classifier to Predict "Safe", "Caution" or "Unsafe '</span>) <span class="sc">+</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="oyster_files/figure-html/variable importance-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Rainfall looks to be the most important variable, followed by tide time and site location. Surprisingly, the sewershed and water body are far down the list. The more specific location factor, <code>site_id</code> contributes more. Again, this is not like linear regression, but if we look at the correlation of just rainfall and quality, there is some relation. This reinforces our intuition that CSOs are a driver of pollution.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>wq_subset <span class="sc">|&gt;</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">.by =</span> quality, <span class="at">median_precip =</span> <span class="fu">median</span>(precip_week)) <span class="sc">|&gt;</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(quality, median_precip)) <span class="sc">+</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">fill =</span> <span class="st">"lightblue"</span>) <span class="sc">+</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">"Median Weekly Precipitation by Water Quality"</span>,</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"More Rain, More Bacteria"</span>,</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Water Quality"</span>,</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Median Weekly Precipitation (inches)"</span>) <span class="sc">+</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="oyster_files/figure-html/rain vs bacteria-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>As noted above, we expect to get a good fit in-sample since we are really just describing the training set. The output of the the model is expressed as the liklihood each observation is from the “Safe”, “Caution” or “Unsafe” class. We can plot the predicted probability of each class for each observation. The plot below shows the predicted probability of each class for each observation in the training set. The color of the points indicates the actual class. The diagonal line is where the predicted probability equals the actual probability. The further the points are from the line, the less confident the model is in its prediction.</p>
<p>For example, in the chart below, the “SAFE” panel contains all the observations where the bacteria level is in the “SAFE” range. The dots in the lower right corner are the observations where the model is nearly certain of it’s prediction, 100% likely that the water is “SAFE” and 0% likely the water is “UNSAFE.” The balance of the dots are in the correct quadrant so our description of the training set is pretty good.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot prediction confidence</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>wq_pred_train <span class="ot">&lt;-</span> wq_fit <span class="sc">|&gt;</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">augment</span>(<span class="at">new_data =</span> wq_train)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>wq_pred_train <span class="sc">|&gt;</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> .pred_Safe, <span class="at">y =</span> .pred_Unsafe, <span class="at">color =</span> quality)) <span class="sc">+</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>quality) <span class="sc">+</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>() <span class="sc">+</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"green"</span>, <span class="st">"orange"</span>,<span class="st">"red"</span>)) <span class="sc">+</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Prediction Confidence"</span>,</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"It's easy to get a good fit in-sample."</span>,</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Probablility Actual Is Safe"</span>,</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Probablility Actual Is Unsafe"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="oyster_files/figure-html/plot fit for training set-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="is-the-model-any-good" class="level2">
<h2 class="anchored" data-anchor-id="is-the-model-any-good">Is the Model Any Good?</h2>
<p>Now let’s fit the model to the testing set and see how well it predicts the out-of-sample data. While the larger mass of points seems to be in the correct quadrants there are many observations where the model is very confident, but wrong.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot prediction confidence</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>wq_pred <span class="ot">&lt;-</span> wq_fit <span class="sc">|&gt;</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">augment</span>(<span class="at">new_data =</span> wq_test)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>xt <span class="ot">&lt;-</span> wq_pred <span class="sc">|&gt;</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">conf_mat</span>(<span class="at">truth =</span> quality, <span class="at">estimate =</span> .pred_class) <span class="sc">|&gt;</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># return just the confusion matrix</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pluck</span>(<span class="st">"table"</span>) <span class="sc">|&gt;</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Prediction) <span class="sc">|&gt;</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">.prop =</span> n<span class="sc">/</span><span class="fu">sum</span>(n)) <span class="sc">|&gt;</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>safe_risk <span class="ot">&lt;-</span> xt <span class="sc">|&gt;</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Prediction <span class="sc">==</span> <span class="st">"Safe"</span>,Truth <span class="sc">==</span> <span class="st">"Safe"</span>) <span class="sc">|&gt;</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(.prop) <span class="sc">|&gt;</span> <span class="fu">prod</span>(<span class="dv">100</span>) <span class="sc">|&gt;</span> <span class="fu">round</span>()</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>unsafe_risk <span class="ot">&lt;-</span> xt <span class="sc">|&gt;</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Prediction <span class="sc">==</span> <span class="st">"Safe"</span>,Truth <span class="sc">==</span> <span class="st">"Unsafe"</span>) <span class="sc">|&gt;</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(.prop) <span class="sc">|&gt;</span> <span class="fu">prod</span>(<span class="dv">100</span>) <span class="sc">|&gt;</span> <span class="fu">round</span>()</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>wq_pred <span class="sc">|&gt;</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> .pred_Safe, <span class="at">y =</span> .pred_Unsafe, <span class="at">color =</span> quality)) <span class="sc">+</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>quality) <span class="sc">+</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>() <span class="sc">+</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"green"</span>, <span class="st">"orange"</span>,<span class="st">"red"</span>)) <span class="sc">+</span></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Prediction Confidence"</span>,</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Many predictions are confidently wrong."</span>,</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Probablility Actual Is Safe"</span>,</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Probablility Actual Is Unsafe"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="oyster_files/figure-html/plot fit for test set-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can more precisely quantify the performance of the model with a “truth table.” Here we see the actual and predicted counts of each class. Given a prediction, how likely is it to be correct? 62% of the “SAFE” predictions were correct, but 18% of the times when the model said the water was “SAFE” if was actually “UNSAFE,” which is probably the most problematic result. Would I swim in “safe” water where there is a 18% chance I might get sick? No.&nbsp;The model also has very little ability to identify “CAUTION” conditions. In fairness, the range of bacteria levels between “SAFE” and “UNSAFE” is very narrow so we expect that only slight changes in conditions would tip the observation into another category.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># show a confusion matrix</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>xt <span class="ot">&lt;-</span> wq_pred <span class="sc">|&gt;</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">conf_mat</span>(<span class="at">truth =</span> quality, <span class="at">estimate =</span> .pred_class) <span class="sc">|&gt;</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># return just the confusion matrix</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pluck</span>(<span class="st">"table"</span>) <span class="sc">|&gt;</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Prediction) <span class="sc">|&gt;</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">.prop =</span> n<span class="sc">/</span><span class="fu">sum</span>(n)) <span class="sc">|&gt;</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>xt_count <span class="ot">&lt;-</span> xt <span class="sc">|&gt;</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>.prop) <span class="sc">|&gt;</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> Truth,<span class="at">values_from =</span> n) <span class="sc">|&gt;</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">|&gt;</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Total =</span> <span class="fu">sum</span>(<span class="fu">c</span>(Safe,Caution,Unsafe)))</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>gt_domain <span class="ot">&lt;-</span> xt_count <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-</span>Total,<span class="sc">-</span>Prediction) <span class="sc">|&gt;</span> <span class="fu">max</span>()</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>xt_prop <span class="ot">&lt;-</span> xt <span class="sc">|&gt;</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>n) <span class="sc">|&gt;</span></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> Truth,<span class="at">values_from =</span> .prop) <span class="sc">|&gt;</span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">|&gt;</span></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Total =</span> <span class="fu">sum</span>(<span class="fu">c</span>(Safe,Caution,Unsafe)))</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>truth_table <span class="ot">&lt;-</span> <span class="cf">function</span>(xt,<span class="at">type =</span> <span class="fu">c</span>(<span class="st">"count"</span>)){</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>  gt_xt <span class="ot">&lt;-</span> xt <span class="sc">|&gt;</span></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">gt</span>(<span class="at">rowname_col =</span> <span class="st">"Prediction"</span>) <span class="sc">|&gt;</span></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tab_header</span>(<span class="at">title =</span> <span class="st">"Truth Table"</span>) <span class="sc">|&gt;</span></span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tab_spanner</span>(<span class="at">label =</span> <span class="st">"Truth"</span>, <span class="at">columns =</span> <span class="fu">where</span>(is.numeric)) <span class="sc">|&gt;</span></span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># add stub header label</span></span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tab_stubhead</span>(<span class="at">label =</span> <span class="st">"Prediction"</span>)</span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(type <span class="sc">==</span> <span class="st">"prop"</span>){</span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>    gt_xt <span class="ot">&lt;-</span> gt_xt <span class="sc">|&gt;</span> <span class="fu">fmt_percent</span>(<span class="at">columns =</span> <span class="fu">where</span>(is.numeric),<span class="at">decimals =</span> <span class="dv">0</span>)</span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>    gt_xt <span class="ot">&lt;-</span> gt_xt <span class="sc">|&gt;</span> <span class="fu">fmt_number</span>(<span class="at">columns =</span> <span class="fu">where</span>(is.numeric),<span class="at">decimals =</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>      <span class="fu">grand_summary_rows</span>(</span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>        <span class="at">fns =</span> <span class="fu">list</span>(<span class="at">id=</span><span class="st">"Total"</span>,<span class="at">label =</span> <span class="st">"Total"</span>) <span class="sc">~</span> <span class="fu">sum</span>(.)</span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tab_style</span>(</span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a>        <span class="at">style =</span> <span class="fu">cell_text</span>(<span class="at">weight =</span> <span class="st">"bold"</span>),</span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a>        <span class="at">locations =</span> <span class="fu">list</span>(<span class="fu">cells_stub_grand_summary</span>(<span class="at">rows =</span> <span class="st">"Total"</span>))</span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a>  <span class="co"># fmt_number(columns = where(is.numeric),decimals = 0) |&gt;</span></span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a>  <span class="co"># fmt_percent(columns = where(is.numeric),decimals = 0) |&gt;</span></span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a>  <span class="co"># color the cells with a heat map</span></span>
<span id="cb15-51"><a href="#cb15-51" aria-hidden="true" tabindex="-1"></a>  gt_xt <span class="ot">&lt;-</span> gt_xt <span class="sc">|&gt;</span></span>
<span id="cb15-52"><a href="#cb15-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data_color</span>(<span class="at">columns =</span> <span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>,</span>
<span id="cb15-53"><a href="#cb15-53" aria-hidden="true" tabindex="-1"></a>               <span class="at">direction =</span> <span class="fu">c</span>(<span class="st">"row"</span>),</span>
<span id="cb15-54"><a href="#cb15-54" aria-hidden="true" tabindex="-1"></a>               <span class="at">domain =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="fu">if_else</span>(type <span class="sc">==</span> <span class="st">"count"</span>,gt_domain,<span class="dv">1</span>)),</span>
<span id="cb15-55"><a href="#cb15-55" aria-hidden="true" tabindex="-1"></a>               <span class="at">method =</span> <span class="st">"numeric"</span>,</span>
<span id="cb15-56"><a href="#cb15-56" aria-hidden="true" tabindex="-1"></a>               <span class="at">palette =</span> <span class="st">"Blues"</span>) <span class="sc">|&gt;</span></span>
<span id="cb15-57"><a href="#cb15-57" aria-hidden="true" tabindex="-1"></a>    <span class="co"># color prediction labels</span></span>
<span id="cb15-58"><a href="#cb15-58" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tab_style</span>(</span>
<span id="cb15-59"><a href="#cb15-59" aria-hidden="true" tabindex="-1"></a>      <span class="at">style =</span> <span class="fu">list</span>(<span class="fu">cell_fill</span>(<span class="at">color =</span> <span class="st">"green"</span>),<span class="fu">cell_text</span>(<span class="at">color =</span> <span class="st">"black"</span>)),</span>
<span id="cb15-60"><a href="#cb15-60" aria-hidden="true" tabindex="-1"></a>      <span class="at">locations =</span> <span class="fu">list</span>(<span class="fu">cells_column_labels</span>(<span class="st">"Safe"</span>),</span>
<span id="cb15-61"><a href="#cb15-61" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">cells_body</span>(<span class="at">column =</span> <span class="dv">1</span>,<span class="at">row =</span> <span class="dv">1</span>))</span>
<span id="cb15-62"><a href="#cb15-62" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb15-63"><a href="#cb15-63" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tab_style</span>(</span>
<span id="cb15-64"><a href="#cb15-64" aria-hidden="true" tabindex="-1"></a>      <span class="at">style =</span> <span class="fu">list</span>(<span class="fu">cell_fill</span>(<span class="at">color =</span> <span class="st">"yellow"</span>),<span class="fu">cell_text</span>(<span class="at">color =</span> <span class="st">"blaCk"</span>)),</span>
<span id="cb15-65"><a href="#cb15-65" aria-hidden="true" tabindex="-1"></a>      <span class="at">locations =</span> <span class="fu">list</span>(<span class="fu">cells_column_labels</span>(<span class="st">"Caution"</span>),</span>
<span id="cb15-66"><a href="#cb15-66" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">cells_body</span>(<span class="at">column =</span> <span class="dv">1</span>,<span class="at">row =</span> <span class="dv">2</span>))</span>
<span id="cb15-67"><a href="#cb15-67" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb15-68"><a href="#cb15-68" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tab_style</span>(</span>
<span id="cb15-69"><a href="#cb15-69" aria-hidden="true" tabindex="-1"></a>      <span class="at">style =</span> <span class="fu">list</span>(<span class="fu">cell_fill</span>(<span class="at">color =</span> <span class="st">"red"</span>),<span class="fu">cell_text</span>(<span class="at">color =</span> <span class="st">"white"</span>)),</span>
<span id="cb15-70"><a href="#cb15-70" aria-hidden="true" tabindex="-1"></a>      <span class="at">locations =</span> <span class="fu">list</span>(<span class="fu">cells_column_labels</span>(<span class="st">"Unsafe"</span>),</span>
<span id="cb15-71"><a href="#cb15-71" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">cells_body</span>(<span class="at">column =</span> <span class="dv">1</span>,<span class="at">row =</span> <span class="dv">3</span>))</span>
<span id="cb15-72"><a href="#cb15-72" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb15-73"><a href="#cb15-73" aria-hidden="true" tabindex="-1"></a>    <span class="co"># color Truth labels</span></span>
<span id="cb15-74"><a href="#cb15-74" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tab_style</span>(</span>
<span id="cb15-75"><a href="#cb15-75" aria-hidden="true" tabindex="-1"></a>      <span class="at">style =</span> <span class="fu">list</span>(<span class="fu">cell_fill</span>(<span class="at">color =</span> <span class="st">"green"</span>),<span class="fu">cell_text</span>(<span class="at">color =</span> <span class="st">"black"</span>)),</span>
<span id="cb15-76"><a href="#cb15-76" aria-hidden="true" tabindex="-1"></a>      <span class="at">locations =</span> <span class="fu">cells_stub</span>(<span class="st">"Safe"</span>)</span>
<span id="cb15-77"><a href="#cb15-77" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb15-78"><a href="#cb15-78" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tab_style</span>(</span>
<span id="cb15-79"><a href="#cb15-79" aria-hidden="true" tabindex="-1"></a>      <span class="at">style =</span> <span class="fu">list</span>(<span class="fu">cell_fill</span>(<span class="at">color =</span> <span class="st">"yellow"</span>),<span class="fu">cell_text</span>(<span class="at">color =</span> <span class="st">"black"</span>)),</span>
<span id="cb15-80"><a href="#cb15-80" aria-hidden="true" tabindex="-1"></a>      <span class="at">locations =</span> <span class="fu">cells_stub</span>(<span class="st">"Caution"</span>)</span>
<span id="cb15-81"><a href="#cb15-81" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb15-82"><a href="#cb15-82" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tab_style</span>(</span>
<span id="cb15-83"><a href="#cb15-83" aria-hidden="true" tabindex="-1"></a>      <span class="at">style =</span> <span class="fu">list</span>(<span class="fu">cell_fill</span>(<span class="at">color =</span> <span class="st">"red"</span>),<span class="fu">cell_text</span>(<span class="at">color =</span> <span class="st">"white"</span>)),</span>
<span id="cb15-84"><a href="#cb15-84" aria-hidden="true" tabindex="-1"></a>      <span class="at">locations =</span> <span class="fu">cells_stub</span>(<span class="st">"Unsafe"</span>)</span>
<span id="cb15-85"><a href="#cb15-85" aria-hidden="true" tabindex="-1"></a>    )  <span class="sc">|&gt;</span></span>
<span id="cb15-86"><a href="#cb15-86" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tab_style</span>(</span>
<span id="cb15-87"><a href="#cb15-87" aria-hidden="true" tabindex="-1"></a>      <span class="at">style =</span> <span class="fu">cell_text</span>(<span class="at">weight =</span> <span class="st">"bold"</span>),</span>
<span id="cb15-88"><a href="#cb15-88" aria-hidden="true" tabindex="-1"></a>      <span class="at">locations =</span> <span class="fu">list</span>(<span class="fu">cells_body</span>(<span class="at">columns =</span> <span class="dv">1</span>),</span>
<span id="cb15-89"><a href="#cb15-89" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">cells_column_labels</span>(),</span>
<span id="cb15-90"><a href="#cb15-90" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">cells_column_spanners</span>(),</span>
<span id="cb15-91"><a href="#cb15-91" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">cells_title</span>(),</span>
<span id="cb15-92"><a href="#cb15-92" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">cells_stub</span>(),</span>
<span id="cb15-93"><a href="#cb15-93" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">cells_stubhead</span>())</span>
<span id="cb15-94"><a href="#cb15-94" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb15-95"><a href="#cb15-95" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(gt_xt)</span>
<span id="cb15-96"><a href="#cb15-96" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-97"><a href="#cb15-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-98"><a href="#cb15-98" aria-hidden="true" tabindex="-1"></a>roc <span class="ot">&lt;-</span> wq_pred <span class="sc">|&gt;</span></span>
<span id="cb15-99"><a href="#cb15-99" aria-hidden="true" tabindex="-1"></a>  <span class="fu">roc_auc</span>(<span class="at">truth =</span> quality, .pred_Safe,.pred_Caution,.pred_Unsafe)</span>
<span id="cb15-100"><a href="#cb15-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-101"><a href="#cb15-101" aria-hidden="true" tabindex="-1"></a><span class="fu">truth_table</span>(xt_prop,<span class="st">"prop"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="whyaylitys" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#whyaylitys table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#whyaylitys thead, #whyaylitys tbody, #whyaylitys tfoot, #whyaylitys tr, #whyaylitys td, #whyaylitys th {
  border-style: none;
}

#whyaylitys p {
  margin: 0;
  padding: 0;
}

#whyaylitys .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#whyaylitys .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#whyaylitys .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#whyaylitys .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#whyaylitys .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#whyaylitys .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#whyaylitys .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#whyaylitys .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#whyaylitys .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#whyaylitys .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#whyaylitys .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#whyaylitys .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#whyaylitys .gt_spanner_row {
  border-bottom-style: hidden;
}

#whyaylitys .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#whyaylitys .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#whyaylitys .gt_from_md > :first-child {
  margin-top: 0;
}

#whyaylitys .gt_from_md > :last-child {
  margin-bottom: 0;
}

#whyaylitys .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#whyaylitys .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#whyaylitys .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#whyaylitys .gt_row_group_first td {
  border-top-width: 2px;
}

#whyaylitys .gt_row_group_first th {
  border-top-width: 2px;
}

#whyaylitys .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#whyaylitys .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#whyaylitys .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#whyaylitys .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#whyaylitys .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#whyaylitys .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#whyaylitys .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#whyaylitys .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#whyaylitys .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#whyaylitys .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#whyaylitys .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#whyaylitys .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#whyaylitys .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#whyaylitys .gt_left {
  text-align: left;
}

#whyaylitys .gt_center {
  text-align: center;
}

#whyaylitys .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#whyaylitys .gt_font_normal {
  font-weight: normal;
}

#whyaylitys .gt_font_bold {
  font-weight: bold;
}

#whyaylitys .gt_font_italic {
  font-style: italic;
}

#whyaylitys .gt_super {
  font-size: 65%;
}

#whyaylitys .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#whyaylitys .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#whyaylitys .gt_indent_1 {
  text-indent: 5px;
}

#whyaylitys .gt_indent_2 {
  text-indent: 10px;
}

#whyaylitys .gt_indent_3 {
  text-indent: 15px;
}

#whyaylitys .gt_indent_4 {
  text-indent: 20px;
}

#whyaylitys .gt_indent_5 {
  text-indent: 25px;
}

#whyaylitys .katex-display {
  display: inline-flex !important;
  margin-bottom: 0.75em !important;
}

#whyaylitys div.Reactable > div.rt-table > div.rt-thead > div.rt-tr.rt-tr-group-header > div.rt-th-group:after {
  height: 0px !important;
}
</style>

<table class="gt_table caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<colgroup>
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
</colgroup>
<thead>
<tr class="header gt_heading">
<th colspan="5" class="gt_heading gt_title gt_font_normal gt_bottom_border" style="font-weight: bold">Truth Table</th>
</tr>
<tr class="odd gt_col_headings gt_spanner_row">
<th rowspan="2" id="a::stub" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="font-weight: bold" scope="col">Prediction</th>
<th colspan="4" id="Truth" class="gt_center gt_columns_top_border gt_column_spanner_outer" data-quarto-table-cell-role="th" style="font-weight: bold" scope="colgroup"><div class="gt_column_spanner">
Truth
</div></th>
</tr>
<tr class="header gt_col_headings">
<th id="Safe" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" style="background-color: #00FF00; color: #000000; font-weight: bold" scope="col">Safe</th>
<th id="Caution" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" style="background-color: #FFFF00; color: #000000; font-weight: bold" scope="col">Caution</th>
<th id="Unsafe" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" style="background-color: #FF0000; color: #FFFFFF; font-weight: bold" scope="col">Unsafe</th>
<th id="Total" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" style="font-weight: bold" scope="col">Total</th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td id="stub_1_1" class="gt_row gt_left gt_stub" data-quarto-table-cell-role="th" scope="row" style="background-color: #00FF00; color: #000000; font-weight: bold">Safe</td>
<td class="gt_row gt_right" headers="stub_1_1 Safe" style="background-color: #4493C7; color: #FFFFFF">62%</td>
<td class="gt_row gt_right" headers="stub_1_1 Caution" style="background-color: #D0E2F2; color: #000000">20%</td>
<td class="gt_row gt_right" headers="stub_1_1 Unsafe" style="background-color: #D3E3F3; color: #000000">18%</td>
<td class="gt_row gt_right" headers="stub_1_1 Total">100%</td>
</tr>
<tr class="even">
<td id="stub_1_2" class="gt_row gt_left gt_stub" data-quarto-table-cell-role="th" scope="row" style="background-color: #FFFF00; color: #000000; font-weight: bold">Caution</td>
<td class="gt_row gt_right" headers="stub_1_2 Safe" style="background-color: #94C4DF; color: #000000">40%</td>
<td class="gt_row gt_right" headers="stub_1_2 Caution" style="background-color: #BAD6EB; color: #000000">29%</td>
<td class="gt_row gt_right" headers="stub_1_2 Unsafe" style="background-color: #B3D3E8; color: #000000">31%</td>
<td class="gt_row gt_right" headers="stub_1_2 Total">100%</td>
</tr>
<tr class="odd">
<td id="stub_1_3" class="gt_row gt_left gt_stub" data-quarto-table-cell-role="th" scope="row" style="background-color: #FF0000; color: #FFFFFF; font-weight: bold">Unsafe</td>
<td class="gt_row gt_right" headers="stub_1_3 Safe" style="background-color: #D6E6F4; color: #000000">17%</td>
<td class="gt_row gt_right" headers="stub_1_3 Caution" style="background-color: #D4E4F4; color: #000000">18%</td>
<td class="gt_row gt_right" headers="stub_1_3 Unsafe" style="background-color: #3B89C2; color: #FFFFFF">66%</td>
<td class="gt_row gt_right" headers="stub_1_3 Total">100%</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Another common way to visualize the performance of a model is with a “receiver operator characteristic” (ROC) curve. The ROC curve shows the trade off between true positives and false positives for each class. The larger the area under the curves (AUC), the better the model. An AUC of 1.0 is perfect while 0.5 is what random chance would show. In our case we have a combined AUC of 0.73, which is better than useless but not great.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot a ROC curve</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>wq_pred <span class="sc">|&gt;</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">roc_curve</span>(<span class="at">truth =</span> quality, .pred_Safe,.pred_Caution,.pred_Unsafe) <span class="sc">|&gt;</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="dv">1</span> <span class="sc">-</span> specificity, <span class="at">y =</span> sensitivity,<span class="at">color=</span>.level)) <span class="sc">+</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_path</span>() <span class="sc">+</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"orange"</span>,<span class="st">"green"</span>,<span class="st">"red"</span>)) <span class="sc">+</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">lty =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>() <span class="sc">+</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"ROC Curve"</span>,</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"All Three Water Classifications"</span>,</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"False Positive Rate"</span>,</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"True Positive Rate"</span>,</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Classification"</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="oyster_files/figure-html/plot ROC-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can easily tweak this model. Looking at rainfall as separate daily factors improves the truth table slightly but masks rainfall as the most important factor. We can quickly visualize the difference using the ROC. Splitting rainfall into three separate time windows rather than the full week improves the model slightly.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># select only variables for model</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>wq_subset_2 <span class="ot">&lt;-</span> wq_data <span class="sc">|&gt;</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># make year a category, rather than numeric</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">as.factor</span>(year)) <span class="sc">|&gt;</span> </span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    quality,</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    site_id,</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    year,</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    time_since_high_tide,</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    precip_t0,</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    precip_48,</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    precip_earlier,</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># precip_week,</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    water_body,</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    water_class,</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    sewershed,</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>    lab</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># remove rows with missing values</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>()</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a><span class="co"># or...we could aggregate the precipitation data</span></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a><span class="co"># wq_subset &lt;- wq_subset |&gt;</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a><span class="co">#   #sum across all precip columns</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a><span class="co">#   mutate(precip_total = precip_t0 + precip_48 + precip_earlier) |&gt;</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a><span class="co">#   select(-c(precip_t0, precip_48, precip_earlier))</span></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a><span class="co"># seeding the random number generator ensures reproducibility</span></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a><span class="co"># split data into training and testing sets</span></span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>wq_split_2 <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(wq_subset_2, <span class="at">prop =</span> <span class="fl">0.75</span>, <span class="at">strata =</span> quality)</span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>wq_train_2 <span class="ot">&lt;-</span> <span class="fu">training</span>(wq_split_2)</span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>wq_test_2 <span class="ot">&lt;-</span> <span class="fu">testing</span>(wq_split_2)</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a><span class="co"># choose the model</span></span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>wq_rf_2 <span class="ot">&lt;-</span> <span class="fu">rand_forest</span>() <span class="sc">|&gt;</span></span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"ranger"</span>,<span class="at">importance =</span> <span class="st">"impurity"</span>) <span class="sc">|&gt;</span></span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"classification"</span>)</span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a><span class="co"># create a recipe</span></span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>wq_recipe_2 <span class="ot">&lt;-</span> <span class="fu">recipe</span>(quality <span class="sc">~</span> ., <span class="at">data =</span> wq_train_2) <span class="sc">|&gt;</span></span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>())</span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a><span class="co"># combine into a workflow</span></span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>wq_wf_2 <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">|&gt;</span></span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(wq_rf_2) <span class="sc">|&gt;</span></span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(wq_recipe_2)</span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a><span class="co"># fit with training data</span></span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a>wq_fit_2<span class="ot">&lt;-</span> wq_wf_2 <span class="sc">|&gt;</span></span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(<span class="at">data =</span> wq_train_2)</span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a>wq_pred_2 <span class="ot">&lt;-</span> wq_fit_2 <span class="sc">|&gt;</span></span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">augment</span>(<span class="at">new_data =</span> wq_test_2)</span>
<span id="cb17-55"><a href="#cb17-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-56"><a href="#cb17-56" aria-hidden="true" tabindex="-1"></a><span class="co"># plot a ROC curve</span></span>
<span id="cb17-57"><a href="#cb17-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-58"><a href="#cb17-58" aria-hidden="true" tabindex="-1"></a>rc1 <span class="ot">&lt;-</span> wq_pred <span class="sc">|&gt;</span></span>
<span id="cb17-59"><a href="#cb17-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">roc_curve</span>(<span class="at">truth =</span> quality, .pred_Safe,.pred_Caution,.pred_Unsafe) <span class="sc">|&gt;</span> </span>
<span id="cb17-60"><a href="#cb17-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(.level <span class="sc">==</span> <span class="st">"Unsafe"</span>)<span class="sc">|&gt;</span> </span>
<span id="cb17-61"><a href="#cb17-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">.level =</span> <span class="st">"Single Full Week Precip Factor"</span>)</span>
<span id="cb17-62"><a href="#cb17-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-63"><a href="#cb17-63" aria-hidden="true" tabindex="-1"></a>rc2 <span class="ot">&lt;-</span> wq_pred_2 <span class="sc">|&gt;</span></span>
<span id="cb17-64"><a href="#cb17-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">roc_curve</span>(<span class="at">truth =</span> quality, .pred_Safe,.pred_Caution,.pred_Unsafe) <span class="sc">|&gt;</span> </span>
<span id="cb17-65"><a href="#cb17-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(.level <span class="sc">==</span> <span class="st">"Unsafe"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb17-66"><a href="#cb17-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">.level =</span> <span class="st">"3 Precip Factors"</span>)</span>
<span id="cb17-67"><a href="#cb17-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-68"><a href="#cb17-68" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_rows</span>(rc1, rc2) <span class="sc">|&gt;</span></span>
<span id="cb17-69"><a href="#cb17-69" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(</span>
<span id="cb17-70"><a href="#cb17-70" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="dv">1</span> <span class="sc">-</span> specificity,</span>
<span id="cb17-71"><a href="#cb17-71" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> sensitivity,</span>
<span id="cb17-72"><a href="#cb17-72" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> .level</span>
<span id="cb17-73"><a href="#cb17-73" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">+</span></span>
<span id="cb17-74"><a href="#cb17-74" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_path</span>() <span class="sc">+</span></span>
<span id="cb17-75"><a href="#cb17-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">lty =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb17-76"><a href="#cb17-76" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb17-77"><a href="#cb17-77" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Effect of Feature Choices on Accuracy"</span>,</span>
<span id="cb17-78"><a href="#cb17-78" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">'ROC Curve for "SAFE" class only'</span>,</span>
<span id="cb17-79"><a href="#cb17-79" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"False Positive Rate"</span>,</span>
<span id="cb17-80"><a href="#cb17-80" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"True Positive Rate"</span>,</span>
<span id="cb17-81"><a href="#cb17-81" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Features Choice"</span></span>
<span id="cb17-82"><a href="#cb17-82" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb17-83"><a href="#cb17-83" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>() <span class="sc">+</span></span>
<span id="cb17-84"><a href="#cb17-84" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="oyster_files/figure-html/alt feature set-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>There are other metrics we could use but you get the idea. We could also tune the model to see if we could improve the performance, but in this case I found it did not help much so I don’t include it. Refer to the tidymodels site for tuning tips and more performance statistics.</p>
<p>We could also look for other variables not present in the BOP data set that might be useful. I’ve looked at imputing tidal current and including daily temperature. Neither made much of a difference. You can see <a href="https://github.com/apsteinmetz/oyster">these experiments on Github</a>. They include techniques for downloading tide and weather data from the NOAA and matching NOAA stations to water sampling stations.</p>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>In this project we’ve seen how easy it is to build a powerful machine learning model using the <code>tidymodels</code> tools. As citizen scientists we were able to gather and use publicly available data to gain insight into the factors influencing water quality in New York Harbor. We’ve also learned about how important oysters were to the city in days past and can dream about a day (alas, not likely in our lifetimes) when oysters “as big as dinner plates” are once again living in the harbor.</p>
<p>Don’t forget to check out <a href="https://www.billionoysterproject.org/">The Billion Oyster Project</a>. They have lot’s of ways to contribute!</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = true;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/outsiderdata\.netlify\.app\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://utteranc.es/client.js" repo="apsteinmetz/blog_outsider" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->




</body></html>