<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>Outsider Data Science</title>
<link>https://outsiderdata.netlify.app/</link>
<atom:link href="https://outsiderdata.netlify.app/index.xml" rel="self" type="application/rss+xml"/>
<description>Putting what&#39;s in there, out there. With R!</description>
<generator>quarto-1.4.549</generator>
<lastBuildDate>Sun, 10 Mar 2024 05:00:00 GMT</lastBuildDate>
<item>
  <title>The Truth About Tidy Wrappers</title>
  <dc:creator>Art Steinmetz</dc:creator>
  <link>https://outsiderdata.netlify.app/posts/2024-03-10-the-truth-about-tidy-wrappers/</link>
  <description><![CDATA[ 




<p>These are the packages we will need for this analysis.</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(data.table)</span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dtplyr)</span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(duckdb)</span>
<span id="cb1-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(duckplyr)</span>
<span id="cb1-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(polars)</span>
<span id="cb1-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidypolars)</span>
<span id="cb1-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(arrow)</span>
<span id="cb1-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tictoc)</span>
<span id="cb1-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(microbenchmark)</span>
<span id="cb1-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(gt)</span></code></pre></div>
<section id="the-tidyverse" class="level2">
<h2 class="anchored" data-anchor-id="the-tidyverse">The Tidyverse</h2>
<p>I love the <strong>Tidyverse</strong> from <a href="https://posit.co/">Posit.co</a>. The biggest evolution of the R language ecosystem since its inception was the introduction of <strong>dplyr</strong> and, subsequently, dozens of related packages. <strong>dplyr</strong> established what is, in effect, a new vernacular for manipulating data frames that is supremely readable. This is not welcome by everyone as verbosity is preferred in the Tidyverse over conciseness. Consider two snippets of code that summarize a column of numbers, the first in base R and the second using dplyr.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># base R</span></span>
<span id="cb2-2">do_base <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(df) {</span>
<span id="cb2-3">   agg_lines <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aggregate</span>(temp <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> city, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> df,</span>
<span id="cb2-4">                          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">FUN =</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(x) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(x),<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">high=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(x),<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">low=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(x)))</span>
<span id="cb2-5">   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># convert matrix column to data frame columns</span></span>
<span id="cb2-6">   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">city=</span>agg_lines<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>city,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(agg_lines<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>temp))</span>
<span id="cb2-7">}</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># dplyr </span></span>
<span id="cb3-2">do_dplyr <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(df) {</span>
<span id="cb3-3">   df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb3-4">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb3-5">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(city) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb3-6">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">high =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(temp), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">low =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(temp), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(temp))</span>
<span id="cb3-7">   }</span></code></pre></div>
</div>
<p>The first example is hard to decipher while the second is quite understandable without even knowing what the purpose of the function is. As it happens, <strong>dplyr</strong> is also usually faster than base R by a fair amount.</p>
</section>
<section id="the-need-for-speed" class="level2">
<h2 class="anchored" data-anchor-id="the-need-for-speed">The Need for Speed</h2>
<p>As we start working with larger and larger datasets, the basic tools of the tidyverse start to look a little slow. In the last few years several packages more suited to large datasets have emerged. Some of these are column, rather than row, oriented. Some use parallel processing. Some are vector optimized. Speedy databases that have made their way into the R ecosystem are <strong>data.table</strong>, <strong>arrow</strong>, <strong>polars</strong> and <strong>duckdb</strong>. All of these are available for Python as well. Each of these carries with it its own interface and learning curve. <strong>duckdb</strong>, for example is a dialect of SQL, an entirely different language so our <strong>dplyr</strong> code above has to look like this in SQL:</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">result <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbGetQuery</span>(</span>
<span id="cb4-2">         con,</span>
<span id="cb4-3">         <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"SELECT city, AVG(temp) as avg, MIN(temp) as low, MAX(temp) as high FROM duck_df GROUP BY city"</span>)</span></code></pre></div>
<p>It’s pretty readable but if you don’t know the lingo, translating will slow you down. Fear not! Help is at hand. Everyone of these database packages has a <strong>dplyr</strong> vernacular wrapper. This is a huge convenience. You can write the readable <strong>dplyr</strong> code and it just works. Switching between and testing all of these databases requires only minor changes in your code.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Future code snippets in this article are hidden by default. Click on the “Code” button wherever you see it to make source code visible.</p>
</div>
</div>
<p>When looking at these alt-databases you may be tempted to simply ask “which is fastest?” This is not a simple question. The answer will depend on the size of the dataset, the nature of the manipulations, and the hardware you are using. You can get a sense of the relative speeds by looking at <a href="https://duckdblabs.github.io/db-benchmark/">these comprehensive benchmarks</a>.</p>
<p>If you want to continue to use the <strong>tidyverse</strong> vernacular, the question changes. <strong>It’s not “which is fastest,” but “which is fastest using the dplyr syntax?”</strong> The answer, as it turns out, is very different for the second question.</p>
<p>The <strong>dplyr</strong> wrappers are not a free lunch. There are two sources of overhead that mean the <strong>dplyr</strong> code should be slightly slower than using the native interface. First, the dataset, which might start out as a typical R data frame, must be converted into the target database format. Second, some time must be taken to convert the <strong>dplyr</strong> code to the target database code. Obviously, if your dataset is already in the file format of the database package, the first issue goes away.</p>
<p>In this experiment we will address three questions.</p>
<ol type="1">
<li>How much faster (if at all) are the “alt-database” packages than the Tidyverse <strong>dplyr</strong> package. We use the native data frame format throughout the pipeline.</li>
<li>How much of a performance hit do we take if we use the Tidyverse wrappers to analyze alt-database data sets, still using the native format.</li>
<li>Suppose we want to work with Tidyverse R data frames (e.g.&nbsp;<strong>tibbles</strong>). Do the alt-database engines still give us a speed benefit if we include the time to convert <strong>tibble</strong>s into an alt-database format before doing typical manipulations.</li>
</ol>
<p>The inspiration for this project came from the “Billion Row Challenge,” <a href="https://www.morling.dev/blog/one-billion-row-challenge/">proposed by Gunnar Morling</a>, to see how fast a Java program can aggregate one billion rows of data. Here, we are not interested in absolute speed, but relative speed among different approaches. 100 million rows should be reasonable for a typical laptop setup. This works out to be a 1.5 GB dataset. We will handle the dataset as one object. If we were optimizing for speed, chopping the data into chunks for parallel processing would be something to try (but see the discussion of <strong>polars</strong>, below).</p>
<p>As a cautionary note, the manipulations we are doing, grouping and summarizing, may or may not show off any particular approach to its best advantage. Your mileage may vary. Feel free to quibble.</p>
</section>
<section id="make-the-data-set" class="level2">
<h2 class="anchored" data-anchor-id="make-the-data-set">Make the Data Set</h2>
<p>Let’s start by creating the dummy data set, a list of temperature observations for World cities. The core will be actual mean annual temperature for about 400 cities from Wikipedia. Save this data for re-use. Then we randomly add observations around the mean, up to the desired size, 100 million in this case. It’s all fake data, anyway. First, scrape the cities and temperatures from Wikipedia. Be aware that Wikipedia page layouts change frequently so what worked today (March, 2024) might not work tomorrow.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (fs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file_exists</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'data/weather_stations.csv'</span>)){</span>
<span id="cb5-2">   city_table <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_csv</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/weather_stations.csv"</span>,</span>
<span id="cb5-3">                          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">show_col_types =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)</span>
<span id="cb5-4">} <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> {</span>
<span id="cb5-5">   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># retrieve table from https://en.wikipedia.org/wiki/List_of_cities_by_average_temperature using rvest package</span></span>
<span id="cb5-6">   continents <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span></span>
<span id="cb5-7">   url <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span></span>
<span id="cb5-8">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://en.wikipedia.org/wiki/List_of_cities_by_average_temperature"</span></span>
<span id="cb5-9">   webpage <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_html</span>(url)</span>
<span id="cb5-10">   city_table <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">html_nodes</span>(webpage, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"table"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb5-11">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">html_table</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb5-12">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_rows</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb5-13">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb5-14">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>Ref.) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb5-15">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># remove all numbers in parentheses from all columns using across() and str_remove()</span></span>
<span id="cb5-16">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">everything</span>(), \(x) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_remove_all</span>(x, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">(.*</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">)"</span>))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb5-17">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># mutate to numeric all columns except City and Country</span></span>
<span id="cb5-18">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(City, Country), as.numeric)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb5-19">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># remove all rows with NA values</span></span>
<span id="cb5-20">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">drop_na</span>()</span>
<span id="cb5-21">   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># write the table to a csv file</span></span>
<span id="cb5-22">   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_csv</span>(city_table, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/weather_stations.csv"</span>)</span>
<span id="cb5-23">}</span></code></pre></div>
</details>
</div>
<p>Its easy to generate 100 million random observations based on the city name and average temperature. You don’t need to use real city names, but it’s fun to do so. You could make up anything.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define function to generate weather station data</span></span>
<span id="cb6-2"></span>
<span id="cb6-3">generate_observations <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(n){</span>
<span id="cb6-4">   rownum <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(city_table), n, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb6-5">   city <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> city_table<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>City[rownum]</span>
<span id="cb6-6">   obs_temp <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(n, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mean =</span> city_table<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Year[rownum], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sd =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb6-7">   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">city =</span> city, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">temp =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(obs_temp, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)))</span>
<span id="cb6-8">}</span>
<span id="cb6-9"></span>
<span id="cb6-10">tidy_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">generate_observations</span>(num_records)</span></code></pre></div>
</details>
</div>
<p>Now we can process this data set using each of the database packages using both the native interface and the <strong>dplyr</strong> wrapper. We want to know which database is fastest and what the performance loss is from using the wrapper. First let’s establish that base R is not in the running by comparing it to the default of <strong>dplyr</strong>, using the code already shown above and a subset of the data.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#quicky function to clean up benchmark results.  Show only median seconds to process.</span></span>
<span id="cb7-2">qbench <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(mb_result,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">round=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>){</span>
<span id="cb7-3">   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># extract the median time in seconds</span></span>
<span id="cb7-4">   mb_result <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb7-5">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(expr) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb7-6">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">seconds =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median</span>(time)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e9</span>,round))</span>
<span id="cb7-7">}</span>
<span id="cb7-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">microbenchmark</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">do_base</span>(tidy_df[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e7</span>,]),<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">do_dplyr</span>(tidy_df[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e7</span>,]),<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">unit =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"seconds"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb7-9">   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">qbench</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb7-10">   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gt</span>()</span></code></pre></div>
</details>
<div class="cell-output-display">
<div id="ozebixrrfv" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#ozebixrrfv table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#ozebixrrfv thead, #ozebixrrfv tbody, #ozebixrrfv tfoot, #ozebixrrfv tr, #ozebixrrfv td, #ozebixrrfv th {
  border-style: none;
}

#ozebixrrfv p {
  margin: 0;
  padding: 0;
}

#ozebixrrfv .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#ozebixrrfv .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#ozebixrrfv .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#ozebixrrfv .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#ozebixrrfv .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#ozebixrrfv .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#ozebixrrfv .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#ozebixrrfv .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#ozebixrrfv .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#ozebixrrfv .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#ozebixrrfv .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#ozebixrrfv .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#ozebixrrfv .gt_spanner_row {
  border-bottom-style: hidden;
}

#ozebixrrfv .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#ozebixrrfv .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#ozebixrrfv .gt_from_md > :first-child {
  margin-top: 0;
}

#ozebixrrfv .gt_from_md > :last-child {
  margin-bottom: 0;
}

#ozebixrrfv .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#ozebixrrfv .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#ozebixrrfv .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#ozebixrrfv .gt_row_group_first td {
  border-top-width: 2px;
}

#ozebixrrfv .gt_row_group_first th {
  border-top-width: 2px;
}

#ozebixrrfv .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#ozebixrrfv .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#ozebixrrfv .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#ozebixrrfv .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#ozebixrrfv .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#ozebixrrfv .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#ozebixrrfv .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#ozebixrrfv .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#ozebixrrfv .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#ozebixrrfv .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#ozebixrrfv .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#ozebixrrfv .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#ozebixrrfv .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#ozebixrrfv .gt_left {
  text-align: left;
}

#ozebixrrfv .gt_center {
  text-align: center;
}

#ozebixrrfv .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#ozebixrrfv .gt_font_normal {
  font-weight: normal;
}

#ozebixrrfv .gt_font_bold {
  font-weight: bold;
}

#ozebixrrfv .gt_font_italic {
  font-style: italic;
}

#ozebixrrfv .gt_super {
  font-size: 65%;
}

#ozebixrrfv .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#ozebixrrfv .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#ozebixrrfv .gt_indent_1 {
  text-indent: 5px;
}

#ozebixrrfv .gt_indent_2 {
  text-indent: 10px;
}

#ozebixrrfv .gt_indent_3 {
  text-indent: 15px;
}

#ozebixrrfv .gt_indent_4 {
  text-indent: 20px;
}

#ozebixrrfv .gt_indent_5 {
  text-indent: 25px;
}
</style>

<table class="gt_table table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<thead>
<tr class="header gt_col_headings">
<th id="expr" class="gt_col_heading gt_columns_bottom_border gt_center" data-quarto-table-cell-role="th" scope="col">expr</th>
<th id="seconds" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">seconds</th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_center" headers="expr">do_base(tidy_df[1:1e+07, ])</td>
<td class="gt_row gt_right" headers="seconds">3.10</td>
</tr>
<tr class="even">
<td class="gt_row gt_center" headers="expr">do_dplyr(tidy_df[1:1e+07, ])</td>
<td class="gt_row gt_right" headers="seconds">0.37</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p><strong>dplyr</strong> is much faster than base R. How does that stack up against the competition?</p>
</section>
<section id="data.table" class="level2">
<h2 class="anchored" data-anchor-id="data.table">data.table</h2>
<p>First up is the venerable <strong>data.table</strong> and the Tidyverse companion <strong>dtplyr</strong>. This has been around a long time and is the R community’s first choice when speed is needed. The key to <strong>data.table</strong>’s speed is adding a <code>key</code> to the data set. This makes grouping and rowwise lookups more efficient. The <strong>dtplyr</strong> package wraps it with <strong>dplyr</strong> syntax. If we are working with <strong>data.table</strong> objects throughout our workflow we an also see the performance effect of code translation when using <strong>dplyr</strong> verbs.</p>
<p>In the benchmark timings, the first row includes the time taken to convert a <strong>tibble</strong> to a <strong>data.table</strong> and then using the <strong>dplyr</strong> verbs from <strong>dtplyr</strong>. The second row is the time taken to process a <strong>data.table</strong> natively. The third row is the time taken to run the <strong>dtplyr</strong> code on a native <strong>data.table</strong>. Finally, as a control, we see the time taken to run the <strong>dplyr</strong> code on a <strong>tibble</strong> in the fourth row.</p>
<p>Note we are using “lazy” evalutation, which is another differentiator for <strong>data.table</strong>. We accumulate all the query operations and run them only when <code>collect()</code> is called.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1">do_data.table <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">df =</span> tidy_df, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">force_tidy =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>) {</span>
<span id="cb8-2">   <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data.table"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">class</span>(df)) {</span>
<span id="cb8-3">      <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>force_tidy) {</span>
<span id="cb8-4">         df[, .(</span>
<span id="cb8-5">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">high =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(temp),</span>
<span id="cb8-6">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">low =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(temp),</span>
<span id="cb8-7">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(temp)</span>
<span id="cb8-8">         ), by <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> city] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb8-9">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">collect</span>()</span>
<span id="cb8-10">      } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> {</span>
<span id="cb8-11">         df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb8-12">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(city) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb8-13">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(</span>
<span id="cb8-14">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">high =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(temp),</span>
<span id="cb8-15">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">low =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(temp),</span>
<span id="cb8-16">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(temp)</span>
<span id="cb8-17">            ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">collect</span>()</span>
<span id="cb8-18">      }</span>
<span id="cb8-19">   } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span>{</span>
<span id="cb8-20">      df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb8-21">         <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.table</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb8-22">         <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lazy_dt</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">immutable =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb8-23">         <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(city) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb8-24">         <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(</span>
<span id="cb8-25">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">high =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(temp),</span>
<span id="cb8-26">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">low =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(temp),</span>
<span id="cb8-27">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(temp)</span>
<span id="cb8-28"></span>
<span id="cb8-29">         ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb8-30">         <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">collect</span>()</span>
<span id="cb8-31">   }</span>
<span id="cb8-32">}</span>
<span id="cb8-33"></span>
<span id="cb8-34">DT_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.table</span>(tidy_df,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">key =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"city"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lazy_dt</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">immutable =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)</span>
<span id="cb8-35">bm_dt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">microbenchmark</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">do_data.table</span>(tidy_df),</span>
<span id="cb8-36">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">do_data.table</span>(DT_df,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">force_tidy =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>),</span>
<span id="cb8-37">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">do_data.table</span>(DT_df,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">force_tidy =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>), </span>
<span id="cb8-38">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">do_dplyr</span>(tidy_df),<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">unit=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"seconds"</span>)</span>
<span id="cb8-39"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">qbench</span>(bm_dt) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gt</span>()</span></code></pre></div>
</details>
<div class="cell-output-display">
<div id="uarhhncuki" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#uarhhncuki table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#uarhhncuki thead, #uarhhncuki tbody, #uarhhncuki tfoot, #uarhhncuki tr, #uarhhncuki td, #uarhhncuki th {
  border-style: none;
}

#uarhhncuki p {
  margin: 0;
  padding: 0;
}

#uarhhncuki .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#uarhhncuki .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#uarhhncuki .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#uarhhncuki .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#uarhhncuki .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#uarhhncuki .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#uarhhncuki .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#uarhhncuki .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#uarhhncuki .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#uarhhncuki .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#uarhhncuki .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#uarhhncuki .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#uarhhncuki .gt_spanner_row {
  border-bottom-style: hidden;
}

#uarhhncuki .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#uarhhncuki .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#uarhhncuki .gt_from_md > :first-child {
  margin-top: 0;
}

#uarhhncuki .gt_from_md > :last-child {
  margin-bottom: 0;
}

#uarhhncuki .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#uarhhncuki .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#uarhhncuki .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#uarhhncuki .gt_row_group_first td {
  border-top-width: 2px;
}

#uarhhncuki .gt_row_group_first th {
  border-top-width: 2px;
}

#uarhhncuki .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#uarhhncuki .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#uarhhncuki .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#uarhhncuki .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#uarhhncuki .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#uarhhncuki .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#uarhhncuki .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#uarhhncuki .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#uarhhncuki .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#uarhhncuki .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#uarhhncuki .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#uarhhncuki .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#uarhhncuki .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#uarhhncuki .gt_left {
  text-align: left;
}

#uarhhncuki .gt_center {
  text-align: center;
}

#uarhhncuki .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#uarhhncuki .gt_font_normal {
  font-weight: normal;
}

#uarhhncuki .gt_font_bold {
  font-weight: bold;
}

#uarhhncuki .gt_font_italic {
  font-style: italic;
}

#uarhhncuki .gt_super {
  font-size: 65%;
}

#uarhhncuki .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#uarhhncuki .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#uarhhncuki .gt_indent_1 {
  text-indent: 5px;
}

#uarhhncuki .gt_indent_2 {
  text-indent: 10px;
}

#uarhhncuki .gt_indent_3 {
  text-indent: 15px;
}

#uarhhncuki .gt_indent_4 {
  text-indent: 20px;
}

#uarhhncuki .gt_indent_5 {
  text-indent: 25px;
}
</style>

<table class="gt_table table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<thead>
<tr class="header gt_col_headings">
<th id="expr" class="gt_col_heading gt_columns_bottom_border gt_center" data-quarto-table-cell-role="th" scope="col">expr</th>
<th id="seconds" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">seconds</th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_center" headers="expr">do_data.table(tidy_df)</td>
<td class="gt_row gt_right" headers="seconds">4.29</td>
</tr>
<tr class="even">
<td class="gt_row gt_center" headers="expr">do_data.table(DT_df, force_tidy = FALSE)</td>
<td class="gt_row gt_right" headers="seconds">2.01</td>
</tr>
<tr class="odd">
<td class="gt_row gt_center" headers="expr">do_data.table(DT_df, force_tidy = TRUE)</td>
<td class="gt_row gt_right" headers="seconds">2.03</td>
</tr>
<tr class="even">
<td class="gt_row gt_center" headers="expr">do_dplyr(tidy_df)</td>
<td class="gt_row gt_right" headers="seconds">2.46</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>There is slight overhead in translating the <strong>dplyr</strong> syntax to <strong>data.table</strong> but the slowdown really comes from converting the data frame to a <strong>data.table</strong> object as shown in the first row. If you do that every time, <strong>data.table</strong> is slower than <strong>dplyr</strong>. Try to convert your dataset only once and then work can continue to be on the <strong>data.table</strong>.</p>
</section>
<section id="arrow" class="level2">
<h2 class="anchored" data-anchor-id="arrow">Arrow</h2>
<p>Next up is <strong>Arrow</strong>. This is a columnar database from <a href="https://arrow.apache.org/docs/index.html">Apache</a>. It uses a matching file format called <strong>parquet</strong>. This is a very efficient way to store data and is designed from the ground up to handle datasets larger than can fit in memory (but that is beyond the scope of this analysis). What’s nice is that <strong>the arrow R package already has a dplyr interface as it’s native interface!</strong> There is no separate package to translate <strong>dplyr</strong> verbs to a different <strong>arrow</strong> syntax.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">do_arrow <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(df) {</span>
<span id="cb9-2">   <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ArrowObject"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">class</span>(df)) {</span>
<span id="cb9-3">      df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb9-4">         <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(city) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb9-5">         <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(</span>
<span id="cb9-6">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">high =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(temp),</span>
<span id="cb9-7">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">low =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(temp),</span>
<span id="cb9-8">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(temp)</span>
<span id="cb9-9">         ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb9-10">         <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">collect</span>()</span>
<span id="cb9-11">   } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> {</span>
<span id="cb9-12">      df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb9-13">         <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrow_table</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb9-14">         <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(city) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb9-15">         <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(</span>
<span id="cb9-16">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">high =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(temp),</span>
<span id="cb9-17">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">low =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(temp),</span>
<span id="cb9-18">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(temp)</span>
<span id="cb9-19">         ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb9-20">         <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">collect</span>()</span>
<span id="cb9-21">   }</span>
<span id="cb9-22">}</span>
<span id="cb9-23"></span>
<span id="cb9-24">arrow_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> tidy_df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrow_table</span>()</span>
<span id="cb9-25"></span>
<span id="cb9-26">bm_arrow <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">microbenchmark</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">do_arrow</span>(arrow_df),</span>
<span id="cb9-27">                            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">do_arrow</span>(tidy_df),</span>
<span id="cb9-28">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb9-29"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">qbench</span>(bm_arrow) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gt</span>()</span></code></pre></div>
</details>
<div class="cell-output-display">
<div id="twhamnscet" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#twhamnscet table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#twhamnscet thead, #twhamnscet tbody, #twhamnscet tfoot, #twhamnscet tr, #twhamnscet td, #twhamnscet th {
  border-style: none;
}

#twhamnscet p {
  margin: 0;
  padding: 0;
}

#twhamnscet .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#twhamnscet .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#twhamnscet .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#twhamnscet .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#twhamnscet .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#twhamnscet .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#twhamnscet .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#twhamnscet .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#twhamnscet .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#twhamnscet .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#twhamnscet .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#twhamnscet .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#twhamnscet .gt_spanner_row {
  border-bottom-style: hidden;
}

#twhamnscet .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#twhamnscet .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#twhamnscet .gt_from_md > :first-child {
  margin-top: 0;
}

#twhamnscet .gt_from_md > :last-child {
  margin-bottom: 0;
}

#twhamnscet .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#twhamnscet .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#twhamnscet .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#twhamnscet .gt_row_group_first td {
  border-top-width: 2px;
}

#twhamnscet .gt_row_group_first th {
  border-top-width: 2px;
}

#twhamnscet .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#twhamnscet .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#twhamnscet .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#twhamnscet .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#twhamnscet .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#twhamnscet .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#twhamnscet .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#twhamnscet .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#twhamnscet .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#twhamnscet .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#twhamnscet .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#twhamnscet .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#twhamnscet .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#twhamnscet .gt_left {
  text-align: left;
}

#twhamnscet .gt_center {
  text-align: center;
}

#twhamnscet .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#twhamnscet .gt_font_normal {
  font-weight: normal;
}

#twhamnscet .gt_font_bold {
  font-weight: bold;
}

#twhamnscet .gt_font_italic {
  font-style: italic;
}

#twhamnscet .gt_super {
  font-size: 65%;
}

#twhamnscet .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#twhamnscet .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#twhamnscet .gt_indent_1 {
  text-indent: 5px;
}

#twhamnscet .gt_indent_2 {
  text-indent: 10px;
}

#twhamnscet .gt_indent_3 {
  text-indent: 15px;
}

#twhamnscet .gt_indent_4 {
  text-indent: 20px;
}

#twhamnscet .gt_indent_5 {
  text-indent: 25px;
}
</style>

<table class="gt_table table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<thead>
<tr class="header gt_col_headings">
<th id="expr" class="gt_col_heading gt_columns_bottom_border gt_center" data-quarto-table-cell-role="th" scope="col">expr</th>
<th id="seconds" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">seconds</th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_center" headers="expr">do_arrow(arrow_df)</td>
<td class="gt_row gt_right" headers="seconds">1.53</td>
</tr>
<tr class="even">
<td class="gt_row gt_center" headers="expr">do_arrow(tidy_df)</td>
<td class="gt_row gt_right" headers="seconds">3.72</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>We see a nice speedup over the previous methods although only when we start out in the <strong>arrow</strong> format. The overhead of converting the data frame to an <strong>arrow</strong> table is significant. So if you want to use <strong>arrow</strong> you’ll be right at home with the <strong>dplyr</strong> syntax but you should store and retrieve your data in native the <strong>arrow</strong> and <strong>parquet</strong> formats.</p>
</section>
<section id="polars" class="level2">
<h2 class="anchored" data-anchor-id="polars">Polars</h2>
<p>Moving on to a database that’s made a real splash in the Python community, <strong>polars</strong>. There is an R version, although it’s not on CRAN so you have to install it from <a href="">here</a>. The <strong>arrow</strong> companion is <a href="https://tidypolars.etiennebacher.com/">here</a>.</p>
<p>Polars uses the same columnar format as Arrow, but Polars has a secret weapon in that it does parallel processing by default. This is a big advantage when working with large data sets. Setup time for multi-threading is non-trivial so it really only shines on large data sets. Don’t worry. It all happens in the background. You don’t have to lift a finger.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1">do_polars <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">df =</span> tidy_df, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">force_tidy =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>) {</span>
<span id="cb10-2">   <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tbl"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">class</span>(df)) {</span>
<span id="cb10-3">      result <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb10-4">         <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_polars_df</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb10-5">         <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(city) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb10-6">         <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(</span>
<span id="cb10-7">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">high =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(temp),</span>
<span id="cb10-8">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">low =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(temp),</span>
<span id="cb10-9">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(temp)</span>
<span id="cb10-10">         ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb10-11">         <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(city)</span>
<span id="cb10-12">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(result)</span>
<span id="cb10-13">   }</span>
<span id="cb10-14">   <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (force_tidy) {</span>
<span id="cb10-15">      result <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb10-16">         <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_polars_df</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb10-17">         <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(city) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb10-18">         <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(</span>
<span id="cb10-19">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">high =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(temp),</span>
<span id="cb10-20">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">low =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(temp),</span>
<span id="cb10-21">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(temp)</span>
<span id="cb10-22">         ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb10-23">         <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(city)</span>
<span id="cb10-24">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(result)</span>
<span id="cb10-25">   }</span>
<span id="cb10-26">   </span>
<span id="cb10-27">   result <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"city"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">agg</span>(</span>
<span id="cb10-28">      pl<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">col</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"temp"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">alias</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"avg"</span>),</span>
<span id="cb10-29">      pl<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">col</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"temp"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">alias</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"low"</span>),</span>
<span id="cb10-30">      pl<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">col</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"temp"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">alias</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"high"</span>)</span>
<span id="cb10-31">   )</span>
<span id="cb10-32">   <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">class</span>(df) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RPolarsLazyFrame"</span>) {</span>
<span id="cb10-33">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">collect</span>(result))</span>
<span id="cb10-34">   } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> {</span>
<span id="cb10-35">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(result)</span>
<span id="cb10-36">   }</span>
<span id="cb10-37">}</span>
<span id="cb10-38"></span>
<span id="cb10-39">polars_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> tidy_df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_polars_df</span>()</span>
<span id="cb10-40"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># try lazy frame, too!</span></span>
<span id="cb10-41">polars_lazy <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> tidy_df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_polars_lf</span>()</span>
<span id="cb10-42"></span>
<span id="cb10-43">bm_polars <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">microbenchmark</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">do_polars</span>(tidy_df),</span>
<span id="cb10-44">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">do_polars</span>(polars_df),</span>
<span id="cb10-45">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">do_polars</span>(polars_lazy),</span>
<span id="cb10-46">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">do_polars</span>(polars_df,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">force_tidy =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>),</span>
<span id="cb10-47">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">unit=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"seconds"</span>)</span>
<span id="cb10-48"></span>
<span id="cb10-49"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">qbench</span>(bm_polars) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gt</span>()</span></code></pre></div>
</details>
<div class="cell-output-display">
<div id="jygesnjzvm" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#jygesnjzvm table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#jygesnjzvm thead, #jygesnjzvm tbody, #jygesnjzvm tfoot, #jygesnjzvm tr, #jygesnjzvm td, #jygesnjzvm th {
  border-style: none;
}

#jygesnjzvm p {
  margin: 0;
  padding: 0;
}

#jygesnjzvm .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#jygesnjzvm .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#jygesnjzvm .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#jygesnjzvm .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#jygesnjzvm .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#jygesnjzvm .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#jygesnjzvm .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#jygesnjzvm .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#jygesnjzvm .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#jygesnjzvm .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#jygesnjzvm .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#jygesnjzvm .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#jygesnjzvm .gt_spanner_row {
  border-bottom-style: hidden;
}

#jygesnjzvm .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#jygesnjzvm .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#jygesnjzvm .gt_from_md > :first-child {
  margin-top: 0;
}

#jygesnjzvm .gt_from_md > :last-child {
  margin-bottom: 0;
}

#jygesnjzvm .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#jygesnjzvm .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#jygesnjzvm .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#jygesnjzvm .gt_row_group_first td {
  border-top-width: 2px;
}

#jygesnjzvm .gt_row_group_first th {
  border-top-width: 2px;
}

#jygesnjzvm .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#jygesnjzvm .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#jygesnjzvm .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#jygesnjzvm .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#jygesnjzvm .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#jygesnjzvm .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#jygesnjzvm .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#jygesnjzvm .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#jygesnjzvm .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#jygesnjzvm .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#jygesnjzvm .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#jygesnjzvm .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#jygesnjzvm .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#jygesnjzvm .gt_left {
  text-align: left;
}

#jygesnjzvm .gt_center {
  text-align: center;
}

#jygesnjzvm .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#jygesnjzvm .gt_font_normal {
  font-weight: normal;
}

#jygesnjzvm .gt_font_bold {
  font-weight: bold;
}

#jygesnjzvm .gt_font_italic {
  font-style: italic;
}

#jygesnjzvm .gt_super {
  font-size: 65%;
}

#jygesnjzvm .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#jygesnjzvm .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#jygesnjzvm .gt_indent_1 {
  text-indent: 5px;
}

#jygesnjzvm .gt_indent_2 {
  text-indent: 10px;
}

#jygesnjzvm .gt_indent_3 {
  text-indent: 15px;
}

#jygesnjzvm .gt_indent_4 {
  text-indent: 20px;
}

#jygesnjzvm .gt_indent_5 {
  text-indent: 25px;
}
</style>

<table class="gt_table table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<thead>
<tr class="header gt_col_headings">
<th id="expr" class="gt_col_heading gt_columns_bottom_border gt_center" data-quarto-table-cell-role="th" scope="col">expr</th>
<th id="seconds" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">seconds</th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_center" headers="expr">do_polars(tidy_df)</td>
<td class="gt_row gt_right" headers="seconds">3.65</td>
</tr>
<tr class="even">
<td class="gt_row gt_center" headers="expr">do_polars(polars_df)</td>
<td class="gt_row gt_right" headers="seconds">0.73</td>
</tr>
<tr class="odd">
<td class="gt_row gt_center" headers="expr">do_polars(polars_lazy)</td>
<td class="gt_row gt_right" headers="seconds">0.74</td>
</tr>
<tr class="even">
<td class="gt_row gt_center" headers="expr">do_polars(polars_df, force_tidy = TRUE)</td>
<td class="gt_row gt_right" headers="seconds">0.75</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Pretty speedy! We’ve halved the time shown by <strong>arrow</strong>. Not only that, the performance of the <strong>tidypolars</strong> wrapper is great! We take only a tiny performance hit. Again, the overhead in converting an R data frame to polars is considerable. We are much better off if we start out with a <strong>polars</strong> data frame or stay in that format after converting once. If you want to use <strong>polars</strong> end-to-end, the file format that matches the in-memory structure of a <strong>polars</strong> data frame is the Apache <strong>parquet</strong> format also contained in the <strong>arrow</strong> package. There are no read/write functions in <strong>tidypolars</strong> so to read and write <strong>parquet</strong> files with <strong>polars</strong>, use the <code>pl_read_parquet()</code> function and <code>&lt;data frame&gt;$write_parquet</code> method from the <strong>polars</strong> package.</p>
<p>Note the use inclusion of a ‘lazy’ data frame in the test. Delaying query execution until all operations have been planned speeds things up a wee bit.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Polars for R is pretty new so both the native package and <code>tidypolars</code> are works in progress. Coverage of <strong>dplyr</strong> verbs is not 100%. In particular, if you do a anything beyond basic functions in <code>mutate()</code> you will have to “roll your own” Polars function. The syntax of the native version in R is “pythonic,” so it prefers object methods over functions.</p>
<p>As an example, there are several <code>lubridate</code> functions in <code>tidypolars</code> but the <code>yearqtr</code> type is not supported. Suppose we want to convert a date column to a year and quarter. We can create our own function that returns valid Polars code that can be used in a <code>tidypolars::mutate()</code> call.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1">pl_to_yrqtr <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(x){</span>
<span id="cb11-2">  q <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>dt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quarter</span>()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cast</span>(pl<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>String)</span>
<span id="cb11-3">  y <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>dt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">year</span>()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cast</span>(pl<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>String)</span>
<span id="cb11-4">  pl<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">concat_str</span>(y,q,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">separator =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Q"</span>)</span>
<span id="cb11-5">}</span>
<span id="cb11-6"></span>
<span id="cb11-7"></span>
<span id="cb11-8">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> pl<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">DataFrame</span>(</span>
<span id="cb11-9">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"date"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.Date</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2022-1-1"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2022-5-2"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2022-12-3"</span>))</span>
<span id="cb11-10">)</span>
<span id="cb11-11">df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb11-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yrqtr =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pl_to_yrqtr</span>(date)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb11-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>()</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 2
  date       yrqtr 
  &lt;date&gt;     &lt;chr&gt; 
1 2022-01-01 2022Q1
2 2022-05-02 2022Q2
3 2022-12-03 2022Q4</code></pre>
</div>
</div>
<p>There is a great Polars cookbook by Damien Dotta for R users <a href="https://ddotta.github.io/cookbook-rpolars/">here</a> which shows many side-by-side comparisons of <strong>dplyr</strong> and <strong>polars</strong> syntax. I urge you to refer to it for help with translating your code into native <strong>polars</strong> if you choose to go that route.</p>
</div>
</div>
</section>
<section id="duckdb" class="level2">
<h2 class="anchored" data-anchor-id="duckdb">duckDB</h2>
<p>Our final contender is <strong>duckdb</strong> with <strong>duckplyr</strong>. This is a relational database that supports “Structured Query Language” (SQL). SQL is easy to read but very different from R. Also, you first establish a connection to the database and work with the connection, not the data frame. <strong>duckplyr</strong> to the rescue. The speed boost comes from a <a href="https://duckdb.org/why_duckdb#fast">columnar-vectorized query execution engine</a>.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1">do_duckdb <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">df =</span> tidy_df, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">use_tidy =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) {</span>
<span id="cb13-2">   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># duckdb_register(con, "duck_df",overwrite = TRUE, orig_df)</span></span>
<span id="cb13-3">   <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (use_tidy) {</span>
<span id="cb13-4">      <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"duckplyr_df"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">class</span>(df)) {</span>
<span id="cb13-5">         <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># df was converted outside of function</span></span>
<span id="cb13-6">         result <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb13-7">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(city) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb13-8">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(</span>
<span id="cb13-9">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">high =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(temp),</span>
<span id="cb13-10">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">low =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(temp),</span>
<span id="cb13-11">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(temp)</span>
<span id="cb13-12">            )</span>
<span id="cb13-13">         <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(result)</span>
<span id="cb13-14">      } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> {</span>
<span id="cb13-15">         <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># convert df to duck right now</span></span>
<span id="cb13-16">         result <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_duckplyr_df</span>(df) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb13-17">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(city) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb13-18">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(</span>
<span id="cb13-19">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">high =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(temp),</span>
<span id="cb13-20">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">low =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(temp),</span>
<span id="cb13-21">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(temp)</span>
<span id="cb13-22">            )</span>
<span id="cb13-23">         <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(result)</span>
<span id="cb13-24">      }</span>
<span id="cb13-25">   } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> {</span>
<span id="cb13-26">      con <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbConnect</span>(duckdb<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">duckdb</span>())</span>
<span id="cb13-27">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># use global tidy_df so it doesn't matter what df was fed to function</span></span>
<span id="cb13-28">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">duckdb_register</span>(con, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"duck_df"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">overwrite =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, tidy_df)</span>
<span id="cb13-29">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># achieve the same result with dbGetQuery</span></span>
<span id="cb13-30">      result <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbGetQuery</span>(</span>
<span id="cb13-31">         con,</span>
<span id="cb13-32">         <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"SELECT city, AVG(temp) as avg, MIN(temp) as low, MAX(temp) as high FROM duck_df GROUP BY city"</span></span>
<span id="cb13-33">      )</span>
<span id="cb13-34">      result</span>
<span id="cb13-35">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbDisconnect</span>(con, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shutdown =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb13-36">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rm</span>(con)</span>
<span id="cb13-37">   }</span>
<span id="cb13-38">   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(result)</span>
<span id="cb13-39">}</span>
<span id="cb13-40"></span>
<span id="cb13-41">duck_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_duckplyr_df</span>(tidy_df)</span>
<span id="cb13-42"></span>
<span id="cb13-43">bm_duckdb <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">microbenchmark</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">do_duckdb</span>(tidy_df,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">use_tidy =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>),</span>
<span id="cb13-44">                            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">do_duckdb</span>(duck_df,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">use_tidy =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>),</span>
<span id="cb13-45">                            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">do_duckdb</span>(duck_df,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">use_tidy =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>),</span>
<span id="cb13-46">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">unit=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"seconds"</span>)</span>
<span id="cb13-47"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">qbench</span>(bm_duckdb) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gt</span>()</span></code></pre></div>
</details>
<div class="cell-output-display">
<div id="mgmjjfmetm" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#mgmjjfmetm table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#mgmjjfmetm thead, #mgmjjfmetm tbody, #mgmjjfmetm tfoot, #mgmjjfmetm tr, #mgmjjfmetm td, #mgmjjfmetm th {
  border-style: none;
}

#mgmjjfmetm p {
  margin: 0;
  padding: 0;
}

#mgmjjfmetm .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#mgmjjfmetm .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#mgmjjfmetm .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#mgmjjfmetm .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#mgmjjfmetm .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#mgmjjfmetm .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#mgmjjfmetm .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#mgmjjfmetm .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#mgmjjfmetm .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#mgmjjfmetm .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#mgmjjfmetm .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#mgmjjfmetm .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#mgmjjfmetm .gt_spanner_row {
  border-bottom-style: hidden;
}

#mgmjjfmetm .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#mgmjjfmetm .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#mgmjjfmetm .gt_from_md > :first-child {
  margin-top: 0;
}

#mgmjjfmetm .gt_from_md > :last-child {
  margin-bottom: 0;
}

#mgmjjfmetm .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#mgmjjfmetm .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#mgmjjfmetm .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#mgmjjfmetm .gt_row_group_first td {
  border-top-width: 2px;
}

#mgmjjfmetm .gt_row_group_first th {
  border-top-width: 2px;
}

#mgmjjfmetm .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#mgmjjfmetm .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#mgmjjfmetm .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#mgmjjfmetm .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#mgmjjfmetm .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#mgmjjfmetm .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#mgmjjfmetm .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#mgmjjfmetm .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#mgmjjfmetm .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#mgmjjfmetm .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#mgmjjfmetm .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#mgmjjfmetm .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#mgmjjfmetm .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#mgmjjfmetm .gt_left {
  text-align: left;
}

#mgmjjfmetm .gt_center {
  text-align: center;
}

#mgmjjfmetm .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#mgmjjfmetm .gt_font_normal {
  font-weight: normal;
}

#mgmjjfmetm .gt_font_bold {
  font-weight: bold;
}

#mgmjjfmetm .gt_font_italic {
  font-style: italic;
}

#mgmjjfmetm .gt_super {
  font-size: 65%;
}

#mgmjjfmetm .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#mgmjjfmetm .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#mgmjjfmetm .gt_indent_1 {
  text-indent: 5px;
}

#mgmjjfmetm .gt_indent_2 {
  text-indent: 10px;
}

#mgmjjfmetm .gt_indent_3 {
  text-indent: 15px;
}

#mgmjjfmetm .gt_indent_4 {
  text-indent: 20px;
}

#mgmjjfmetm .gt_indent_5 {
  text-indent: 25px;
}
</style>

<table class="gt_table table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<thead>
<tr class="header gt_col_headings">
<th id="expr" class="gt_col_heading gt_columns_bottom_border gt_center" data-quarto-table-cell-role="th" scope="col">expr</th>
<th id="seconds" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">seconds</th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_center" headers="expr">do_duckdb(tidy_df, use_tidy = TRUE)</td>
<td class="gt_row gt_right" headers="seconds">2.79</td>
</tr>
<tr class="even">
<td class="gt_row gt_center" headers="expr">do_duckdb(duck_df, use_tidy = TRUE)</td>
<td class="gt_row gt_right" headers="seconds">2.28</td>
</tr>
<tr class="odd">
<td class="gt_row gt_center" headers="expr">do_duckdb(duck_df, use_tidy = FALSE)</td>
<td class="gt_row gt_right" headers="seconds">0.75</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>So this is interesting. Converting to a <strong>duckdb</strong> object adds essentially no overhead but the using the tidy vernacular is far slower than native. I suspect the internals of opening and closing the database connection are to blame. <strong>duckdb</strong> is competitive with <strong>polars</strong> but only in native mode. If speeding up your execution times is the priority, I cannot recommend the <strong>duckplyr</strong> wrapper. Brush up on your SQL chops, instead.</p>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>Before drawing any conclusions, let’s throw out a couple caveats. The summary statistics we are calculating are very simple. If you are doing something more complex, the results may be different. I urge you do to your own tests. Further, the data set is all in memory. If you are working with data on disk, the results may be different. Coverage of the <strong>Tidyverse</strong> is not complete for all these wrappers. Some of your data wrangling pipelines may not work.</p>
<p>As a general statement, the process of converting a standard R data frame to the format used by any of these alt-database engines is significant. You should make the conversion once in your data manipulation pipeline, then stay in the more efficient format until it’s time to present the results with something like <strong>ggplot</strong>.</p>
<p>Now let’s summarize alt-database engines the way you would typically see them benchmarked, using their native interfaces and data frame formats.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1">bm <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbind</span>(bm_dt, bm_arrow, bm_polars, bm_duckdb)</span>
<span id="cb14-2"></span>
<span id="cb14-3">native_exprs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"do_dplyr(tidy_df)"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"do_data.table(DT_df, force_tidy = FALSE)"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"do_arrow(arrow_df)"</span>,</span>
<span id="cb14-4"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"do_polars(polars_lazy)"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"do_duckdb(duck_df, use_tidy = FALSE)"</span>)</span>
<span id="cb14-5"></span>
<span id="cb14-6">bm <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">qbench</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb14-7">   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(expr <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> native_exprs) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb14-8">   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_extract</span>(expr,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"do_.*</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">("</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_remove</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"do_"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_remove</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">("</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_to_title</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb14-9">   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_reorder</span>(method,seconds), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> seconds)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_col</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_flip</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb14-10">   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Performance of Native</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Alt-databases"</span>,</span>
<span id="cb14-11">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Time in seconds (lower is better)"</span>,</span>
<span id="cb14-12">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Method"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Seconds"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb14-13">   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb14-14">   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">text =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>))</span></code></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://outsiderdata.netlify.app/posts/2024-03-10-the-truth-about-tidy-wrappers/index_files/figure-html/bm_comparison-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>It looks like both <strong>duckdb</strong> and <strong>polars</strong> offer significant speed advantages over <strong>dplyr</strong> but, as mentioned at the beginning, there is more to the story for a <strong>tidyverse</strong> user.</p>
<p>Since this post is for people who are interested in speeding up R database operations AND who prefer using <strong>Tidyverse</strong> syntax, let’s summarize the performance of the four contenders using their Tidyverse wrappers around the native data frame formats. <strong>duckdb</strong> is an odd case in that you can’t avoid the translation costs from R to <strong>duckdb</strong> format if you want to use the <strong>duckplyr</strong> wrapper. <strong>Remember, this is not showing which database is fastest. It is showing which database is fastest when using Tidyverse syntax.</strong></p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1">bm_tidy_exprs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(</span>
<span id="cb15-2">   <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'do_dplyr(tidy_df)'</span>,</span>
<span id="cb15-3">   <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'do_data.table(DT_df, force_tidy = TRUE)'</span>,</span>
<span id="cb15-4">   <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'do_arrow(arrow_df)'</span>,</span>
<span id="cb15-5">   <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'do_polars(polars_df, force_tidy = TRUE)'</span>,</span>
<span id="cb15-6">   <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'do_duckdb(duck_df, use_tidy = TRUE)'</span></span>
<span id="cb15-7">)</span>
<span id="cb15-8"></span>
<span id="cb15-9">bm <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">qbench</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb15-10">   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(expr <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> bm_tidy_exprs) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb15-11">   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_extract</span>(expr,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"do_.*</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">("</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_remove</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"do_"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_remove</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">("</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_to_title</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb15-12">   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_reorder</span>(method,seconds), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> seconds)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_col</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_flip</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-13">   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Performance of</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Tidyverse Wrappers"</span>,</span>
<span id="cb15-14">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Time in seconds (lower is better)"</span>,</span>
<span id="cb15-15">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Database Wrapped with Dplyr Verbs"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Seconds"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-16">   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-17">   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">text =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>))</span></code></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://outsiderdata.netlify.app/posts/2024-03-10-the-truth-about-tidy-wrappers/index_files/figure-html/bm_comparison_tidy-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>The clear winner is</strong> polars<strong>.</strong> While both <strong>polars</strong> and <strong>duckdb</strong> are competitive in native mode, the tidyverse wrapper for <strong>duckdb</strong> is a performance killer. To get the most benefit from <strong>polars</strong> you should read and write your data files in <strong>parquet</strong> format and only convert <strong>polars</strong> objects with <code>as_tibble()</code> when you are ready to do some plotting or other non-database operations.</p>
</section>
<section id="should-you-always-use-an-alt-database" class="level2">
<h2 class="anchored" data-anchor-id="should-you-always-use-an-alt-database">Should you always use an alt-database?</h2>
<p>All of these databases are optimized for certain things but they all come with overhead. In the case of <strong>polars</strong> the parallel processing and lazy evaluation provide the speed advantage over <strong>dplyr</strong> but it does some behind-the-scenes setup to run and that adds time. On small datasets it’s not worth it. At what point does the dataset size make using <strong>polars</strong> faster than <strong>dplyr</strong>? Let’s find out.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1">row_subsets <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)</span>
<span id="cb16-2"></span>
<span id="cb16-3">sub_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(df){</span>
<span id="cb16-4">      df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(city) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb16-5">         <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(</span>
<span id="cb16-6">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">high =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(temp),</span>
<span id="cb16-7">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">low =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(temp),</span>
<span id="cb16-8">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(temp)</span>
<span id="cb16-9">         ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb16-10">         <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">collect</span>()</span>
<span id="cb16-11">}</span>
<span id="cb16-12"></span>
<span id="cb16-13">compare_dplry_to_polars <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(rows,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>){</span>
<span id="cb16-14">   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">microbenchmark</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sub_df</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(tidy_df,rows)),</span>
<span id="cb16-15">                  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sub_df</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(polars_lazy,rows)),</span>
<span id="cb16-16">                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times=</span>times,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">unit=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"seconds"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb16-17">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">qbench</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">round =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">Inf</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb16-18">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># as_tibble() |&gt; </span></span>
<span id="cb16-19">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rows =</span> rows,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.before =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"seconds"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb16-20">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_remove</span>(expr,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sub_df</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">(head</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">("</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb16-21">                <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_remove</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">", rows</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">)</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">)"</span>),<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.before =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rows"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb16-22">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(method,rows,seconds) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb16-23">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_wider</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_from =</span> method,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_from =</span> seconds) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb16-24">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ratio =</span> polars_lazy <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> tidy_df)</span>
<span id="cb16-25">}</span>
<span id="cb16-26"></span>
<span id="cb16-27">get_size <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(rows){</span>
<span id="cb16-28">   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rows =</span> rows, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data_size =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">format</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">object.size</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(tidy_df,rows)),<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">units=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"MB"</span>))</span>
<span id="cb16-29">}</span>
<span id="cb16-30"></span>
<span id="cb16-31">bm_size <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> row_subsets <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map</span>(compare_dplry_to_polars) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_rows</span>()</span>
<span id="cb16-32">bm_size <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> rows, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> ratio)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb16-33">   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Polars vs Dplyr"</span>,</span>
<span id="cb16-34">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Ratio of Polars to Dplyr Execution Time"</span>,</span>
<span id="cb16-35">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Rows (Log Scale)"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Ratio"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb16-36">   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_hline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yintercept =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dashed"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb16-37">   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_log10</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n.breaks =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(row_subsets)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb16-38">   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb16-39">   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">text =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>))</span></code></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://outsiderdata.netlify.app/posts/2024-03-10-the-truth-about-tidy-wrappers/index_files/figure-html/polars_vs_dplyr_small-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Let’s zoom in on the region where the crossover occurs.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1">row_subsets_2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">from=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">to=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e5</span></span>
<span id="cb17-2"></span>
<span id="cb17-3">bm_size_2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> row_subsets_2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map</span>(compare_dplry_to_polars,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_rows</span>()</span>
<span id="cb17-4"></span>
<span id="cb17-5">bm_size_2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> rows<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e6</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> ratio)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb17-6">   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Polars vs Dplyr"</span>,</span>
<span id="cb17-7">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Ratio of Polars to Dplyr Execution Time"</span>,</span>
<span id="cb17-8">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Millions of Rows"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Ratio"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb17-9">   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_hline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yintercept =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dashed"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb17-10">   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb17-11">   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">text =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>))</span></code></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://outsiderdata.netlify.app/posts/2024-03-10-the-truth-about-tidy-wrappers/index_files/figure-html/polars_vs_dplyr_small_plot_2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>It looks like the crossover point, where <strong>polars</strong> becomes a better choice than <strong>dplyr</strong> <strong>with this dataset</strong>, is between 1 and 1.5 million rows. This is a rough estimate and will depend on a lot of factors. The dataset we are using has only two columns. The geometry of your data will certainly be different so it may also be helpful to look at the size of the dataset. Here it seems that we should prefer <strong>polars</strong> if our dataset is larger than around 23MB.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1">obj_sizes_2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> row_subsets_2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map</span>(get_size) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_rows</span>()</span>
<span id="cb18-2">bm_size_3 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> bm_size_2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(obj_sizes_2,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rows"</span>)</span>
<span id="cb18-3">bm_size_3 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gt</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb18-4">   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fmt_number</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">columns =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">use_seps =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">decimals =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb18-5">   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fmt_number</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">columns =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">use_seps =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">decimals =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span></code></pre></div>
</details>
<div class="cell-output-display">
<div id="hgeousrhvt" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#hgeousrhvt table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#hgeousrhvt thead, #hgeousrhvt tbody, #hgeousrhvt tfoot, #hgeousrhvt tr, #hgeousrhvt td, #hgeousrhvt th {
  border-style: none;
}

#hgeousrhvt p {
  margin: 0;
  padding: 0;
}

#hgeousrhvt .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#hgeousrhvt .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#hgeousrhvt .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#hgeousrhvt .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#hgeousrhvt .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#hgeousrhvt .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#hgeousrhvt .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#hgeousrhvt .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#hgeousrhvt .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#hgeousrhvt .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#hgeousrhvt .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#hgeousrhvt .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#hgeousrhvt .gt_spanner_row {
  border-bottom-style: hidden;
}

#hgeousrhvt .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#hgeousrhvt .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#hgeousrhvt .gt_from_md > :first-child {
  margin-top: 0;
}

#hgeousrhvt .gt_from_md > :last-child {
  margin-bottom: 0;
}

#hgeousrhvt .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#hgeousrhvt .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#hgeousrhvt .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#hgeousrhvt .gt_row_group_first td {
  border-top-width: 2px;
}

#hgeousrhvt .gt_row_group_first th {
  border-top-width: 2px;
}

#hgeousrhvt .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#hgeousrhvt .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#hgeousrhvt .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#hgeousrhvt .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#hgeousrhvt .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#hgeousrhvt .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#hgeousrhvt .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#hgeousrhvt .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#hgeousrhvt .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#hgeousrhvt .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#hgeousrhvt .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#hgeousrhvt .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#hgeousrhvt .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#hgeousrhvt .gt_left {
  text-align: left;
}

#hgeousrhvt .gt_center {
  text-align: center;
}

#hgeousrhvt .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#hgeousrhvt .gt_font_normal {
  font-weight: normal;
}

#hgeousrhvt .gt_font_bold {
  font-weight: bold;
}

#hgeousrhvt .gt_font_italic {
  font-style: italic;
}

#hgeousrhvt .gt_super {
  font-size: 65%;
}

#hgeousrhvt .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#hgeousrhvt .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#hgeousrhvt .gt_indent_1 {
  text-indent: 5px;
}

#hgeousrhvt .gt_indent_2 {
  text-indent: 10px;
}

#hgeousrhvt .gt_indent_3 {
  text-indent: 15px;
}

#hgeousrhvt .gt_indent_4 {
  text-indent: 20px;
}

#hgeousrhvt .gt_indent_5 {
  text-indent: 25px;
}
</style>

<table class="gt_table table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<thead>
<tr class="header gt_col_headings">
<th id="rows" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">rows</th>
<th id="tidy_df" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">tidy_df</th>
<th id="polars_lazy" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">polars_lazy</th>
<th id="ratio" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">ratio</th>
<th id="data_size" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" scope="col">data_size</th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_right" headers="rows">500,000</td>
<td class="gt_row gt_right" headers="tidy_df">0.02</td>
<td class="gt_row gt_right" headers="polars_lazy">0.04</td>
<td class="gt_row gt_right" headers="ratio">1.86</td>
<td class="gt_row gt_left" headers="data_size">7.7 Mb</td>
</tr>
<tr class="even">
<td class="gt_row gt_right" headers="rows">1,000,000</td>
<td class="gt_row gt_right" headers="tidy_df">0.04</td>
<td class="gt_row gt_right" headers="polars_lazy">0.04</td>
<td class="gt_row gt_right" headers="ratio">1.16</td>
<td class="gt_row gt_left" headers="data_size">15.3 Mb</td>
</tr>
<tr class="odd">
<td class="gt_row gt_right" headers="rows">1,500,000</td>
<td class="gt_row gt_right" headers="tidy_df">0.05</td>
<td class="gt_row gt_right" headers="polars_lazy">0.05</td>
<td class="gt_row gt_right" headers="ratio">0.89</td>
<td class="gt_row gt_left" headers="data_size">22.9 Mb</td>
</tr>
<tr class="even">
<td class="gt_row gt_right" headers="rows">2,000,000</td>
<td class="gt_row gt_right" headers="tidy_df">0.07</td>
<td class="gt_row gt_right" headers="polars_lazy">0.06</td>
<td class="gt_row gt_right" headers="ratio">0.84</td>
<td class="gt_row gt_left" headers="data_size">30.5 Mb</td>
</tr>
<tr class="odd">
<td class="gt_row gt_right" headers="rows">2,500,000</td>
<td class="gt_row gt_right" headers="tidy_df">0.09</td>
<td class="gt_row gt_right" headers="polars_lazy">0.07</td>
<td class="gt_row gt_right" headers="ratio">0.80</td>
<td class="gt_row gt_left" headers="data_size">38.2 Mb</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>There are infinite combinations of hardware, data structures and processing pipelines possible and you may find a different result in your work. <strong>polars</strong> for R is not on CRAN yet but it’s worth seeking out. I will be incorporating it in my work from now on. I am grateful for any comments, criticisms or observations you may have. Thanks for reading!</p>


</section>

 ]]></description>
  <guid>https://outsiderdata.netlify.app/posts/2024-03-10-the-truth-about-tidy-wrappers/</guid>
  <pubDate>Sun, 10 Mar 2024 05:00:00 GMT</pubDate>
</item>
</channel>
</rss>
