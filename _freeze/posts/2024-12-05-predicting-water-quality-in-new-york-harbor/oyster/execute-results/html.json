{
  "hash": "5689497e46dde8ad51b1d928738f3a3f",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Predicting Water Quality in New York Harbor\"\ndescription: \"Using Tidymodels and data from the Billion Oyster Project\"\nauthor: Art Steinmetz\ndate: 2024-12-05\nimage: \"img/Oyster.jpg\"\ndraft: false\nfreeze: true\nformat: \n  html:\n    code-fold: true\nexecute:\n  warning: false\ncomments: \n  utterances:\n    repo: apsteinmetz/blog_outsider\n    label: oyster\n\n---\n\n\n\n## Motivation\n\nThis is an exercise in using machine learning to predict the level of harmful bacteria in New York Harbor based on environmental factors like tidal conditions, rainfall and location. Among the reasons this is useful is understanding how to rebuild a marine life ecosystem in the harbor, where oysters were a keystone species. We use the R data science language,  [Tidymodel](https://www.tidymodels.org/) tools from Posit.co to build the model and public data provided by [The Billion Oyster Project](https://www.billionoysterproject.org/) using volunteer water sampling.\n\nThe model shows some ability to predict \"safe\" and \"unacceptable\" bacterial concentrations but false predictions are quite high.\n\n## Oyster Farm to the World\n\nNew York Harbor is one of the world's greatest natural harbors. Those of us who live in New York City today see it mainly as an obstacle that we travel over or under. In our more reflective moods we see the history of what was in the piers. We can easily imagine the enormous ship traffic the piers once supported. What we can't see are the echoes of the vibrant ecosystem of marine life that once thrived beneath the surface. The harbor sustained a rich diversity of marine life that provided abundant sustenance for the indigenous people before the arrival of Europeans and later for the colonists and migrants who arrived in their millions.\n\n![](img/George_Schlegel_-_George_Degen_-_New_York_1873.jpg){width=\"auto\"}\n\nOysters were the keystone species for this ecosystem. They were so abundant that they, as filter feeders, filtered the entire volume of the harbor every few days. They provided habitat for other marine life and helped to stabilize the shoreline. At one point fully a third of all the World's oyster harvest came from New York Harbor. Pearl Street in Manhattan was the site of a giant oyster shell midden left by the Lenape people. The oyster was the food of rich and poor alike. Stories of the colorful characters in Gilded Age New York are replete with oyster orgies at Delmonico's restaurant. Oysters were so important to the economy of the city that before it became \"The Big Apple\" it was called \"The Big Oyster.\"\n\n![Delmonico's 1899. Oysters Have Pride of Place.(25 cents, not dollars!)](img/delmonicos_1899.png){width=\"auto\"}\n\nAlas, by the late 19th century, the oyster beds were so depleted that the oyster industry collapsed. The risk of over-harvesting was recognized as early as 1715 when \"An Act for Preserving of Oysters\" was passed but the law was suspended in 1807 and harvesting became relentless. This was also the harbinger of the harbor's decline as species up the food chain suffered in parallel. Pollution was the final blow. Industry along the Hudson River flushed toxins downstream and, in 1856, the [\"Combined Sewer Outflow\"](https://www.nyc.gov/site/dep/water/combined-sewer-overflows.page) system was established. This combines storm water drainage with raw sewage sent to treatment plants. During heavy rain, the system overflows and raw sewage is pumped into the harbor. After the passage of the Clean Water Act in 1972 industrial pollution declined but, incredibly, the CSO remains and is the major source of pollutants around the city.\n\nToday we understand the need to support keystone species as vital to an ecosystem. [The Billion Oyster Project (BOP)](https://www.billionoysterproject.org/) is a non-profit organization whose mission is to restore oyster reefs to New York. They are doing this work in collaboration collaboration with schools, universities, and government agencies. I have been a supporter of their mission for several years now. Getting the public to understand the importance of clean water is an important part of this effort. The project has been using volunteers to collect water quality data from the harbor since 2014 and the data are available to the public in a [water quality spreadsheet](https://docs.google.com/spreadsheets/d/1813b2nagaxZ80xRfyMZNNKySZOitro5Nt7W4E9WNQDA/edit?usp=sharing).\n\nDownloading the full spreadsheet is a bit slow and there is some cleaning involved so we'll use data files we previously created. If you want to replicate this the code for downloading and processing the spreadsheet is below.\n\n::: callout-note\n## Click on the \"â–º Code\" buttons throughout this document to see the source code for the project.\n:::\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(here)\nlibrary(googlesheets4)\nlibrary(rvest)\nlibrary(duckplyr)\nlibrary(arrow)\nlibrary(leaflet)\nlibrary(htmltools)\nlibrary(sf)\nlibrary(tidymodels)\nlibrary(gt)\n\n# enterococci thresholds\nSAFE = 34\nCAUTION = 104\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Get Water Quality Data from BOP ----------------------------------\n\n# no need for a google account to access this sheet\ngooglesheets4::gs4_deauth()\n\nwq_url <-\n  \"https://docs.google.com/spreadsheets/d/1813b2nagaxZ80xRfyMZNNKySZOitro5Nt7W4E9WNQDA/edit?usp=sharing\"\n\n\n# DOWNLOAD meta data worksheet\nwq_meta <- gs4_get(wq_url)\n# take 400 rows of metadata to accomodate future growth in testing stations (up to 400 <grin>)\n# assumes row 10 is column names, column A is site ID which is duplicated in column D\nwq_meta_raw <- read_sheet(wq_url,\"Information\",range = \"B10:BA400\")\n\n# Clean Meta Station Data ----------------------------------\n\nwq_meta <- wq_meta_raw |>\n  # remove empty columns by selecting only columns where names starts with a letter\n  select(!matches(\"^\\\\.\")) |>\n  janitor::clean_names() |>\n  rename(\"site\" = 2) |>\n  # remove empty rows\n  filter(!is.na(site)) |>\n  mutate(site_id = as.factor(site_id)) |>\n  # why these come in as a list of 1 is beyond me and one value is NULL\n  # this is some complicated dplyr-fu.\n  mutate(district_council_number =  as.factor(unlist(map(\n    district_council_number,  ~ ifelse(is.null(.x), NA, .x)\n  )))) |>\n  mutate(harmonic_noaa_tide_stations =  as.factor(unlist(\n    map(harmonic_noaa_tide_stations,  ~ ifelse(is.null(.x), NA, .x))\n  ))) |>\n  # FIXED as of Aug 2024.  some longitudes are erroneously positive\n  mutate(longitude = if_else(longitude > 0, -longitude, longitude)) |>\n  mutate(currently_testing = as.logical(if_else(is.na(currently_testing), 0, 1))) |>\n  rename_with( ~ \"nyc_dep_wrrf_or_sewershed\", starts_with(\"associated\")) |>\n  # make NA entries in character columns actual NA so there is only one kind of NA\n  mutate(across(where(is.character), \\(x) if_else(x == \"N/A\", NA, x))) |>\n  # some columns are NA because they are in NJ. Make \"NJ\" the value\n  mutate(\n    district_council_number = if_else(\n      district_council_number == \"N/A\",\n      \"NJ\",\n      district_council_number\n    )\n  ) |>\n  mutate(nyc_dep_wrrf_or_sewershed = if_else(\n    is.na(nyc_dep_wrrf_or_sewershed),\n    \"NJ\",\n    nyc_dep_wrrf_or_sewershed\n  )) |>\n  mutate(\n    nys_dec_water_body_classification = if_else(\n      is.na(nys_dec_water_body_classification),\n      \"NJ\",\n      nys_dec_water_body_classification\n    )\n  )\n\n# save meta data as parquet file\n# arrow::write_parquet(wq_meta,here(\"data/wq_meta.parquet\"))\n\n# DOWNLOAD water quality data worksheet ---------------------------------------------\nwq_data_raw <- read_sheet(wq_url,\"Data\")\n\ndata_names <- c(\"site\",\"site_id\",\"date\",\"year\",\"month\",\"high_tide\",\"sample_time\",\"bacteria\",\n                \"precip_t0\",\"precip_t1\",\"precip_t2\",\"precip_t3\",\"precip_t4\",\n                \"precip_t5\",\"precip_t6\",\"notes\")\n\n# get average sample time and use that for NA sample times\nsample_time_avg <- wq_data_raw$`Sample Time` |>\n  mean(na.rm = TRUE) |>\n  as.POSIXct()\n\n# function to extract day of week from date\nday_of_week <- function(x) {\n  x |>\n    lubridate::wday(week_start = 7) |>\n    factor(levels = 1:7,labels = c(\"Sun\",\"Mon\",\"Tue\",\"Wed\",\"Thu\",\"Fri\",\"Sat\"))\n}\n\n# clean up data\nwq_data <- wq_data_raw |>\n  set_names(data_names) |>\n  mutate(date = as_date(date)) |>\n  # change NA sample times to average of all sample times. Good idea?\n  mutate(sample_time = if_else(is.na(sample_time),sample_time_avg,sample_time)) |>\n  mutate(sample_time = hms::as_hms(sample_time)) |>\n  mutate(sample_day = day_of_week(date),.before = bacteria) |>\n  mutate(high_tide = hms::as_hms(high_tide)) |>\n  # add date to sample time\n  mutate(sample_time = ymd_hms(paste(date,sample_time),tz= \"America/New_York\")) |>\n  mutate(high_tide = ymd_hms(paste(date,high_tide),tz= \"America/New_York\")) |>\n  mutate(across(where(is.list), as.character)) |>\n  # We chose to make \"Trace\" and \"<10\" into zero.\n  mutate(across(where(is.character), .fns = ~ str_replace(.x, \"<10\", \"0\"))) |>\n  mutate(across(where(is.character), .fns = ~ str_replace(.x, \"Trace\", \"0\"))) |>\n  # > 24196 test limit?  This value is so far out of the range of the other values\n  # that it might as well be infinity.\n  mutate(across(where(is.character), .fns = ~ str_replace(.x, \">\", \"\"))) |>\n  # get rid of snow inches next to precip as water\n  mutate(across(where(is.character), .fns = ~ str_replace(.x, \"\\\\(.+\\\\)\", \"\"))) |>\n  mutate(across(where(is.character), .fns = ~ na_if(.x, \"N/A\"))) |>\n  mutate(across(contains(\"precip\"), as.numeric)) |>\n  mutate(bacteria = as.numeric(bacteria)) |>\n  mutate(notes = replace_na(notes, \"\")) |>\n  # fix some typos\n  mutate(site = str_replace(site, \"Daylighted Section\", \"daylighted section\")) |>\n  mutate(site = str_replace(site, \"Govenors\", \"Governors\")) |>\n  # classify bacteria levels according to NY DEP standards\n  mutate(site = as.factor(site)) |>\n  mutate(site_id = as.factor(site_id))\n\n  # write to parquet\n  # arrow::write_parquet(wq_data,here(\"data/wq_data.parquet\"))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# load data files\nwater_body_classifications <- read_csv(\"data/NYDEC_water_classifications.csv\",col_types = \"fcc\")\nwq_meta <- arrow::read_parquet(\"data/wq_meta.parquet\")\nwq_data_raw <- arrow::read_parquet(\"data/wq_data.parquet\")\n```\n:::\n\n\n\n\n## Data Cleaning\n\nWhile we cleaned up the data in the previous section, we still might want to do some feature engineering to get the data ready for modeling. In particular, the bacterial levels are classified according to NY DEP standards as \"SAFE\" or \"UNSAFE\" with a another category in between that indicates heightened vigilance which we'll call \"CAUTION,\" so let's make a column for that.\n\nThe data contains rainfall amounts for each day in the week preceding the sample date. The NY DEP standard is to use the 48-hour rainfall amount as a predictor of bacterial levels. We'll aggregate up the rainfall columns into three non-overlapping intervals, same day, previous 48 hours and earlier days in the week. It's worth noting that rainfall for the sample day is for the entire 24-hour period and not just preceding the time of the sample.\n\nWhile we have the precise location of each sampling site it might be useful to have general location information. This will include the water body classification, the sewershed, the name of the body of water and the lab processing the samples.\n\nThe month is a cyclical feature. December, month number 12, is closer in climate to month number 1 than it is to month number 6, so we'll recode the month numbers to reflect that, setting August as the hottest month.\n\nFinally, we'll convert all NAs in the factor columns to a \"missing\" level. This will let us keep rows with NA in the models but all missing will have the same value. This is a choice that could be revisited later.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# get all levels of lab_analysis columns matched with year\nall_labs <- wq_meta |> \n  select(contains(\"lab_analysis\"),site_id) |>\n  pivot_longer(cols = contains(\"x\"),\n               names_to = \"year\",\n               values_to = \"lab\") |> \n  mutate(year = as.numeric(str_extract(year,\"[0-9]+\"))) |> \n  mutate(lab = as.character(lab)) |> \n  filter(lab != \"NA\") |> \n  mutate(lab = as.factor(lab))\n  \n\n# convert all N/As in factor columns to a \"missing\" level\n# This will let us keep rows with NA in the models but all missing will have the same value\n# good or bad?\nwq_meta <- wq_meta |>\n  mutate(across(where(is.factor), ~ fct_na_value_to_level(.x,level = \"missing\")))\n\n# feature engineering\nwq_data <- wq_data_raw %>%\n  # use of dplyr pipe needed for duckplyr, not native \"|>\" pipe\n  # make 2-day precip column since 48-hour precip is a DEP standard\n  # since observation time is typically in the morning don't include the current day's precip\n  # since we don't know if it came before, during or after collection\n  mutate(precip_week = rowSums(select(., starts_with(\"precip\")), na.rm = TRUE),.after=\"bacteria\") %>%\n  mutate(precip_48 = rowSums(select(., precip_t1,precip_t2), na.rm = TRUE),.after=\"bacteria\") %>%\n  mutate(precip_earlier = rowSums(select(., precip_t3,precip_t4,precip_t5,,precip_t6), na.rm = TRUE),.after=\"precip_48\") %>%\n  select(-precip_t1,-precip_t2,-precip_t3,-precip_t4,-precip_t5,-precip_t6) %>%\n  # categorize bacteria levels as quality levels\n  mutate(quality = as_factor(cut(\n    bacteria,\n    breaks = c(-1,SAFE, CAUTION, Inf),\n    labels = c(\"Safe\", \"Caution\", \"Unsafe\")\n  ))) %>%\n  # compute time between sample time and high tide\n  mutate(time_since_high_tide = as.numeric(difftime(sample_time,high_tide,units = \"hours\")),\n         .after = \"sample_time\") %>%\n  as_tibble()\n# add some meta data that might be interesting in prediction\n# add water body type,  water body and sewershed from metadata\nwq_data <- wq_data |>\n  left_join(by = \"site_id\",select(wq_meta,\n                   site_id,\n                   water_body,\n                   nys_dec_water_body_classification,\n                   nyc_dep_wrrf_or_sewershed)\n            ) |>\n  # change all character columns to factors\n  mutate(across(where(is.character), as.factor)) |>\n  # rename columns\n  rename(water_class = nys_dec_water_body_classification,\n         sewershed = nyc_dep_wrrf_or_sewershed)\n\n# create a column that corresponds the relative temperature of the month\n# July is the hottest month in NYC\nwq_data <- wq_data |>\n  mutate(season = as.numeric(factor(month(date), levels = 1:12, labels = c(0,1,2,3,4,5,6,5,4,3,2,1))))\n\nwq_data <- wq_data |>\n  left_join(all_labs,by = c(\"site_id\",\"year\")) \n\n# convert all N/As in factor columns to a \"missing\" level\n# This will let us keep rows with NA in the models but all missing will have the same value\n# good or bad?\n#wq_data <- wq_data |>\n#   mutate(across(where(is.factor), ~ fct_na_value_to_level(.x,level = \"missing\")))\nwq_data <- wq_data |>\n   mutate(lab = fct_na_value_to_level(lab,level = \"missing\")) |> \n  drop_na()\n```\n:::\n\n\n\n\n## Exploratory Data Analysis\n\nLet's start by looking at a map of all the sampling sites. Many sites (in red, below) are no longer being tested. The upper half of Manhattan, both on the Hudson side and the East River side are not included in the most recent data. We have to be careful about drawing conclusions about changes over time for the whole sampling set because the sites are not constant.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# convert wq_meta into a simple features object\nwq_meta_sf <- wq_meta |>\n  left_join(water_body_classifications,\n            by = c(\"nys_dec_water_body_classification\" = \"water_body_class\")) |>\n  st_as_sf(coords = c(\"longitude\",\"latitude\"),crs = 4326)\n\n\n# display a leaflet map --------------------------------------------------------\nmap_labels <- glue::glue(\"<strong>{wq_meta_sf$site}</strong><br/>\n                          Currently Testing? </strong>{wq_meta_sf$currently_testing}<br/>\n                          Sewershed: {wq_meta_sf$nyc_dep_wrrf_or_sewershed}<br/>\n                         Use: {wq_meta_sf$best_uses}\") |>\n  lapply(htmltools::HTML)\n\nwq_meta_sf |>\n  leaflet() |>\n  addTiles() |>\n  addCircleMarkers(radius = 5,\n                            label = ~map_labels,\n                            color = ~ifelse(currently_testing,\"green\",\"red\"))\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"leaflet html-widget html-fill-item\" id=\"htmlwidget-311c2242efcfd54e880b\" style=\"width:100%;height:464px;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-311c2242efcfd54e880b\">{\"x\":{\"options\":{\"crs\":{\"crsClass\":\"L.CRS.EPSG3857\",\"code\":null,\"proj4def\":null,\"projectedBounds\":null,\"options\":{}}},\"calls\":[{\"method\":\"addTiles\",\"args\":[\"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png\",null,null,{\"minZoom\":0,\"maxZoom\":18,\"tileSize\":256,\"subdomains\":\"abc\",\"errorTileUrl\":\"\",\"tms\":false,\"noWrap\":false,\"zoomOffset\":0,\"zoomReverse\":false,\"opacity\":1,\"zIndex\":1,\"detectRetina\":false,\"attribution\":\"&copy; <a href=\\\"https://openstreetmap.org/copyright/\\\">OpenStreetMap<\\/a>,  <a href=\\\"https://opendatacommons.org/licenses/odbl/\\\">ODbL<\\/a>\"}]},{\"method\":\"addCircleMarkers\",\"args\":[[40.50138,40.797291,40.801921,40.862411,40.82449,40.8178447,40.8097,40.8144,40.832385,40.8321416,40.691375,40.678574,40.5835405,40.5844306,40.5810247,40.5825464,40.5791505,40.748051,40.706887,40.7252056,40.723181,40.7044059,40.77719,40.709882,40.743849,40.7168567,40.769516,40.81012,40.793278,40.73157,40.72191,40.718943,40.700789,40.699967,40.709208,40.709865,40.6968031,40.7103,40.7142915,40.7130241,40.710069,40.7333646,40.8091363,40.8048868,40.7055253,40.730086,40.771964,40.7634239,40.760445,40.7598868,40.760543,40.675486,40.6761467,40.6783319,40.676586,40.674423,40.6768139,40.5853425,40.60138,40.662968,40.763925,40.859316,40.807001,40.688829,40.842404,40.806018,40.806394,40.7910125,40.874568,40.864361,40.864388,40.856102,40.78917,40.9566318,40.9566318,40.7413476,40.739174,40.739183,40.740726,40.7391216,40.748265,40.8674926,40.9566318,40.751744,40.7215745,40.728249,40.752502,40.764275,40.771322,40.7735219,40.7799272,40.7553196,40.799369,40.818007,40.8206007,40.8283762,40.832214,40.8461433,40.781422,40.7859195,40.9379388,40.8634849,40.6278942,40.602409,40.6264122,40.5824832,40.64512,40.74727,40.7801708,40.7375594,40.7292914,40.7429327,40.7378927,40.7167533,40.7120691,40.739025,40.7355189,40.739534,40.7385105,40.7248845,40.736974,40.655305,40.571734,40.601792,40.599456,40.5422,40.572109,40.5665366,40.549642,40.579248,40.48334,40.48769,40.47483,40.54067,40.48826,40.50007,40.9356552,40.583419,40.6546621,40.6548329,40.645481,40.639326,40.8898985,40.728539],[-74.25416,-73.916026,-73.92408399999999,-73.874364,-73.88505000000001,-73.881072,-73.8682,-73.8708,-73.88282100000001,-73.88292800000001,-74.01253199999999,-74.018372,-73.9927194,-73.990388,-73.997941,-73.97483699999999,-73.98747,-73.954628,-74.001142,-73.959234,-73.962509,-73.990526,-73.94211,-73.989594,-73.960111,-73.96717700000001,-73.935593,-73.80231999999999,-73.848917,-73.96176,-73.96301,-73.96574099999999,-73.996922,-73.99807,-73.988505,-73.988629,-73.99888,-73.980614,-73.968192,-73.96871400000001,-73.96965,-73.973866,-73.80270299999999,-73.79435599999999,-73.970263,-73.961404,-73.85035000000001,-73.843532,-73.849571,-73.85146,-73.83645799999999,-73.990887,-73.992577,-73.98931399999999,-73.98961,-73.996425,-73.98991599999999,-73.99837890000001,-74.0125,-74.133458,-74.08723000000001,-74.032318,-74.05710000000001,-74.11227599999999,-73.929444,-73.930089,-73.9303903,-73.927415,-73.917539,-73.91591200000001,-73.915755,-73.922073,-73.93277,-73.89769,-73.89769,-74.025702,-74.010909,-74.011194,-74.009682,-74.010559,-74.023647,-73.93291499999999,-73.89769,-74.022864,-74.01355700000001,-74.013786,-74.00897999999999,-74.002129,-73.995991,-73.99377800000001,-73.989316,-74.026094,-73.97579500000001,-73.96212800000001,-73.959577,-73.954165,-73.95148500000001,-73.9464,-73.98835,-73.98522699999999,-73.903492,-73.82018600000001,-73.8837,-73.93171599999999,-73.904386,-73.920157,-74.12563,-73.80655,-73.768804,-73.83879,-73.93728,-73.939319,-73.945885,-73.92292500000001,-73.93129399999999,-73.952972,-73.94509100000001,-73.95224399999999,-73.95996100000001,-73.9258,-73.94683999999999,-73.96420999999999,-74.21247700000001,-74.256497,-74.26831799999999,-74.1254,-74.08794,-74.0914556,-74.11161800000001,-74.07495299999999,-74.2698,-74.38409,-74.35586000000001,-74.51219,-74.43384,-74.27719,-73.90179500000001,-73.945179,-74.01834700000001,-74.01824499999999,-74.074752,-74.038539,-73.891811,-73.83408],5,null,null,{\"interactive\":true,\"className\":\"\",\"stroke\":true,\"color\":[\"green\",\"green\",\"green\",\"red\",\"green\",\"green\",\"green\",\"green\",\"green\",\"red\",\"green\",\"green\",\"green\",\"red\",\"green\",\"red\",\"red\",\"red\",\"green\",\"green\",\"green\",\"green\",\"green\",\"green\",\"green\",\"green\",\"green\",\"green\",\"red\",\"green\",\"green\",\"green\",\"red\",\"green\",\"green\",\"green\",\"green\",\"red\",\"red\",\"green\",\"green\",\"green\",\"green\",\"green\",\"green\",\"green\",\"green\",\"green\",\"green\",\"red\",\"green\",\"red\",\"red\",\"red\",\"red\",\"red\",\"green\",\"green\",\"green\",\"green\",\"green\",\"green\",\"green\",\"green\",\"red\",\"red\",\"green\",\"green\",\"red\",\"red\",\"red\",\"red\",\"green\",\"red\",\"red\",\"green\",\"green\",\"green\",\"green\",\"green\",\"green\",\"red\",\"green\",\"green\",\"green\",\"green\",\"green\",\"green\",\"green\",\"green\",\"red\",\"green\",\"red\",\"red\",\"red\",\"red\",\"red\",\"green\",\"red\",\"red\",\"green\",\"red\",\"red\",\"red\",\"green\",\"red\",\"green\",\"green\",\"green\",\"green\",\"green\",\"green\",\"red\",\"green\",\"green\",\"red\",\"red\",\"green\",\"green\",\"red\",\"red\",\"green\",\"green\",\"green\",\"green\",\"green\",\"green\",\"green\",\"green\",\"red\",\"green\",\"green\",\"green\",\"green\",\"green\",\"green\",\"green\",\"red\",\"green\",\"green\",\"red\",\"green\",\"red\",\"red\"],\"weight\":5,\"opacity\":0.5,\"fill\":true,\"fillColor\":[\"green\",\"green\",\"green\",\"red\",\"green\",\"green\",\"green\",\"green\",\"green\",\"red\",\"green\",\"green\",\"green\",\"red\",\"green\",\"red\",\"red\",\"red\",\"green\",\"green\",\"green\",\"green\",\"green\",\"green\",\"green\",\"green\",\"green\",\"green\",\"red\",\"green\",\"green\",\"green\",\"red\",\"green\",\"green\",\"green\",\"green\",\"red\",\"red\",\"green\",\"green\",\"green\",\"green\",\"green\",\"green\",\"green\",\"green\",\"green\",\"green\",\"red\",\"green\",\"red\",\"red\",\"red\",\"red\",\"red\",\"green\",\"green\",\"green\",\"green\",\"green\",\"green\",\"green\",\"green\",\"red\",\"red\",\"green\",\"green\",\"red\",\"red\",\"red\",\"red\",\"green\",\"red\",\"red\",\"green\",\"green\",\"green\",\"green\",\"green\",\"green\",\"red\",\"green\",\"green\",\"green\",\"green\",\"green\",\"green\",\"green\",\"green\",\"red\",\"green\",\"red\",\"red\",\"red\",\"red\",\"red\",\"green\",\"red\",\"red\",\"green\",\"red\",\"red\",\"red\",\"green\",\"red\",\"green\",\"green\",\"green\",\"green\",\"green\",\"green\",\"red\",\"green\",\"green\",\"red\",\"red\",\"green\",\"green\",\"red\",\"red\",\"green\",\"green\",\"green\",\"green\",\"green\",\"green\",\"green\",\"green\",\"red\",\"green\",\"green\",\"green\",\"green\",\"green\",\"green\",\"green\",\"red\",\"green\",\"green\",\"red\",\"green\",\"red\",\"red\"],\"fillOpacity\":0.2},null,null,null,null,[\"<strong>Arthur Kill, Conference House Park<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Oakwood Beach<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>Bronx Kill, east end<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Wards Island<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>Bronx Kill, west end<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Wards Island<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>Bronx River, Bronx Botanical Gardens<\\/strong><br/>\\n Currently Testing? <\\/strong>FALSE<br/>\\n Sewershed: Hunts Point<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>Bronx River, Concrete Plant Park Canoe Launch<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Hunts Point<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>Bronx River, Hunts Point Riverside Park<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Hunts Point<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>Bronx River, Soundview Park (mouth)<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Hunts Point<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>Bronx River, Soundview Park, HP009 CSO<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Hunts Point<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>Bronx River, Starlight Park, North Dock<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Hunts Point<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>Bronx River, Starlight Park, south of dam<\\/strong><br/>\\n Currently Testing? <\\/strong>FALSE<br/>\\n Sewershed: Hunts Point<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>Buttermilk Channel, Pier 101, Governors Island<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Red Hook<br/>\\nUse: (marine waters) Swimming and other recreation and fishing\",\"<strong>Buttermilk Channel, Valentino Pier<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Red Hook<br/>\\nUse: (marine waters) Swimming and other recreation and fishing\",\"<strong>Coney Island Creek, Calvert Vaux Beach<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Coney Island<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>Coney Island Creek, Calvert Vaux Park<\\/strong><br/>\\n Currently Testing? <\\/strong>FALSE<br/>\\n Sewershed: Coney Island<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>Coney Island Creek, Kaiser Park<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Coney Island<br/>\\nUse: (marine waters) Swimming and other recreation and fishing\",\"<strong>Coney Island Creek, Shell Road (head of creek)<\\/strong><br/>\\n Currently Testing? <\\/strong>FALSE<br/>\\n Sewershed: Coney Island<br/>\\nUse: (marine waters) Swimming and other recreation and fishing\",\"<strong>Coney Island Creek, West 21st Street<\\/strong><br/>\\n Currently Testing? <\\/strong>FALSE<br/>\\n Sewershed: Coney Island<br/>\\nUse: (marine waters) Swimming and other recreation and fishing\",\"<strong>East River, Anable Basin<\\/strong><br/>\\n Currently Testing? <\\/strong>FALSE<br/>\\n Sewershed: Bowery Bay<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>East River, Brooklyn Bridge Beach, Manhattan<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Newtown Creek<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>East River, Bushwick Inlet<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Newtown Creek<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>East River, Bushwick Inlet Park Beach<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Newtown Creek<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>East River, Dumbo Cove<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Red Hook<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>East River, E 90th St Ferry<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Wards Island<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>East River, Esplanade (+Pool)<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Newtown Creek<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>East River, Gantry State Park<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Bowery Bay<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>East River, Grand Ferry Park<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Newtown Creek<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>East River, Hallets Cove<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Bowery Bay<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>East River, Hammond Creek (HC)<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Hunts Point<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>East River, Hermon A. MacNeil Park<\\/strong><br/>\\n Currently Testing? <\\/strong>FALSE<br/>\\n Sewershed: Tallmans Island<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>East River, India Street<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Newtown Creek<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>East River, Marsha P Johnson State Park<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Newtown Creek<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>East River, North 3rd Street<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Newtown Creek<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>East River, Pier 1, Brooklyn Bridge Park<\\/strong><br/>\\n Currently Testing? <\\/strong>FALSE<br/>\\n Sewershed: Red Hook<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>East River, Pier 2 Kayak Dock, Brooklyn Bridge Park<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Red Hook<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>East River, Pier 35 (+POOL), End-Pier<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Newtown Creek<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>East River, Pier 35 (+POOL), Mid-Pier<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Newtown Creek<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>East River, Pier 4 Beach, Brooklyn Bridge Park<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Red Hook<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>East River, Pier 42/Jackson Street<\\/strong><br/>\\n Currently Testing? <\\/strong>FALSE<br/>\\n Sewershed: Newtown Creek<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>East River, South 3rd Street/Domino Park<\\/strong><br/>\\n Currently Testing? <\\/strong>FALSE<br/>\\n Sewershed: Newtown Creek<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>East River, South 5th Street/Domino Park<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Newtown Creek<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>East River, South 8th St<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Newtown Creek<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>East River, Stuy Cove Park<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Newtown Creek<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>East River, SUNY Maritime Campus Entrance (IT)<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Hunts Point<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>East River, SUNY Maritime Waterfront Center (MAR)<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Hunts Point<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>East River, Wallabout Channel, Brooklyn Navy Yard<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Red Hook<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>East River, WNYC Transmitter Park<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Newtown Creek<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>Flushing Bay, 28th Avenue, Big Rock Beach<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Tallmans Island<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>Flushing Bay, World's Fair Marina Boat Ramp<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Bowery Bay<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>Flushing Bay, World's Fair Marina Pier 1 East<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Bowery Bay<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>Flushing Bay, World's Fair Marina Pier 1 West<\\/strong><br/>\\n Currently Testing? <\\/strong>FALSE<br/>\\n Sewershed: Bowery Bay<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>Flushing Creek<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Tallmans Island<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>Gowanus Canal, 2nd Avenue Salt Lot<\\/strong><br/>\\n Currently Testing? <\\/strong>FALSE<br/>\\n Sewershed: Owls Head<br/>\\nUse: (marine waters) Fishing but these waters may not support fish propagation\",\"<strong>Gowanus Canal, Bond Street<\\/strong><br/>\\n Currently Testing? <\\/strong>FALSE<br/>\\n Sewershed: Red Hook<br/>\\nUse: (marine waters) Fishing but these waters may not support fish propagation\",\"<strong>Gowanus Canal, Carroll Street<\\/strong><br/>\\n Currently Testing? <\\/strong>FALSE<br/>\\n Sewershed: Red Hook<br/>\\nUse: (marine waters) Fishing but these waters may not support fish propagation\",\"<strong>Gowanus Canal, Denton's Pond Outfall<\\/strong><br/>\\n Currently Testing? <\\/strong>FALSE<br/>\\n Sewershed: Owls Head<br/>\\nUse: (marine waters) Fishing but these waters may not support fish propagation\",\"<strong>Gowanus Canal, Lowlands Nursery<\\/strong><br/>\\n Currently Testing? <\\/strong>FALSE<br/>\\n Sewershed: Red Hook<br/>\\nUse: (marine waters) Fishing but these waters may not support fish propagation\",\"<strong>Gowanus Canal, Second Street Sponge Park<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Red Hook<br/>\\nUse: (marine waters) Fishing but these waters may not support fish propagation\",\"<strong>Gravesend Bay, Calvert Vaux Cove<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Owls Head<br/>\\nUse: (marine waters) Swimming and other recreation and fishing\",\"<strong>Gravesend Bay, OH-015<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Owls Head<br/>\\nUse: (marine waters) Swimming and other recreation and fishing\",\"<strong>Hackensack River, Bayonne City Park, Bayonne NJ<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: NJ<br/>\\nUse: NA\",\"<strong>Hackensack River, Laurel Hill Park, Secaucus NJ<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: NJ<br/>\\nUse: NA\",\"<strong>Hackensack River, Ridgefield Park, NJ<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: NJ<br/>\\nUse: NA\",\"<strong>Hackensack River, River Barge Park, Carlstadt NJ<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: NJ<br/>\\nUse: NA\",\"<strong>Hackensack River, Rutkowski Park, Bayonne NJ<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: NJ<br/>\\nUse: NA\",\"<strong>Harlem River, High Bridge<\\/strong><br/>\\n Currently Testing? <\\/strong>FALSE<br/>\\n Sewershed: Wards Island<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>Harlem River, Lincoln Avenue 1<\\/strong><br/>\\n Currently Testing? <\\/strong>FALSE<br/>\\n Sewershed: Wards Island<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>Harlem River, Lincoln Avenue 2<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Wards Island<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>Harlem River, Little Hell Gate<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Wards Island<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>Harlem River, Muscota Marsh<\\/strong><br/>\\n Currently Testing? <\\/strong>FALSE<br/>\\n Sewershed: North River<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>Harlem River, North Cove<\\/strong><br/>\\n Currently Testing? <\\/strong>FALSE<br/>\\n Sewershed: North River<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>Harlem River, North Cove Spring<\\/strong><br/>\\n Currently Testing? <\\/strong>FALSE<br/>\\n Sewershed: North River<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>Harlem River, Swindlers Cove/Peter J. Sharpe Boathouse<\\/strong><br/>\\n Currently Testing? <\\/strong>FALSE<br/>\\n Sewershed: North River<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>Harlem River, Water's Edge Garden Beach<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Wards Island<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>Hudson River, Beczak Beach #1<\\/strong><br/>\\n Currently Testing? <\\/strong>FALSE<br/>\\n Sewershed: NJ<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>Hudson River, Beczak Beach #2<\\/strong><br/>\\n Currently Testing? <\\/strong>FALSE<br/>\\n Sewershed: NJ<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>Hudson River, Frank Sinatra Park, Hoboken NJ<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: NJ<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>Hudson River, Gansevoort Peninsula South â€“ Middle<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: North River<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>Hudson River, Gansevoort Peninsula South â€“ Ramp<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: North River<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>Hudson River, Gansevoort Peninsula, North<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: North River<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>Hudson River, Gansevoort Peninsula, South<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: North River<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>Hudson River, Hoboken Cove Beach, Hoboken NJ<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: NJ<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>Hudson River, Inwood Canoe Club<\\/strong><br/>\\n Currently Testing? <\\/strong>FALSE<br/>\\n Sewershed: North River<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>Hudson River, JFK Marina<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: NJ<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>Hudson River, Pier 13, Hoboken, NJ<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: NJ<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>Hudson River, Pier 26<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Newtown Creek<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>Hudson River, Pier 40<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Newtown Creek<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>Hudson River, Pier 66<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: North River<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>Hudson River, Pier 84<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: North River<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>Hudson River, Pier 96<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: North River<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>Hudson River, Pier 99 Boat Launch<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: North River<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>Hudson River, Pier I/70th Street<\\/strong><br/>\\n Currently Testing? <\\/strong>FALSE<br/>\\n Sewershed: North River<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>Hudson River, Weehawken Cove, Hoboken NJ<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: NJ<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>Hudson River, West 100th Street<\\/strong><br/>\\n Currently Testing? <\\/strong>FALSE<br/>\\n Sewershed: North River<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>Hudson River, West 129th Street, St. Clair Place<\\/strong><br/>\\n Currently Testing? <\\/strong>FALSE<br/>\\n Sewershed: North River<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>Hudson River, West 133rd Street/Piers Park Kayak Dock<\\/strong><br/>\\n Currently Testing? <\\/strong>FALSE<br/>\\n Sewershed: North River<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>Hudson River, West 145th Street<\\/strong><br/>\\n Currently Testing? <\\/strong>FALSE<br/>\\n Sewershed: North River<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>Hudson River, West 154th Street<\\/strong><br/>\\n Currently Testing? <\\/strong>FALSE<br/>\\n Sewershed: North River<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>Hudson River, West 172nd Street, Riverside Park<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: North River<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>Hudson River, West 72nd Street Kayak Launch<\\/strong><br/>\\n Currently Testing? <\\/strong>FALSE<br/>\\n Sewershed: North River<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>Hudson River, West 79th Street Boat Basin<\\/strong><br/>\\n Currently Testing? <\\/strong>FALSE<br/>\\n Sewershed: North River<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>Hudson River, Yonkers Paddling and Rowing Club<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: NJ<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>Hutchinson River, Amtrak Bridge<\\/strong><br/>\\n Currently Testing? <\\/strong>FALSE<br/>\\n Sewershed: Hunts Point<br/>\\nUse: (marine waters) Swimming and other recreation and fishing\",\"<strong>Jamaica Bay, Canarsie Pier<\\/strong><br/>\\n Currently Testing? <\\/strong>FALSE<br/>\\n Sewershed: Coney Island<br/>\\nUse: (marine waters) Swimming and other recreation and fishing\",\"<strong>Jamaica Bay, Gerritsen Creek Kayak Launch (Marine Park Salt Marsh)<\\/strong><br/>\\n Currently Testing? <\\/strong>FALSE<br/>\\n Sewershed: Coney Island<br/>\\nUse: (marine waters) Swimming and other recreation and fishing\",\"<strong>Jamaica Bay, Paerdegat Basin, Sebago Canoe Club<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Coney Island<br/>\\nUse: (marine waters) Swimming and other recreation and fishing\",\"<strong>Jamaica Bay, Plumb Beach<\\/strong><br/>\\n Currently Testing? <\\/strong>FALSE<br/>\\n Sewershed: Coney Island<br/>\\nUse: (marine waters) Swimming and other recreation and fishing\",\"<strong>Kill Van Kull, Bradyâ€™s Dock, Bayonne NJ<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: NJ<br/>\\nUse: NA\",\"<strong>Kissena Lake<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Tallmans Island<br/>\\nUse: Swimming and other recreation and fishing\",\"<strong>Little Neck Bay<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Tallmans Island<br/>\\nUse: (marine waters) Swimming and other recreation and fishing\",\"<strong>Meadow Lake, Flushing Meadows-Corona Park<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Bowery Bay<br/>\\nUse: Swimming and other recreation and fishing\",\"<strong>Newtown Creek, Apollo Street<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Newtown Creek<br/>\\nUse: (marine waters) Fishing but these waters may not support fish propagation\",\"<strong>Newtown Creek, Dutch Kills (head)<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Bowery Bay<br/>\\nUse: (marine waters) Fishing but these waters may not support fish propagation\",\"<strong>Newtown Creek, Dutch Kills (mouth)<\\/strong><br/>\\n Currently Testing? <\\/strong>FALSE<br/>\\n Sewershed: Bowery Bay<br/>\\nUse: (marine waters) Fishing but these waters may not support fish propagation\",\"<strong>Newtown Creek, East Branch<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Newtown Creek<br/>\\nUse: (marine waters) Fishing but these waters may not support fish propagation\",\"<strong>Newtown Creek, English Kills<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Newtown Creek<br/>\\nUse: (marine waters) Fishing but these waters may not support fish propagation\",\"<strong>Newtown Creek, North Brooklyn Community Boathouse/Pulaski Bridge<\\/strong><br/>\\n Currently Testing? <\\/strong>FALSE<br/>\\n Sewershed: Newtown Creek<br/>\\nUse: (marine waters) Fishing but these waters may not support fish propagation\",\"<strong>Newtown Creek, North Henry Street<\\/strong><br/>\\n Currently Testing? <\\/strong>FALSE<br/>\\n Sewershed: Newtown Creek<br/>\\nUse: (marine waters) Fishing but these waters may not support fish propagation\",\"<strong>Newtown Creek, Pulaski Bridge, Queens<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Bowery Bay<br/>\\nUse: (marine waters) Fishing but these waters may not support fish propagation\",\"<strong>Newtown Creek, Second Street Kayak Launch<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Bowery Bay<br/>\\nUse: (marine waters) Fishing but these waters may not support fish propagation\",\"<strong>Newtown Creek, Turning Basin<\\/strong><br/>\\n Currently Testing? <\\/strong>FALSE<br/>\\n Sewershed: Newtown Creek<br/>\\nUse: (marine waters) Fishing but these waters may not support fish propagation\",\"<strong>Newtown Creek, Whale Creek<\\/strong><br/>\\n Currently Testing? <\\/strong>FALSE<br/>\\n Sewershed: Newtown Creek<br/>\\nUse: (marine waters) Fishing but these waters may not support fish propagation\",\"<strong>Prospect Park Lake<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Owls Head<br/>\\nUse: Swimming and other recreation and fishing\",\"<strong>Rahway River, Carteret Waterfront Park<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: NJ<br/>\\nUse: NA\",\"<strong>Rahway River, Rahway Valley Sewerage Authority<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: NJ<br/>\\nUse: NA\",\"<strong>Rahway River, Riverfront Park<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: NJ<br/>\\nUse: NA\",\"<strong>Raritan Bay, Great Kills Beach<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Oakwood Beach<br/>\\nUse: (marine waters) Swimming and other recreation and fishing\",\"<strong>Raritan Bay, Midlland Beach<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Oakwood Beach<br/>\\nUse: (marine waters) Swimming and other recreation and fishing\",\"<strong>Raritan Bay, New Dorp Beach<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Oakwood Beach<br/>\\nUse: (marine waters) Swimming and other recreation and fishing\",\"<strong>Raritan Bay, Oakwood Beach<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Oakwood Beach<br/>\\nUse: (marine waters) Swimming and other recreation and fishing\",\"<strong>Raritan Bay, South Beach<\\/strong><br/>\\n Currently Testing? <\\/strong>FALSE<br/>\\n Sewershed: Oakwood Beach<br/>\\nUse: (marine waters) Swimming and other recreation and fishing\",\"<strong>Raritan Bay, Waterfront Park, South Amboy, NJ<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: NJ<br/>\\nUse: NA\",\"<strong>Raritan River, Edison Boat Basin, Edison NJ<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: NJ<br/>\\nUse: NA\",\"<strong>Raritan River, Ken Buchanan Park, Sayreville NJ<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: NJ<br/>\\nUse: NA\",\"<strong>Raritan River, Riverside Park, Piscataway NJ<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: NJ<br/>\\nUse: NA\",\"<strong>Raritan River, Rutgers Boathouse, New Brunswick NJ<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: NJ<br/>\\nUse: NA\",\"<strong>Raritan River, Second Street Park, Perth Amboy NJ<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: NJ<br/>\\nUse: NA\",\"<strong>Saw Mill River, daylighted section<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: NJ<br/>\\nUse: (marine waters) Swimming and other recreation and fishing\",\"<strong>Sheepshead Bay<\\/strong><br/>\\n Currently Testing? <\\/strong>FALSE<br/>\\n Sewershed: Coney Island<br/>\\nUse: (marine waters) Secondary contact recreation and fishing\",\"<strong>Upper Harbor, Bush Terminal Park (Inner Lagoon)<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Owls Head<br/>\\nUse: (marine waters) Swimming and other recreation and fishing\",\"<strong>Upper Harbor, Bush Terminal Park (North Embayment)<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Owls Head<br/>\\nUse: (marine waters) Swimming and other recreation and fishing\",\"<strong>Upper Harbor, North Shore Esplanade<\\/strong><br/>\\n Currently Testing? <\\/strong>FALSE<br/>\\n Sewershed: Port Richmond<br/>\\nUse: (marine waters) Swimming and other recreation and fishing\",\"<strong>Upper Harbor, Pier 69<\\/strong><br/>\\n Currently Testing? <\\/strong>TRUE<br/>\\n Sewershed: Owls Head<br/>\\nUse: (marine waters) Swimming and other recreation and fishing\",\"<strong>Van Cortlandt Park Lake<\\/strong><br/>\\n Currently Testing? <\\/strong>FALSE<br/>\\n Sewershed: Wards Island<br/>\\nUse: Swimming and other recreation and fishing\",\"<strong>Willow Lake, Flushing Meadows-Corona Park<\\/strong><br/>\\n Currently Testing? <\\/strong>FALSE<br/>\\n Sewershed: Bowery Bay<br/>\\nUse: Swimming and other recreation and fishing\"],{\"interactive\":false,\"permanent\":false,\"direction\":\"auto\",\"opacity\":1,\"offset\":[0,0],\"textsize\":\"10px\",\"textOnly\":false,\"className\":\"\",\"sticky\":true},null]}],\"limits\":{\"lat\":[40.47483,40.9566318],\"lng\":[-74.51219,-73.768804]}},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n\n\n\nThe data contains the \"sewershed\" for each site. Sewersheds are areas of the city that drain into the rivers from a particular section of the sewer system and treatment plant. It may be that particular sewersheds are more likely to overflow during heavy rain and thus more prone to high bacteria levels. We shall see.\n\n<iframe width=\"100%\" height=\"520\" frameborder=\"0\" src=\"https://openseweratlas.tumblr.com/dryweathermap\">\n\n</iframe>\n\nA problem we often face with prediction models is the data is not nicely distributed. Bacteria levels in our dataset are very skewed. We get a more balanced distribution if we bin the levels into DEP quality categories. We will use this as our target variable for prediction.\n\n::: {layout-ncol=\"2\"}\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# ggplot histogram of bacteria levels\nwq_data |>\n  ggplot(aes(x = bacteria)) +\n  geom_histogram(bins = 30,fill = \"lightblue\") +\n  labs(title = \"Histogram of Bacteria Levels\",\n       x = \"Bacteria Levels\",\n       y = \"Count\") +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](oyster_files/figure-html/bacteria_hist-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# ggplot histogram of quality levels\nwq_data |>\n  ggplot(aes(x = quality)) +\n  geom_bar(fill = \"lightblue\") +\n  labs(title = \"Histogram of Bacteria Quality Levels\",\n       x = \"Quality Levels\",\n       y = \"Count\") +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](oyster_files/figure-html/quality_hist-1.png){width=672}\n:::\n:::\n\n\n\n:::\n\nSimilarly, we can look at the distributions for the other numeric features in our dataset. We have already converted month numbers into a seasonality feature so we won't use \"month\" as a predictor. We see that most of the observations happen in the warm months.\n\nPrecipitation shows a skewed distribution. This is an example of how EDA can help us think about the model features. Most days it does not rain but the wider time windows are slightly more evenly distributed, so let's just use the precipitation for the entire prior week in the model.\n\nTide times are evenly distributed, as we would expect.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# distribution of numeric features\nwq_data |>\n  ungroup() |>\n  select(-year,-bacteria) |>\n  select(is.numeric) |>\n  gather() |>\n  ggplot(aes(x = value)) +\n  geom_histogram(bins=20,fill = \"lightblue\") +\n  facet_wrap(~key, scales = \"free\") +\n  labs(title = \"Distribution of All Numeric Variables\",\n       y = \"Count\",x=\"\") +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](oyster_files/figure-html/feature_dist-1.png){width=672}\n:::\n:::\n\n\n\n\nWe might be interested in examining quality trends over time. This has to be done with caution because the number of reporting stations has increased over time, excepting during the COVID crisis. Let's look at trends using only those stations that have been reporting for the last ten years. We add annual rainfall to see if there is any obvious correlation. Alas, water quality (defined as bacteria levels) has not been improving in the last decade.\n\n::: {layout-ncol=\"2\"}\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# show that reporting stations have increased over time\nwq_data |>\n  mutate(year = year(date)) |>\n  group_by(year) |>\n  summarise(n = n_distinct(site_id)) |>\n  ggplot(aes(x = year, y = n)) +\n  geom_col(fill = \"lightblue\") +\n  labs(title = \"Reporting Stations Have Steadily Increased\",\n       x = \"Year\",\n       y = \"Number of Stations\") +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](oyster_files/figure-html/stations-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# get average daily rainfall by year\nannl_rain <- wq_data |>\n  group_by(year) |>\n  summarise(annual_rainfall = mean(precip_week,na.rm = TRUE)*52)\n\n\n# plot median bacteria levels over time only for sites that have been reporting for the all time periods\nwq_10 <- wq_data |>\n  # filter out stations that have been reporting for less than 10 years\n  group_by(site) |>\n  summarise(n_years = n_distinct(year)) |>\n  filter(n_years > 9) |>\n  select(site) |>\n  inner_join(wq_data, by = \"site\") |>\n  ungroup() |>\n  filter(year(date) > year(Sys.Date())-11)\n\nlast_obs <- wq_data$date |> max()\nfirst_obs <- year(last_obs)-10\nrain_axis <-1\n\nwq_10 |>\n  ungroup() |>\n  filter(year > 2011) |>\n  summarise(.by = year, median_bacteria = median(bacteria)) |>\n  left_join(annl_rain) |>\n  arrange(year) |>\n  ggplot(aes(x = year, y = median_bacteria)) + geom_col(fill = \"lightblue\") +\n  geom_line(aes(x = year, y = annual_rainfall), color = \"blue\") +\n  geom_hline(yintercept = 34, color = \"red\") +\n  annotate(\"text\", x = 2016, y = 34, label = '\"Safe\" Level = 34 Colonies', vjust = -1) +\n  # label the y-axes\n  scale_x_continuous(breaks = seq(2000,2024,1)) +\n  # put totat_rainfall on secondary y-axis\n  scale_y_continuous(sec.axis = sec_axis(~./rain_axis, name = \"Annual Rainfall (Blue Line\")) +\n  labs(y = \"Median Bacteria Concentration (Blue Bar)\",\n       title= str_to_title(\"water is not getting cleaner over time\"),\n       subtitle = glue::glue(\"Sites in NY Harbor Reporting Continuously from {first_obs} to {last_obs}\")\n  ) +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](oyster_files/figure-html/rain vs quality-1.png){width=672}\n:::\n:::\n\n\n\n:::\n\nIn addition to numeric variables we have several categorical (aka \"factor\") variables in the dataset. Each sampling site has a unique identifier, an associated sewershed, the body of water it is in (e.g. Hudson River) and a classification of suitable usage of the water body (e.g. fishing, swimming, etc).\n\nMore recently, the dataset has included the lab that did the water analysis. It might be interesting to see if a lab bias exists but fewer than half the observations have this information, so we don't expect much.\n\nAre some sites cleaner or dirtier than others? Yes. As we would expect, sites in water bodies with more flow are cleaner.\n\n::: {layout-ncol=\"2\"}\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# show boxplot of cleanest and dirtiest ----------------------------------------\nsite_boxplots <- function(wq_data, label = \"Cleanest\") {\n  median_all <- median(wq_data$bacteria)\n  # show a boxplot of bacteria concentration by site\n  selected_sites <- wq_data |>\n    # avoid Inf log values\n    # mutate(bacteria = bacteria + .001) |>\n    # mutate(bacteria = ifelse(bacteria == 0, 1, bacteria)) |> \n    group_by(site) |>\n    nest() |>\n    rowwise() |>\n    mutate(n_obs = nrow(data)) |>\n    filter(n_obs > 100) |>\n    mutate(median_bacteria = median(data$bacteria)) |>\n    ungroup()\n\n  if (label == \"Cleanest\") {\n    selected_sites <- slice_min(selected_sites, order_by = median_bacteria, n = 10)\n  } else {\n    selected_sites <- slice_max(selected_sites, order_by = median_bacteria, n = 10)\n  }\n\n  selected_sites |>\n    unnest(data) |>\n    ggplot(aes(x = reorder(factor(site), median_bacteria), y = bacteria)) +\n    scale_y_log10(oob = scales::squish_infinite) +\n    geom_boxplot(fill = \"lightblue\") +\n    # geom_violin(draw_quantiles = .5) +\n    # geom_jitter(width = .1) +\n    # annotate(\"text\", x = log(SAFE)-2, y = 1500, label = \"Safe Levels\", color = \"darkgreen\") +\n\n    labs(\n      title = glue::glue(\"{label} Sites\"),\n      subtitle = \"Based on Median Bacteria Count\",\n      x = \"Site\",\n      y = \"Boxplot of Enterococci Concentration\\n(Log Scale)\"\n    ) +\n    coord_flip() +\n    geom_hline(yintercept = SAFE,\n               color = \"red\",\n               linewidth = 2) +\n    annotate(\n      \"label\",\n      x = 9,\n      y = SAFE,\n      label = \"Safe\\nLevel\",\n      color = \"red\"\n    ) +\n    theme_minimal()\n}\n\nsite_boxplots(wq_data, \"Cleanest\")\n```\n\n::: {.cell-output-display}\n![](oyster_files/figure-html/cleanest sites-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nsite_boxplots(wq_data, \"Dirtiest\")\n```\n\n::: {.cell-output-display}\n![](oyster_files/figure-html/dirtest_sites-1.png){width=672}\n:::\n:::\n\n\n\n:::\n\n## Let's Build a Model!\n\nNext to linear regression, random forests are one of the most popular machine learning algorithms. Random forests are a type of learning method, where multiple decision trees are trained on different subsets of the data and then combined to make a prediction. Since random forests can handle a mix of categorical and numeric variables they are ideal for our dataset. You can learn more about this class of models [here](https://www.ibm.com/topics/random-forest). The `tidymodels` suite of packages from [posit.co](https://posit.co/) makes it easy to build and test a random forest model in R.\n\nModels can easily [describe]{.underline} any data set but we are interested in [predicting]{.underline} out of sample data. To do this we need to split our data into a training set and a testing set. We will use the training set to build the model and the testing set to evaluate the model's ability to predict. We have over 13,000 individual samples across all dates and sites. Our training set is a sort-of random sample of 75% of the data. I say \"sort of\" because we need stratify the split so that the same proportion of \"SAFE\", \"CAUTION\" and \"UNSAFE\" samples are in both the training and testing sets.\n\nAt this point we are ready to set up the model. The tidymodels framework involves creating a workflow that starts with a model, then a \"recipe\" for preproccessing the data and finally a \"fit\" stage where the model is trained on the data. This framework makes it easy to try out different models and different recipes. We'll use the random forest model in the `ranger` package. The recipe will normalize all the numeric variables. This will help with the skewness of the precipitation data.\n\nSelect data, add model, add recipe and fit. That's it? Well, the coding is the easy part. In truth, there is a lot to think about in deciding what machine learning algorithm is best suited to the task, how to transform the inputs for imbalanced data and how to tune the model. The good news is the tidymodels framework makes it easy to experiment with different approaches. Check out the [tidymodels site](https://www.tidymodels.org/start/) for a doorway to the rabbit hole of machine learning in R.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Model ------------------------------------------------------------------------\n# select only variables for model\nwq_subset <- wq_data |>\n  # make year a category, rather than numeric\n  mutate(year = as.factor(year)) |> \n  select(\n    quality,\n    site_id,\n    year,\n    time_since_high_tide,\n    # precip_t0,\n    # precip_48,\n    # precip_earlier,\n    precip_week,\n    water_body,\n    water_class,\n    sewershed,\n    lab\n  ) |>\n  # remove rows with missing values\n  drop_na()\n\n# or...we could aggregate the precipitation data\n# wq_subset <- wq_subset |>\n#   #sum across all precip columns\n#   mutate(precip_total = precip_t0 + precip_48 + precip_earlier) |>\n#   select(-c(precip_t0, precip_48, precip_earlier))\n\n# seeding the random number generator ensures reproducibility\nset.seed(123)\n# split data into training and testing sets\nwq_split <- initial_split(wq_subset, prop = 0.75, strata = quality)\nwq_train <- training(wq_split)\nwq_test <- testing(wq_split)\n\n# choose the model\nwq_rf <- rand_forest() |>\n  set_engine(\"ranger\",importance = \"impurity\") |>\n  set_mode(\"classification\")\n\n# create a recipe\nwq_recipe <- recipe(quality ~ ., data = wq_train) |>\n  step_normalize(all_numeric_predictors())\n\n# combine into a workflow\nwq_wf <- workflow() |>\n  add_model(wq_rf) |>\n  add_recipe(wq_recipe)\n\n# fit with training data\nwq_fit<- wq_wf |>\n  fit(data = wq_train)\n```\n:::\n\n\n\n\nUnlike linear regression, random forests are not easily interpretable. We can't just look at the coefficients to see how each variable contributes to the prediction. After fitting to our training set, we can look at the variable importance plot. This plot shows the relative contribution of each variable to the prediction. Still, we don't know the direction of the relationship or the strength of the relationship. We can only say that the variable is important in predicting the outcome.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# show variable importance\nwq_fit |>\n  extract_fit_parsnip() |>\n  vip::vip(aesthetics = list(fill = \"lightblue\")) +\n  labs(title = \"Water Quality Variable Importance\",\n       subtitle = 'Random Forest Classifier to Predict \"Safe\", \"Caution\" or \"Unsafe ') +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](oyster_files/figure-html/variable importance-1.png){width=672}\n:::\n:::\n\n\n\n\nRainfall looks to be the most important variable, followed by tide time and site location. Surprisingly, the sewershed and water body are far down the list. The more specific location factor, `site_id` contributes more. Again, this is not like linear regression, but if we look at the correlation of just rainfall and quality, there is some relation. This reinforces our intuition that CSOs are a driver of pollution.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwq_subset |>\n  summarise(.by = quality, median_precip = median(precip_week)) |>\n  ggplot(aes(quality, median_precip)) +\n  geom_col(fill = \"lightblue\") +\n  labs(subtitle = \"Median Weekly Precipitation by Water Quality\",\n       title = \"More Rain, More Bacteria\",\n       x = \"Water Quality\",\n       y = \"Median Weekly Precipitation (inches)\") +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](oyster_files/figure-html/rain vs bacteria-1.png){width=672}\n:::\n:::\n\n\n\n\nAs noted above, we expect to get a good fit in-sample since we are really just describing the training set. The output of the the model is expressed as the liklihood each observation is from the \"Safe\", \"Caution\" or \"Unsafe\" class. We can plot the predicted probability of each class for each observation. The plot below shows the predicted probability of each class for each observation in the training set. The color of the points indicates the actual class. The diagonal line is where the predicted probability equals the actual probability. The further the points are from the line, the less confident the model is in its prediction.\n\nFor example, in the chart below, the \"SAFE\" panel contains all the observations where the bacteria level is in the \"SAFE\" range. The dots in the lower right corner are the observations where the model is nearly certain of it's prediction, 100% likely that the water is \"SAFE\" and 0% likely the water is \"UNSAFE.\" The balance of the dots are in the correct quadrant so our description of the training set is pretty good.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# plot prediction confidence\nwq_pred_train <- wq_fit |>\n  augment(new_data = wq_train)\n\nwq_pred_train |>\n  ggplot(aes(x = .pred_Safe, y = .pred_Unsafe, color = quality)) +\n  facet_wrap(~quality) +\n  geom_point() +\n  geom_abline() +\n  scale_color_manual(values = c(\"green\", \"orange\",\"red\")) +\n  labs(title = \"Prediction Confidence\",\n       subtitle = \"It's easy to get a good fit in-sample.\",\n       x = \"Probablility Actual Is Safe\",\n       y = \"Probablility Actual Is Unsafe\")\n```\n\n::: {.cell-output-display}\n![](oyster_files/figure-html/plot fit for training set-1.png){width=672}\n:::\n:::\n\n\n\n\n## Is the Model Any Good?\n\nNow let's fit the model to the testing set and see how well it predicts the out-of-sample data. While the larger mass of points seems to be in the correct quadrants there are many observations where the model is very confident, but wrong.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# plot prediction confidence\nwq_pred <- wq_fit |>\n  augment(new_data = wq_test)\n\nxt <- wq_pred |>\n  conf_mat(truth = quality, estimate = .pred_class) |>\n  # return just the confusion matrix\n  pluck(\"table\") |>\n  as_tibble() |>\n  group_by(Prediction) |>\n  mutate(.prop = n/sum(n)) |>\n  ungroup()\n\nsafe_risk <- xt |>\n  filter(Prediction == \"Safe\",Truth == \"Safe\") |>\n  pull(.prop) |> prod(100) |> round()\n\nunsafe_risk <- xt |>\n  filter(Prediction == \"Safe\",Truth == \"Unsafe\") |>\n  pull(.prop) |> prod(100) |> round()\n\nwq_pred |>\n  ggplot(aes(x = .pred_Safe, y = .pred_Unsafe, color = quality)) +\n  facet_wrap(~quality) +\n  geom_point() +\n  geom_abline() +\n  scale_color_manual(values = c(\"green\", \"orange\",\"red\")) +\n  labs(title = \"Prediction Confidence\",\n       subtitle = \"Many predictions are confidently wrong.\",\n       x = \"Probablility Actual Is Safe\",\n       y = \"Probablility Actual Is Unsafe\")\n```\n\n::: {.cell-output-display}\n![](oyster_files/figure-html/plot fit for test set-1.png){width=672}\n:::\n:::\n\n\n\n\nWe can more precisely quantify the performance of the model with a \"truth table.\" Here we see the actual and predicted counts of each class. Given a prediction, how likely is it to be correct? 62% of the \"SAFE\" predictions were correct, but 18% of the times when the model said the water was \"SAFE\" if was actually \"UNSAFE,\" which is probably the most problematic result. Would I swim in \"safe\" water where there is a 18% chance I might get sick? No. The model also has very little ability to identify \"CAUTION\" conditions. In fairness, the range of bacteria levels between \"SAFE\" and \"UNSAFE\" is very narrow so we expect that only slight changes in conditions would tip the observation into another category.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# show a confusion matrix\nxt <- wq_pred |>\n  conf_mat(truth = quality, estimate = .pred_class) |>\n  # return just the confusion matrix\n  pluck(\"table\") |>\n  as_tibble() |>\n  group_by(Prediction) |>\n  mutate(.prop = n/sum(n)) |>\n  ungroup()\n\nxt_count <- xt |>\n  select(-.prop) |>\n  pivot_wider(names_from = Truth,values_from = n) |>\n  rowwise() |>\n  mutate(Total = sum(c(Safe,Caution,Unsafe)))\n\ngt_domain <- xt_count |> select(-Total,-Prediction) |> max()\n\nxt_prop <- xt |>\n  select(-n) |>\n  pivot_wider(names_from = Truth,values_from = .prop) |>\n  rowwise() |>\n  mutate(Total = sum(c(Safe,Caution,Unsafe)))\n\n\ntruth_table <- function(xt,type = c(\"count\")){\n  gt_xt <- xt |>\n    gt(rowname_col = \"Prediction\") |>\n    tab_header(title = \"Truth Table\") |>\n    tab_spanner(label = \"Truth\", columns = where(is.numeric)) |>\n    # add stub header label\n    tab_stubhead(label = \"Prediction\")\n\n  if(type == \"prop\"){\n    gt_xt <- gt_xt |> fmt_percent(columns = where(is.numeric),decimals = 0)\n  } else {\n    gt_xt <- gt_xt |> fmt_number(columns = where(is.numeric),decimals = 0) |>\n      grand_summary_rows(\n        fns = list(id=\"Total\",label = \"Total\") ~ sum(.)\n\n      ) |>\n      tab_style(\n        style = cell_text(weight = \"bold\"),\n        locations = list(cells_stub_grand_summary(rows = \"Total\"))\n      )\n\n  }\n  # fmt_number(columns = where(is.numeric),decimals = 0) |>\n  # fmt_percent(columns = where(is.numeric),decimals = 0) |>\n  # color the cells with a heat map\n  gt_xt <- gt_xt |>\n    data_color(columns = 2:4,\n               direction = c(\"row\"),\n               domain = c(0,if_else(type == \"count\",gt_domain,1)),\n               method = \"numeric\",\n               palette = \"Blues\") |>\n    # color prediction labels\n    tab_style(\n      style = list(cell_fill(color = \"green\"),cell_text(color = \"black\")),\n      locations = list(cells_column_labels(\"Safe\"),\n                       cells_body(column = 1,row = 1))\n    ) |>\n    tab_style(\n      style = list(cell_fill(color = \"yellow\"),cell_text(color = \"blaCk\")),\n      locations = list(cells_column_labels(\"Caution\"),\n                       cells_body(column = 1,row = 2))\n    ) |>\n    tab_style(\n      style = list(cell_fill(color = \"red\"),cell_text(color = \"white\")),\n      locations = list(cells_column_labels(\"Unsafe\"),\n                       cells_body(column = 1,row = 3))\n    ) |>\n    # color Truth labels\n    tab_style(\n      style = list(cell_fill(color = \"green\"),cell_text(color = \"black\")),\n      locations = cells_stub(\"Safe\")\n    ) |>\n    tab_style(\n      style = list(cell_fill(color = \"yellow\"),cell_text(color = \"black\")),\n      locations = cells_stub(\"Caution\")\n    ) |>\n    tab_style(\n      style = list(cell_fill(color = \"red\"),cell_text(color = \"white\")),\n      locations = cells_stub(\"Unsafe\")\n    )  |>\n    tab_style(\n      style = cell_text(weight = \"bold\"),\n      locations = list(cells_body(columns = 1),\n                       cells_column_labels(),\n                       cells_column_spanners(),\n                       cells_title(),\n                       cells_stub(),\n                       cells_stubhead())\n    )\n  return(gt_xt)\n}\n\nroc <- wq_pred |>\n  roc_auc(truth = quality, .pred_Safe,.pred_Caution,.pred_Unsafe)\n\ntruth_table(xt_prop,\"prop\")\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div id=\"whyaylitys\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>#whyaylitys table {\n  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n}\n\n#whyaylitys thead, #whyaylitys tbody, #whyaylitys tfoot, #whyaylitys tr, #whyaylitys td, #whyaylitys th {\n  border-style: none;\n}\n\n#whyaylitys p {\n  margin: 0;\n  padding: 0;\n}\n\n#whyaylitys .gt_table {\n  display: table;\n  border-collapse: collapse;\n  line-height: normal;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#whyaylitys .gt_caption {\n  padding-top: 4px;\n  padding-bottom: 4px;\n}\n\n#whyaylitys .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#whyaylitys .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 3px;\n  padding-bottom: 5px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#whyaylitys .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#whyaylitys .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#whyaylitys .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#whyaylitys .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#whyaylitys .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#whyaylitys .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#whyaylitys .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#whyaylitys .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#whyaylitys .gt_spanner_row {\n  border-bottom-style: hidden;\n}\n\n#whyaylitys .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  text-align: left;\n}\n\n#whyaylitys .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#whyaylitys .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#whyaylitys .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#whyaylitys .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#whyaylitys .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#whyaylitys .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#whyaylitys .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#whyaylitys .gt_row_group_first th {\n  border-top-width: 2px;\n}\n\n#whyaylitys .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#whyaylitys .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#whyaylitys .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#whyaylitys .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#whyaylitys .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#whyaylitys .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#whyaylitys .gt_last_grand_summary_row_top {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: double;\n  border-bottom-width: 6px;\n  border-bottom-color: #D3D3D3;\n}\n\n#whyaylitys .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#whyaylitys .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#whyaylitys .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#whyaylitys .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#whyaylitys .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#whyaylitys .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#whyaylitys .gt_left {\n  text-align: left;\n}\n\n#whyaylitys .gt_center {\n  text-align: center;\n}\n\n#whyaylitys .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#whyaylitys .gt_font_normal {\n  font-weight: normal;\n}\n\n#whyaylitys .gt_font_bold {\n  font-weight: bold;\n}\n\n#whyaylitys .gt_font_italic {\n  font-style: italic;\n}\n\n#whyaylitys .gt_super {\n  font-size: 65%;\n}\n\n#whyaylitys .gt_footnote_marks {\n  font-size: 75%;\n  vertical-align: 0.4em;\n  position: initial;\n}\n\n#whyaylitys .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#whyaylitys .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#whyaylitys .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#whyaylitys .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#whyaylitys .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#whyaylitys .gt_indent_5 {\n  text-indent: 25px;\n}\n\n#whyaylitys .katex-display {\n  display: inline-flex !important;\n  margin-bottom: 0.75em !important;\n}\n\n#whyaylitys div.Reactable > div.rt-table > div.rt-thead > div.rt-tr.rt-tr-group-header > div.rt-th-group:after {\n  height: 0px !important;\n}\n</style>\n<table class=\"gt_table\" data-quarto-disable-processing=\"false\" data-quarto-bootstrap=\"false\">\n  <thead>\n    <tr class=\"gt_heading\">\n      <td colspan=\"5\" class=\"gt_heading gt_title gt_font_normal gt_bottom_border\" style=\"font-weight: bold;\">Truth Table</td>\n    </tr>\n    \n    <tr class=\"gt_col_headings gt_spanner_row\">\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_left\" rowspan=\"2\" colspan=\"1\" style=\"font-weight: bold;\" scope=\"col\" id=\"a::stub\">Prediction</th>\n      <th class=\"gt_center gt_columns_top_border gt_column_spanner_outer\" rowspan=\"1\" colspan=\"4\" style=\"font-weight: bold;\" scope=\"colgroup\" id=\"Truth\">\n        <div class=\"gt_column_spanner\">Truth</div>\n      </th>\n    </tr>\n    <tr class=\"gt_col_headings\">\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" style=\"background-color: #00FF00; color: #000000; font-weight: bold;\" scope=\"col\" id=\"Safe\">Safe</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" style=\"background-color: #FFFF00; color: #000000; font-weight: bold;\" scope=\"col\" id=\"Caution\">Caution</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" style=\"background-color: #FF0000; color: #FFFFFF; font-weight: bold;\" scope=\"col\" id=\"Unsafe\">Unsafe</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" style=\"font-weight: bold;\" scope=\"col\" id=\"Total\">Total</th>\n    </tr>\n  </thead>\n  <tbody class=\"gt_table_body\">\n    <tr><th id=\"stub_1_1\" scope=\"row\" class=\"gt_row gt_left gt_stub\" style=\"background-color: #00FF00; color: #000000; font-weight: bold;\">Safe</th>\n<td headers=\"stub_1_1 Safe\" class=\"gt_row gt_right\" style=\"background-color: #4493C7; color: #FFFFFF;\">62%</td>\n<td headers=\"stub_1_1 Caution\" class=\"gt_row gt_right\" style=\"background-color: #D0E2F2; color: #000000;\">20%</td>\n<td headers=\"stub_1_1 Unsafe\" class=\"gt_row gt_right\" style=\"background-color: #D3E3F3; color: #000000;\">18%</td>\n<td headers=\"stub_1_1 Total\" class=\"gt_row gt_right\">100%</td></tr>\n    <tr><th id=\"stub_1_2\" scope=\"row\" class=\"gt_row gt_left gt_stub\" style=\"background-color: #FFFF00; color: #000000; font-weight: bold;\">Caution</th>\n<td headers=\"stub_1_2 Safe\" class=\"gt_row gt_right\" style=\"background-color: #94C4DF; color: #000000;\">40%</td>\n<td headers=\"stub_1_2 Caution\" class=\"gt_row gt_right\" style=\"background-color: #BAD6EB; color: #000000;\">29%</td>\n<td headers=\"stub_1_2 Unsafe\" class=\"gt_row gt_right\" style=\"background-color: #B3D3E8; color: #000000;\">31%</td>\n<td headers=\"stub_1_2 Total\" class=\"gt_row gt_right\">100%</td></tr>\n    <tr><th id=\"stub_1_3\" scope=\"row\" class=\"gt_row gt_left gt_stub\" style=\"background-color: #FF0000; color: #FFFFFF; font-weight: bold;\">Unsafe</th>\n<td headers=\"stub_1_3 Safe\" class=\"gt_row gt_right\" style=\"background-color: #D6E6F4; color: #000000;\">17%</td>\n<td headers=\"stub_1_3 Caution\" class=\"gt_row gt_right\" style=\"background-color: #D4E4F4; color: #000000;\">18%</td>\n<td headers=\"stub_1_3 Unsafe\" class=\"gt_row gt_right\" style=\"background-color: #3B89C2; color: #FFFFFF;\">66%</td>\n<td headers=\"stub_1_3 Total\" class=\"gt_row gt_right\">100%</td></tr>\n  </tbody>\n  \n  \n</table>\n</div>\n```\n\n:::\n:::\n\n\n\n\nAnother common way to visualize the performance of a model is with a \"receiver operator characteristic\" (ROC) curve. The ROC curve shows the trade off between true positives and false positives for each class. The larger the area under the curves (AUC), the better the model. An AUC of 1.0 is perfect while 0.5 is what random chance would show. In our case we have a combined AUC of 0.73, which is better than useless but not great.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# plot a ROC curve\n\nwq_pred |>\n  roc_curve(truth = quality, .pred_Safe,.pred_Caution,.pred_Unsafe) |>\n  ggplot(aes(x = 1 - specificity, y = sensitivity,color=.level)) +\n  geom_path() +\n  scale_color_manual(values = c(\"orange\",\"green\",\"red\")) +\n  geom_abline(lty = 3) +\n  coord_equal() +\n  labs(\n    title = \"ROC Curve\",\n    subtitle = \"All Three Water Classifications\",\n    x = \"False Positive Rate\",\n    y = \"True Positive Rate\",\n    color = \"Classification\"\n  ) +\n  theme_bw()\n```\n\n::: {.cell-output-display}\n![](oyster_files/figure-html/plot ROC-1.png){width=672}\n:::\n:::\n\n\n\n\nWe can easily tweak this model. Looking at rainfall as separate daily factors improves the truth table slightly but masks rainfall as the most important factor. We can quickly visualize the difference using the ROC.  Splitting rainfall into three separate time windows rather than the full week improves the model slightly. \n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# select only variables for model\nwq_subset_2 <- wq_data |>\n  # make year a category, rather than numeric\n  mutate(year = as.factor(year)) |> \n  select(\n    quality,\n    site_id,\n    year,\n    time_since_high_tide,\n    precip_t0,\n    precip_48,\n    precip_earlier,\n    # precip_week,\n    water_body,\n    water_class,\n    sewershed,\n    lab\n  ) |>\n  # remove rows with missing values\n  drop_na()\n\n# or...we could aggregate the precipitation data\n# wq_subset <- wq_subset |>\n#   #sum across all precip columns\n#   mutate(precip_total = precip_t0 + precip_48 + precip_earlier) |>\n#   select(-c(precip_t0, precip_48, precip_earlier))\n\n# seeding the random number generator ensures reproducibility\nset.seed(123)\n# split data into training and testing sets\nwq_split_2 <- initial_split(wq_subset_2, prop = 0.75, strata = quality)\nwq_train_2 <- training(wq_split_2)\nwq_test_2 <- testing(wq_split_2)\n\n# choose the model\nwq_rf_2 <- rand_forest() |>\n  set_engine(\"ranger\",importance = \"impurity\") |>\n  set_mode(\"classification\")\n\n# create a recipe\nwq_recipe_2 <- recipe(quality ~ ., data = wq_train_2) |>\n  step_normalize(all_numeric_predictors())\n\n# combine into a workflow\nwq_wf_2 <- workflow() |>\n  add_model(wq_rf_2) |>\n  add_recipe(wq_recipe_2)\n\n# fit with training data\nwq_fit_2<- wq_wf_2 |>\n  fit(data = wq_train_2)\n\nwq_pred_2 <- wq_fit_2 |>\n  augment(new_data = wq_test_2)\n\n# plot a ROC curve\n\nrc1 <- wq_pred |>\n  roc_curve(truth = quality, .pred_Safe,.pred_Caution,.pred_Unsafe) |> \n  filter(.level == \"Unsafe\")|> \n  mutate(.level = \"Single Full Week Precip Factor\")\n\nrc2 <- wq_pred_2 |>\n  roc_curve(truth = quality, .pred_Safe,.pred_Caution,.pred_Unsafe) |> \n  filter(.level == \"Unsafe\") |> \n  mutate(.level = \"3 Precip Factors\")\n\nbind_rows(rc1, rc2) |>\n  ggplot(aes(\n    x = 1 - specificity,\n    y = sensitivity,\n    color = .level\n  )) +\n  geom_path() +\n  geom_abline(lty = 3) +\n  labs(\n    title = \"Effect of Feature Choices on Accuracy\",\n    subtitle = 'ROC Curve for \"SAFE\" class only',\n    x = \"False Positive Rate\",\n    y = \"True Positive Rate\",\n    color = \"Features Choice\"\n  ) +\n  coord_equal() +\n  theme_bw()\n```\n\n::: {.cell-output-display}\n![](oyster_files/figure-html/alt feature set-1.png){width=672}\n:::\n:::\n\n\n\n\n\nThere are other metrics we could use but you get the idea. We could also tune the model to see if we could improve the performance, but in this case I found it did not help much so I don't include it. Refer to the tidymodels site for tuning tips and more performance statistics.\n\nWe could also look for other variables not present in the BOP data set that might be useful. I've looked at imputing tidal current and including daily temperature. Neither made much of a difference. You can see [these experiments on Github](https://github.com/apsteinmetz/oyster). They include techniques for downloading tide and weather data from the NOAA and matching NOAA stations to water sampling stations.\n\n## Conclusion\n\nIn this project we've seen how easy it is to build a powerful machine learning model using the `tidymodels` tools. As citizen scientists we were able to gather and use publicly available data to gain insight into the factors influencing water quality in New York Harbor. We've also learned about how important oysters were to the city in days past and can dream about a day (alas, not likely in our lifetimes) when oysters \"as big as dinner plates\" are once again living in the harbor.\n\nDon't forget to check out [The Billion Oyster Project](https://www.billionoysterproject.org/). They have lot's of ways to contribute!\n",
    "supporting": [
      "oyster_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../../site_libs/htmltools-fill-0.5.8.1/fill.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/htmlwidgets-1.6.4/htmlwidgets.js\"></script>\n<script src=\"../../site_libs/jquery-3.6.0/jquery-3.6.0.min.js\"></script>\n<link href=\"../../site_libs/leaflet-1.3.1/leaflet.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/leaflet-1.3.1/leaflet.js\"></script>\n<link href=\"../../site_libs/leafletfix-1.0.0/leafletfix.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/proj4-2.6.2/proj4.min.js\"></script>\n<script src=\"../../site_libs/Proj4Leaflet-1.0.1/proj4leaflet.js\"></script>\n<link href=\"../../site_libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/leaflet-binding-2.2.2/leaflet.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}